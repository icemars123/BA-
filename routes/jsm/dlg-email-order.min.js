function doDlgEmailOrder(a,l){var e="",i="",t=null;function r(e,i){var t=i.pdata.type==itype_order_order?i.data.config.emailordertemplate:i.pdata.type==itype_order_invoice?i.data.config.emailinvoicetemplate:i.pdata.type==itype_order_quote?i.data.config.emailquotetemplate:"";_.isBlank(t)?doShowError("No email template found..."):(t=(t=(t=(t=t.replace("$(orderorderno)",a.orderno)).replace("$(orderinvoiceno)",a.invoiceno)).replace("$(custname)",a.name)).replace("$(username)",uname),nicEditors.findEditor("fldOrderEmailMessage").setContent(t))}function o(e,i){doShowSuccess("Email successfully sent"),doServerMessage("emailhistory",{type:"refresh"}),$("#dlgOrderEmail").dialog("close")}function n(e,i){var t="";i.data.rs.forEach(function(e){_.isBlank(t)||(t+=", "),_.isNull(e.contact1)||_.isBlank(e.contact1)||_.isNull(e.email1)||_.isBlank(e.email1)||(t+='"'+e.contact1+'" <'+e.email1+">"),_.isNull(e.contact2)||_.isBlank(e.contact2)||_.isNull(e.email2)||_.isBlank(e.email2)||(_.isBlank(t)||(t+=", "),t+='"'+e.contact2+'" <'+e.email2+">")}),$("#fldOrderEmailRecipients").textbox("setValue",t)}switch($("#divEvents").on("loademailtemplates",r),$("#divEvents").on("emailorder",o),$("#divEvents").on("emailinvoice",o),$("#divEvents").on("listemails",n),l){case itype_order_order:e="Email Order",i="Order: "+a.orderno;break;case itype_order_invoice:e="Email Invoice",i="Invoice: "+a.invoiceno}$("#dlgOrderEmail").dialog({title:e,onClose:function(){a={},l=null,$("#fldOrderEmailRecipients").textbox("clear"),$("#fldOrderEmailMessage").html(""),$("#divEvents").off("loademailtemplates",r),$("#divEvents").off("emailorder",o),$("#divEvents").off("emailinvoice",o),$("#divEvents").off("listemails",n)},onOpen:function(){$("#fldOrderEmailRecipients").textbox({icons:[{iconCls:"icon-add",iconAlign:"right",handler:function(e){}}]}),$("#fldOrderEmailSubject").textbox("setValue",i),_.isNull(t)&&(t=new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"}).panelInstance("fldOrderEmailMessage")),doServerMessage("loademailtemplates",{type:l}),_.isUndefined(a.clientid)||doServerDataMessage("listemails",{clientid:a.clientid},{type:"refresh"}),$("#fldOrderEmailMessage").html("")},buttons:[{text:"Email",handler:function(){var e=$("#fldOrderEmailRecipients").textbox("getValue"),i=$("#fldOrderEmailSubject").textbox("getValue"),t=nicEditors.findEditor("fldOrderEmailMessage").getContent();switch(l){case itype_order_order:doServerDataMessage("emailorder",{orderid:a.id,recipients:e,subject:i,message:t},{type:"refresh"});break;case itype_order_invoice:doServerDataMessage("emailinvoice",{orderid:a.id,recipients:e,subject:i,message:t},{type:"refresh"})}}},{text:"Close",handler:function(){$("#dlgOrderEmail").dialog("close")}}]}).dialog("center").dialog("open")}