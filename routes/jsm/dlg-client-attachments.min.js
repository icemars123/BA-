var selectedClientIdAttachmentId=null;function doDlgClientAttachments(i){var n=null,d=[],t=[{text:"Clear",iconCls:"icon-clear",handler:function(){$("#divClientAttachmentsG").datagrid("clearSelections")}},{text:"Edit",iconCls:"icon-edit",handler:a},{text:"Cancel",iconCls:"icon-cancel",handler:e},{text:"Save",iconCls:"icon-save",handler:function(){doGridEndEditGetRow("divClientAttachmentsG",n,function(t){primus.emit("saveclientattachment",{fguid:fguid,uuid:uuid,session:session,clientattachmentid:t.id,description:t.description,pdata:{type:"refresh"}})}),n=null}},{text:"Remove",iconCls:"icon-remove",handler:o},{text:"Download",iconCls:"icon-download",handler:c}];function a(){doGridStartEdit("divClientAttachmentsG",n,function(t,e){n=e,doGridGetEditor("divClientAttachmentsG",n,"description",function(t){})})}function e(){n=doGridCancelEdit("divClientAttachmentsG",n)}function o(){doGridGetSelectedRowData("divClientAttachmentsG",function(e){doPromptOkCancel("Remove attachment "+e.description+"?",function(t){t&&doServerDataMessage("expireclientattachment",{clientattachmentid:e.id},{type:"refresh"})})})||doShowError("Please select an attachment to remove")}function c(){doGridGetSelectedRowData("divClientAttachmentsG",function(t){doThrowClientAttachment(t.id)})}function l(t,e){i.id==e.data.clientid&&doServerDataMessage("listclientattachments",{clientid:i.id},{type:"refresh"})}function s(t,e){d=[],e.data.rs.forEach(function(t){d.push({id:doNiceId(t.id),name:doNiceString(t.name),description:doNiceString(t.description),mimetype:'<a href="javascript:void(0);" onClick="doThrowClientAttachment('+t.id+');">'+mapMimeTypeToImage(t.mimetype)+"</a>",size:doNiceString(t.size),image:'<image src="'+t.image+'" width="35px">',date:doNiceDateModifiedOrCreated(t.datemodified,t.datecreated),by:doNiceModifiedBy(t.datemodified,t.usermodified,t.usercreated)})}),$("#divClientAttachmentsG").datagrid("loadData",d)}function r(t,e){"edit"==e?a():"remove"==e?o():"download"==e&&c()}$("#divEvents").on("saveclientattachment",l),$("#divEvents").on("expireclientattachment",l),$("#divEvents").on("clientattachmentcreated",l),$("#divEvents").on("clientattachmentsaved",l),$("#divEvents").on("clientattachmentexpired",l),$("#divEvents").on("listclientattachments",s),$("#divEvents").on("clientattachmentspopup",r),$("#dlgClientAttachments").dialog({title:"Attachments for "+i.name,onClose:function(){$("#divEvents").off("saveclientattachment",l),$("#divEvents").off("expireclientattachment",l),$("#divEvents").off("clientattachmentcreated",l),$("#divEvents").off("clientattachmentsaved",l),$("#divEvents").off("clientattachmentexpired",l),$("#divEvents").off("listclientattachments",s),$("#divEvents").off("clientattachmentspopup",r)},onOpen:function(){selectedClientIdAttachmentId=i.id,$("#divClientAttachmentsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:t,loader:function(t,e,i){e({total:d.length,rows:d})},columns:[[{title:"Name",field:"name",width:200,align:"left",resizable:!0},{title:"Description",field:"description",width:300,align:"left",resizable:!0,editor:"text"},{title:"Type",field:"mimetype",width:100,align:"center",resizable:!0},{title:"Size",field:"size",width:150,align:"right",resizable:!0,formatter:function(t,e){return filesize(t,{base:10})}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(t,e,i){doGridContextMenu("divClientAttachmentsG","divClientAttachmentsMenuPopup",t,e,i)},onDblClickCell:function(t,e,i){doGridStartEdit("divClientAttachmentsG",n,function(t,e){n=e,doGridGetEditor("divClientAttachmentsG",n,"description",function(t){})})}}),doServerDataMessage("listclientattachments",{clientid:i.id},{type:"refresh"})},buttons:[{text:"Close",handler:function(){e(),$("#dlgClientAttachments").dialog("close")}}]}).dialog("center").dialog("open")}