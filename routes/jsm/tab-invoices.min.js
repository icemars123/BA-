var invoicesTabWidgetsLoaded=!1;function doInvoicesTabWidgets(){var e=[{text:"Clear",iconCls:"icon-clear",handler:function(){$("#divInvoicesG").datagrid("clearSelections")}},{text:"Remove",iconCls:"icon-remove",handler:function(){}},{text:"Print",iconCls:"icon-print",handler:function(){doPromptYesNoCancel("Print all listed invoices (Yes) or selected only (No)?",function(e){!0===e?console.log("Print all listed invoices"):!1===e&&doGridGetSelectedRowData("divInvoicesG",function(e){doServerDataMessage("printinvoices",{orders:[e.id]},{type:"refresh"})})})}},{text:"Email",iconCls:"icon-email",handler:function(){doGridGetSelectedRowData("divInvoicesG",function(e){doDlgEmailOrder(e,itype_order_invoice)})||doShowError("Please select an invoice to email")}},{text:"Search",iconCls:"icon-search",handler:function(){doDlgInvoiceSearch()}},{text:"Pay",iconCls:"icon-payment",handler:function(){doGridGetSelectedRowData("divInvoicesG",function(e){doDlgPayInvoices(e.clientid)})||doDlgPayInvoices()}}];function i(){doServerMessage("listinvoices",{type:"refresh"})}invoicesTabWidgetsLoaded||(invoicesTabWidgetsLoaded=!0,$("#divEvents").on("listinvoices",function(e,i){var n=_.toBigNum(0),o=[];i.data.rs.forEach(function(e){var i=0;if(!_.isUndefined(e.dayscredit)&&!_.isNull(e.dayscredit)&&0<e.dayscredit){var t=moment(e.date).add(e.dayscredit,"days");i=moment(t).diff(moment(),"days")}else i=moment(e.date).diff(moment(),"days");n=n.plus(e.totalprice),o.push({id:doNiceId(e.id),clientid:doNiceId(e.clientid),clientname:doNiceString(e.clientname),name:doNiceString(e.name),pono:doNiceString(e.pono),invoiceno:doNiceString(e.invoiceno),orderno:doNiceString(e.orderno),copyno:e.copyno,totalprice:_.sanitiseAsNumeric(e.totalprice,4),dayscredit:e.dayscredit,orderlimit:_.formatnumber(e.orderlimit,4),creditlimit:_.formatnumber(e.creditlimit,4),date:doNiceDate(e.invoicedate),by:_.titleize(e.userinvoiced),duein:i,paid:_.formatnumber(e.paid,2),balance:_.formatnumber(e.balance,2)})}),$("#divInvoicesG").datagrid("loadData",o),$("#divInvoicesG").datagrid("reloadFooter",[{name:'<span class="totals_footer">'+o.length+" invoice(s)</span>",totalprice:'<span class="totals_footer">'+_.niceformatnumber(n)+"</span>"}]),_.isUndefined(i.pdata.orderid)||_.isNull(i.pdata.invoiceid)||$("#divInvoicesG").datagrid("selectRecord",i.pdata.invoiceid)}),$("#divEvents").on("payinvoices",i),$("#divEvents").on("invoicespaid",i),$("#divEvents").on("invoicecreated",i),$("#divEvents").on("invoicespaid",i),$("#divInvoicesG").datagrid({idField:"id",fitColumns:!1,singleSelect:!1,rownumbers:!0,striped:!0,toolbar:e,showFooter:!0,sortName:"invoiceno",sortOrder:"asc",remoteSort:!1,multiSort:!0,frozenColumns:[[{title:"Invoice #",field:"invoiceno",width:150,align:"left",resizable:!0}]],columns:[[{title:"Name",field:"name",width:300,align:"left",resizable:!0,sortable:!0},{title:"P.O.#",field:"pono",width:150,align:"left",resizable:!0,sortable:!0},{title:"Order #",field:"orderno",width:150,align:"left",resizable:!0,sortable:!0},{title:"Client",field:"clientid",width:200,align:"left",resizable:!0,sortable:!0,formatter:function(e,i){return doGetNameFromTreeArray(cache_clients,e)}},{title:"Copy #",field:"copyno",width:100,align:"right",resizable:!0},{title:"Amount",field:"totalprice",width:150,align:"right",resizable:!0,formatter:function(e,i,t){return _.isUndefined(i.id)?_.niceformatnumber(e):e}},{title:"Invoiced",field:"date",width:150,align:"right",resizable:!0,formatter:function(e,i,t){return _.nicedatetodisplay(e)},sortable:!0},{title:"Balance",field:"balance",width:150,align:"right",resizable:!0,sortable:!0,styler:function(e,i,t){return"color: "+colour_indianred}},{title:"Due In",field:"duein",width:150,align:"right",resizable:!0,styler:function(e,i,t){return function(e,i,t){if(i.duein<0)return"color: red"}(0,i)},formatter:function(e,i,t){return function(e,i,t){if(!_.isUndefined(e))return e+" days"}(e)},sortable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0,sortable:!0}]],onRowContextMenu:function(e,i,t){doGridContextMenu("divInvoicesG","divInvoicesMenuPopup",e,i,t)}}),doServerMessage("listinvoices",{type:"refresh"}))}