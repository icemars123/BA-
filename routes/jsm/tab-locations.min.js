var locationsTabWidgetsLoaded=!1;function doLocationsTabSearch(e,t){doSearchCodeNameInTree("divLocationsTG",e)}function doLocationsTabWidgets(){function e(e,t){doServerMessage("listlocations",{type:"refresh",locationid:t.data.locationid})}locationsTabWidgetsLoaded||(locationsTabWidgetsLoaded=!0,$("#divEvents").on("listlocations",function(e,t){$("#divLocationsTG").treegrid("reload"),doExpandTreeToId("divLocationsTG",t.pdata.locationid)}),$("#divEvents").on("checklocationcode",function(e,t){var i=t.data.rs;0<i.length&&doShowError("Location code ["+i[0].code+"] is already assigned to ["+i[0].name+"]")}),$("#divEvents").on("newlocation",e),$("#divEvents").on("savelocation",e),$("#divEvents").on("expirelocation",e),$("#divEvents").on("changelocationparent",e),$("#divEvents").on("locationspopup",function(e,t){"newroot"==t?doDlgLocationNew(null,null):"new"==t?doTreeGridGetSelectedRowData("divLocationsTG",function(e){doDlgLocationNew(e.id,null)}):"clear"==t?$("#divLocationsTG").treegrid("unselectAll"):"remove"==t?doTreeGridGetSelectedRowData("divLocationsTG",function(t){doPromptYesNoCancel("Remove "+t.name+" and ALL sublocations (Yes) or ONLY this location (No)?",function(e){_.isNull(e)||primus.emit("expirelocation",{fguid:fguid,uuid:uuid,session:session,locationid:t.id,cascade:e,pdata:{type:"dolocationsremove"}})})})||noty({text:"Please select a location to remove",type:"error",timeout:4e3}):"removeparent"==t?doTreeGridGetSelectedRowData("divLocationsTG",function(e){primus.emit("changelocationparent",{fguid:fguid,uuid:uuid,session:session,locationid:e.id,parentid:null,pdata:{type:"refresh"}})}):"locate"==t&&doTreeGridGetSelectedRowData("divLocationsTG",function(e){var t=doNiceTitleizeString(e.name),i="<strong>"+t+"</strong><br/>"+doNiceTitleizeString(e.address1)+"<br/>"+doNiceTitleizeString(e.city)+"<br/>"+doNiceTitleizeString(e.statename)+"<br/>"+doNiceTitleizeString(e.country);_.isBlank(e.gpslat)||_.isBlank(e.gpslon)?GeocoderJS.createGeocoder("openstreetmap").geocode(e.address1+" "+e.city+" "+e.statename+" "+e.country,function(e){0<e.length&&doShowMap(e[0].latitude,e[0].longitude,t,i)}):doShowMap(e.gpslat,e.gpslon,t,i)})}),$("#divLocationsTG").treegrid({idField:"id",treeField:"name",lines:!0,collapsible:!0,fitColumns:!1,autoRowHeight:!1,rownumbers:!0,striped:!0,toolbar:"#tbLocations",showFooter:!0,sortName:"name",sortOrder:"asc",remoteSort:!1,multiSort:!0,loader:function(e,t,i){t({total:cache_locations.length,rows:cache_locations}),$(this).treegrid("reloadFooter",[{name:'<span class="totals_footer">'+doGetCountTreeArray(cache_locations)+" Locations</span>"}])},frozenColumns:[[{title:"Name",rowspan:2,field:"name",width:300,align:"left",resizable:!0,editor:"text",sortable:!0}],[]],columns:[[{title:"Code",rowspan:2,field:"code",width:200,align:"left",resizable:!0,sortable:!0},{title:"Address",colspan:6},{title:"GPS",colspan:2},{title:"Custom Attributes",colspan:5},{title:"Modified",rowspan:2,field:"date",width:150,align:"right",resizable:!0,sortable:!0},{title:"By",rowspan:2,field:"by",width:200,align:"left",resizable:!0,sortable:!0}],[{title:"Address1",field:"address1",width:200,align:"left",resizable:!0},{title:"Address2",field:"address2",width:200,align:"left",resizable:!0},{title:"City",field:"city",width:200,align:"left",resizable:!0},{title:"State",field:"statename",width:200,align:"left",resizable:!0},{title:"Postcode",field:"postcode",width:80,align:"left",resizable:!0},{title:"Country",field:"country",width:200,align:"left",resizable:!0},{title:"Latitude",field:"gpslat",width:150,align:"right",resizable:!0},{title:"Longitude",field:"gpslon",width:150,align:"right",resizable:!0},{title:"1",field:"attrib1",width:150,align:"left",resizable:!0},{title:"2",field:"attrib2",width:150,align:"left",resizable:!0},{title:"3",field:"attrib3",width:150,align:"left",resizable:!0},{title:"4",field:"attrib4",width:150,align:"left",resizable:!0},{title:"5",field:"attrib5",width:150,align:"left",resizable:!0}]],onContextMenu:function(e,t){doTreeGridContextMenu("divLocationsTG","divLocationsMenuPopup",e,t)},onLoadSuccess:function(e){$(this).treegrid("enableDnd")},onBeforeDrag:function(e){return!0},onDragOver:function(e,t){return!_.isUN(e)},onBeforeDrop:function(e,t,i){return!0},onDrop:function(e,t,i){var o=_.isUN(e)?null:e.id;doServerDataMessage("changelocationparent",{locationid:t.id,parentid:o},{type:"refresh"})},onDblClickCell:function(e,t){doDlgLocationNew(t.parentid,t.id)}}))}