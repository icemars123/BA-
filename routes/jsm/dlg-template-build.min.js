function doDlgTemplateBuild(d){function e(e,t){var d=[];t.data.rs.forEach(function(e){d.push({id:doNiceId(e.productid),code:doNiceString(e.productcode),name:doNiceString(e.productname),qty:doNiceString(e.qty),pertemplateqty:e.pertemplateqty})}),$("#divBuildProductsG").datagrid("loadData",d)}function t(e,t){doServerDataMessage("listproductsforbuild",{buildtemplateid:d.id},{type:"refresh"})}$("#divEvents").on("listproductsforbuild",e),$("#divEvents").on("expirebuild",t),$("#divEvents").on("buildexpired",t),$("#dlgBuildTemplate").dialog({title:"Building Template "+d.name,onClose:function(){$("#divBuildProductsG").datagrid("loadData",[]),$("#divEvents").off("listproductsforbuild",e),$("#divEvents").off("expirebuild",t),$("#divEvents").off("buildexpired",t)},onOpen:function(){$("#fldBuildQty").numberbox("setValue",d.qty),$("#cbBuildProducts").combobox({valueField:"id",textField:"code",groupField:"productcategoryname",data:cache_products}),$("#divBuildProductsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,columns:[[{title:"Code",field:"code",width:200,align:"left",resizable:!0},{title:"Name",field:"name",width:200,align:"left",resizable:!0},{title:"Qty",field:"qty",width:100,align:"right",resizable:!0,formatter:function(e,t,d){return _.niceformatnumber(e)}},{title:"Whole/Tmpl",field:"pertemplateqty",width:100,align:"center",resizable:!0,formatter:function(e,t){return mapBoolToImage(e)}}]]}),doServerDataMessage("listproductsforbuild",{buildtemplateid:d.id},{type:"refresh"})},buttons:[{text:"Build",handler:function(){var e=$("#cbBuildProducts").combobox("getValue"),t=$("#fldBuildQty").numberbox("getValue");_.isBlank(e)?doMandatoryTextbox("Please select a target product to build","cbBuildProducts"):_.isBlank(t)||t<=0?doMandatoryTextbox("Quantity must be greater than 0","fldBuildQty"):data.length<=0?doShowError("No component products"):(doServerDataMessage("buildinventory",{buildtemplateid:d.id,productid:e,qty:t},{type:"refresh"}),$("#dlgBuildTemplate").dialog("close"))}},{text:"Close",handler:function(){$("#dlgBuildTemplate").dialog("close")}}]}).dialog("center").dialog("open")}