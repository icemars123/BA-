function doDlgPOrderNew(h){var S=_.isUndefined(h)||_.isNull(h),r=null,d={},t=[],o=[];function i(){$("#cbNewPOrderInvoiceAddress").combotree("clear"),$("#cbNewPOrderShiptoAddress").combotree("clear"),$("#divPOrderNewProductsG").datagrid("loadData",[]),S?($("#fldNewPOrderInvoiceno").textbox("clear"),$("#fldNewPOrderFefno").textbox("clear"),$("#cbNewPOrderSuppliers").combotree("clear"),$("#dtNewPOrderInvoiceDueDate").datebox("clear"),$("#fldNewPOrderOrderName").textbox("clear"),$("#fldNewPOrderAddress1").textbox("clear"),$("#fldNewPOrderAddress2").textbox("clear"),$("#fldNewPOrderAddress3").textbox("clear"),$("#fldNewPOrderAddress4").textbox("clear"),$("#fldNewPOrderCity").textbox("clear"),$("#fldNewPOrderPostcode").textbox("clear"),$("#cbNewPOrderState").combobox("clear"),$("#fldNewPOrderShiptoName").textbox("clear"),$("#fldNewPOrderShiptoAddress1").textbox("clear"),$("#fldNewPOrderShiptoAddress2").textbox("clear"),$("#fldNewPOrderShiptoAddress3").textbox("clear"),$("#fldNewPOrderShiptoAddress4").textbox("clear"),$("#fldNewPOrderShiptoCity").textbox("clear"),$("#fldNewPOrderShiptoPostcode").textbox("clear"),$("#cbNewPOrderShiptoState").combobox("clear"),$("#btnPOrderNewAdd").linkbutton("disable"),$("#cbNewPOrderSuppliers").combotree("enable"),$("#cbNewPOrderCountry").combobox("setValue",defaultCountry),$("#cbNewPOrderShiptoCountry").combobox("setValue",defaultCountry)):_.isEmpty(d)||($("#fldNewPOrderInvoiceno").textbox("setValue",d.invoiceno),$("#fldNewPOrderFefno").textbox("setValue",d.refno),$("#cbNewPOrderSuppliers").combotree("setValue",d.clientid),$("#dtNewPOrderInvoiceDueDate").datebox("setValue",d.dateinvoicedue),$("#fldNewPOrderOrderName").textbox("setValue",d.name),$("#fldNewPOrderAddress1").textbox("setValue",d.invoicetoaddress1),$("#fldNewPOrderAddress2").textbox("setValue",d.invoicetoaddress2),$("#fldNewPOrderAddress3").textbox("setValue",d.invoicetoaddress3),$("#fldNewPOrderAddress4").textbox("setValue",d.invoicetoaddress4),$("#fldNewPOrderCity").textbox("setValue",d.invoicetocity),$("#fldNewPOrderPostcode").textbox("setValue",d.invoicetopostcode),$("#cbNewPOrderCountry").combobox("setValue",d.invoicetocountry),$("#cbNewPOrderState").combobox("setValue",d.invoicetostate),$("#fldNewPOrderShiptoName").textbox("setValue",d.shiptoname),$("#fldNewPOrderShiptoAddress1").textbox("setValue",d.shiptoaddress1),$("#fldNewPOrderShiptoAddress2").textbox("setValue",d.shiptoaddress2),$("#fldNewPOrderShiptoAddress3").textbox("setValue",d.shiptoaddress3),$("#fldNewPOrderShiptoAddress4").textbox("setValue",d.shiptoaddress4),$("#fldNewPOrderShiptoCity").textbox("setValue",d.shiptocity),$("#fldNewPOrderShiptoPostcode").textbox("setValue",d.shiptopostcode),$("#cbNewPOrderShiptoCountry").combobox("setValue",d.shiptocountry),$("#cbNewPOrderShiptoState").combobox("setValue",d.shiptostate),$("#btnPOrderNewAdd").linkbutton("enable"),$("#btnPOrderNewComplete").linkbutton(_.isBlank(d.datecompleted)?"enable":"disable"),$("#cbNewPOrderSuppliers").combotree("disable"),$("#dlgPOrderNew").dialog("setTitle","Modify "+d.porderno),doServerDataMessage("listporderdetails",{porderid:h},{type:"refresh"})),doTextboxFocus("fldNewPOrderOrderName")}function a(){doGridCalcTotals("divPOrderNewProductsG","price","qty")}function e(e,t){$("#dlgPOrderNew").dialog("close")}function s(e,o){doGridGetEditor("divPOrderNewProductsG",o.pdata.rowindex,"price",function(r){doGridGetEditor("divPOrderNewProductsG",o.pdata.rowindex,"qty",function(e){var t=$(e.target).numberbox("getValue");if(!_.isNull(o.data.price.minqty)){var d=_.toBigNum(o.data.price.minqty);(_.isBlank(t)||d.greaterThan(t))&&$(e.target).numberbox("setValue",o.data.price.minqty)}$(r.target).numberbox("setValue",o.data.price.costprice)})})}function l(e,t){"refresh"==t.pdata.type?($("#fldNewPOrderOrderName").textbox("setValue",t.data.supplier.name),$("#fldNewPOrderAddress1").textbox("setValue",t.data.supplier.address1),$("#fldNewPPOrderAddress2").textbox("setValue",t.data.supplier.address2),$("#fldNewPOrderAddress3").textbox("setValue",t.data.supplier.address3),$("#fldNewPOrderAddress4").textbox("setValue",t.data.supplier.address4),$("#fldNewPOrderCity").textbox("setValue",t.data.supplier.city),$("#fldNewPOrderPostcode").textbox("setValue",t.data.supplier.postcode),$("#cbNewPOrderCountry").combobox("setValue",t.data.supplier.country),$("#cbNewPOrderState").combobox("setValue",t.data.supplier.state),$("#fldNewPOrderShiptoName").textbox("setValue","The Paper Cup Company"),$("#fldNewPOrderShiptoAddress1").textbox("setValue","Factory 8"),$("#fldNewPOrderShiptoAddress2").textbox("setValue","8 Adina Court"),$("#fldNewPOrderShiptoAddress3").textbox("setValue",""),$("#fldNewPOrderShiptoAddress4").textbox("setValue",""),$("#fldNewPOrderShiptoCity").textbox("setValue","Tullamarine"),$("#fldNewPOrderShiptoPostcode").textbox("setValue","3043"),$("#cbNewPOrderShiptoCountry").combobox("setValue","australia"),$("#cbNewPOrderShiptoState").combobox("setValue","victoria")):($("#fldNewPOrderOrderName").textbox("setValue",t.data.supplier.name),$("#fldNewPOrderAddress1").textbox("setValue",t.data.supplier.address1),$("#fldNewPPOrderAddress2").textbox("setValue",t.data.supplier.address2),$("#fldNewPOrderAddress3").textbox("setValue",t.data.supplier.address3),$("#fldNewPOrderAddress4").textbox("setValue",t.data.supplier.address4),$("#fldNewPOrderCity").textbox("setValue",t.data.supplier.city),$("#fldNewPOrderPostcode").textbox("setValue",t.data.supplier.postcode),$("#cbNewPOrderCountry").combobox("setValue",t.data.supplier.country),$("#cbNewPOrderState").combobox("setValue",t.data.supplier.state))}function c(e,t){$("#fldNewPOrderShiptoName").textbox("setValue",t.data.client.shiptoname),$("#fldNewPOrderShiptoAddress1").textbox("setValue",t.data.client.shipaddress1),$("#fldNewPOrderShiptoAddress2").textbox("setValue",t.data.client.shipaddress2),$("#fldNewPOrderShiptoAddress3").textbox("setValue",t.data.client.shipaddress3),$("#fldNewPOrderShiptoAddress4").textbox("setValue",t.data.client.shipaddress4),$("#fldNewPOrderShiptoCity").textbox("setValue",t.data.client.shipcity),$("#fldNewPOrderShiptoPostcode").textbox("setValue",t.data.client.shippostcode),$("#cbNewPOrderShiptoCountry").combobox("setValue",t.data.client.shipcountry),$("#cbNewPOrderShiptoState").combobox("setValue",t.data.client.shipstate)}function n(e,t){d=t.data.porder,i()}function u(e,t){$("#divPOrderNewProductsG").datagrid("loadData",t.data.rs)}function p(e,t){var d;"new"==t?(d=doGetComboTreeSelectedId("cbNewPOrderSuppliers"),doDlgProductSelect(d,!0,!0,function(e,t,d,r){$("#divPOrderNewProductsG").datagrid("appendRow",{id:e,productid:e,qty:d,price:r}),$("#btnPOrderNewAdd").linkbutton("enable"),a()})):"clear"==t?$("#divPOrderNewProductsG").datagrid("clearSelections"):"edit"==t?doGridGetSelectedRowData("divPOrderNewProductsG",function(e){_.isBlank(e.datecompleted)?doGridStartEdit("divPOrderNewProductsG",r,function(e,t){r=t,doGridGetEditor("divPOrderNewProductsG",r,"price",function(e){})}):doShowWarning("Unable to edit completed P.O.")}):"cancel"==t?r=doGridCancelEdit("divPOrderNewProductsG",r):"save"==t?(doGridEndEditGetRow("divPOrderNewProductsG",r,function(e){a()}),r=null):"remove"==t&&(doGridGetSelectedRowData("divPOrderNewProductsG",function(t){doPromptOkCancel("Remove "+doGetCodeFromIdInObjArray(cache_products,t.productid)+"?",function(e){e&&(doGridRemoveRow("divPOrderNewProductsG",t),a())})})||doShowError("Please select a product to remove"))}$("#divEvents").on("newporder",e),$("#divEvents").on("saveporder",e),$("#divEvents").on("completeporder",e),$("#divEvents").on("getprice",s),$("#divEvents").on("loadsupplier",l),$("#divEvents").on("loadclient",c),$("#divEvents").on("pordernewpopup",p),$("#divEvents").on("loadporder",n),$("#divEvents").on("listporderdetails",u),$("#dlgPOrderNew").dialog({onClose:function(){$("#divEvents").off("newporder",e),$("#divEvents").off("saveporder",e),$("#divEvents").off("completeporder",e),$("#divEvents").off("getprice",s),$("#divEvents").off("loadsupplier",l),$("#divEvents").off("loadclient",c),$("#divEvents").off("pordernewpopup",p),$("#divEvents").off("loadporder",n),$("#divEvents").off("listporderdetails",u)},onOpen:function(){$("#dtNewPOrderInvoiceDueDate").datebox(),$("#cbNewPOrderSuppliers").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_suppliers,limitToList:!0,onSelect:function(e){$("#fldNewPOrderOrderName").textbox("setValue",e.name),doServerDataMessage("loadsupplier",{supplierid:e.id},{type:"refresh"})}}),$("#cbNewPOrderInvoiceAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_suppliers,limitToList:!0,onSelect:function(e){doServerDataMessage("loadsupplier",{supplierid:e.id},{type:"invoiceto"})}}),$("#cbNewPOrderShiptoAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("loadclient",{clientid:e.id},{type:"shipto"})}}),$("#cbNewPOrderCountry").combobox({valueField:"country",textField:"country",data:cache_countries,limitToList:!0,onSelect:function(e){t=doGetStatesFromCountry(e.country),$("#cbNewPOrderState").combobox("loadData",t)}}),$("#cbNewPOrderState").combobox({valueField:"state",textField:"state",data:o,limitToList:!0}),$("#cbNewPOrderShiptoCountry").combobox({valueField:"country",textField:"country",data:cache_countries,limitToList:!0,onSelect:function(e){o=doGetStatesFromCountry(e.country),$("#cbNewPOrderShiptoState").combobox("loadData",o)}}),$("#cbNewPOrderShiptoState").combobox({valueField:"state",textField:"state",data:o,limitToList:!0}),$("#divPOrderNewProductsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbPOrderNew",showFooter:!0,columns:[[{title:"Product",field:"productid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",groupField:"productcategoryname",data:cache_products,onSelect:function(e){var o;o=e,doGridGetSelectedRowData("divPOrderNewProductsG",function(e,d){var r=doGetComboTreeSelectedId("cbNewPOrderSuppliers");doGridGetEditor("divPOrderNewProductsG",d,"productid",function(e){var t=$(e.target).numberbox("getValue");doServerDataMessage("getprice",{clientid:r,productid:o.id,qty:t},{type:"refresh",rowindex:d})})})}}},formatter:function(e,t){return doGetCodeFromIdInObjArray(cache_products,e)}},{title:"Price",field:"price",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4}},formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Qty",field:"qty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4,onChange:function(e,t){var o;_.isNull(t)||e==t||(o=e,doGridGetSelectedRowData("divPOrderNewProductsG",function(e,d){var r=doGetComboTreeSelectedId("cbNewPOrderSuppliers");doGridGetEditor("divPOrderNewProductsG",d,"productid",function(e){var t=$(e.target).combobox("getValue");doServerDataMessage("getprice",{clientid:r,productid:t,qty:o},{type:"refresh",rowindex:d})})}))}}},formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatqty(e)}}]],onRowContextMenu:function(e,t,d){doGridContextMenu("divPOrderNewProductsG","divPOrderNewMenuPopup",e,t,d)},onDblClickCell:function(e,d,t){doGridGetSelectedRowData("divPOrderNewProductsG",function(e){doGridStartEdit("divPOrderNewProductsG",r,function(e,t){r=t,-1!=["modified","by"].indexOf(d)&&(d="price"),doGridGetEditor("divPOrderNewProductsG",r,d,function(e){})})})}}),S?$("#btnPOrderNewAdd").linkbutton({text:"Add"}):$("#btnPOrderNewAdd").linkbutton({text:"Save"}),_.isNull(h)?i():doServerDataMessage("loadporder",{porderid:h},{type:"refresh"})},buttons:[{text:"Add",disabled:!0,id:"btnPOrderNewAdd",handler:function(){var e=$("#fldNewPOrderInvoiceno").textbox("getValue"),t=$("#fldNewPOrderFefno").textbox("getValue"),d=$("#cbNewPOrderSuppliers").combotree("getValue"),r=$("#fldNewPOrderOrderName").textbox("getValue"),o=$("#fldNewPOrderAddress1").textbox("getValue"),i=$("#fldNewPOrderAddress2").textbox("getValue"),a=$("#fldNewPOrderAddress3").textbox("getValue"),s=$("#fldNewPOrderAddress4").textbox("getValue"),l=$("#fldNewPOrderCity").textbox("getValue"),c=$("#fldNewPOrderPostcode").textbox("getValue"),n=$("#cbNewPOrderCountry").combobox("getValue"),u=$("#cbNewPOrderState").combobox("getValue"),p=$("#fldNewPOrderShiptoName").textbox("getValue"),b=$("#fldNewPOrderShiptoAddress1").textbox("getValue"),x=$("#fldNewPOrderShiptoAddress2").textbox("getValue"),P=$("#fldNewPOrderShiptoAddress3").textbox("getValue"),w=$("#fldNewPOrderShiptoAddress4").textbox("getValue"),N=$("#fldNewPOrderShiptoCity").textbox("getValue"),f=$("#fldNewPOrderShiptoPostcode").textbox("getValue"),O=$("#cbNewPOrderShiptoCountry").combobox("getValue"),v=$("#cbNewPOrderShiptoState").combobox("getValue"),m=$("#divPOrderNewProductsG").datagrid("getData");_.isBlank(r)&&_.isBlank(d)?doMandatoryTextbox("Need at least a name or supplier","fldNewPOrderOrderName"):S?doServerDataMessage("newpordersupplier",{name:r,invoiceno:e,refno:t,supplierid:d,address1:o,address2:i,address3:a,address4:s,city:l,postcode:c,country:n,state:u,shiptoname:p,shiptoaddress1:b,shiptoaddress2:x,shiptoaddress3:P,shiptoaddress4:w,shiptocity:N,shiptopostcode:f,shiptocountry:O,shiptostate:v,products:m.rows},{type:"refresh"}):doServerDataMessage("savepordersupplier",{porderid:h,name:r,invoiceno:e,refno:t,supplierid:d,address1:o,address2:i,address3:a,address4:s,city:l,postcode:c,country:n,state:u,shiptoname:p,shiptoaddress1:b,shiptoaddress2:x,shiptoaddress3:P,shiptoaddress4:w,shiptocity:N,shiptopostcode:f,shiptocountry:O,shiptostate:v,products:m.rows},{type:"refresh"})}},{text:"Reset",handler:function(){i()}},{text:"Complete",disabled:!0,id:"btnPOrderNewComplete",handler:function(){var e;e=$("#fldNewPOrderInvoiceno").textbox("getValue"),_.isBlank(e)?doMandatoryTextbox("Please specify supplier invoice no.","fldNewPOrderInvoiceno"):doServerDataMessage("completeporder",{porderid:h},{type:"refresh"})}},{text:"Close",handler:function(){$("#dlgPOrderNew").dialog("close")}}]}).dialog("center").dialog("open")}