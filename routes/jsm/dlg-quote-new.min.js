var selectedQuoteIdAttachmentId=null;function doDlgQuoteNew(A){var P=_.isUndefined(A)||_.isNull(A),r=null,d={},t=[],o=[],i=[],a=null,n=null,s=null,l=null,c=null;function e(e,t){A==t.data.quoteid&&doServerDataMessage("listordernotes",{quoteid:A},{ordernoteid:t.data.ordernoteid,type:"refresh"})}function u(e,t){var d=[];t.data.rs.forEach(function(e){d.push({id:doNiceId(e.id),notes:doNiceString(e.notes),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewOrderNotesG").datagrid("loadData",d),_.isUndefined(t.pdata.ordernoteid)||_.isNull(t.pdata.ordernoteid)||$("#divNewOrderNotesG").datagrid("selectRecord",t.pdata.ordernoteid)}function b(e,t){A==t.data.quoteid&&doServerDataMessage("listorderattachments",{quoteid:A},{type:"refresh"})}function f(e,t){var d=[];t.data.rs.forEach(function(e){var t=_.isNull(e.image)||_.isUndefined(e.image)?"":'<image src="'+e.image+'" width="35px">';d.push({id:doNiceId(e.id),name:doNiceString(e.name),description:doNiceString(e.description),mimetype:'<a href="javascript:void(0);" onClick="doThrowOrderAttachment('+e.id+');">'+mapMimeTypeToImage(e.mimetype)+"</a>",size:doNiceString(e.size),isthumbnail:e.isthumbnail,image:t,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewOrderAttachmentsG").datagrid("loadData",d)}function p(){if($("#cbNewOrderInvoiceAddress").combotree("clear"),$("#cbNewOrderShiptoAddress").combotree("clear"),$("#divOrderNewProductsG").datagrid("loadData",[]),$("#cbNewOrderStatusesStatus").combobox("clear"),$("#fldNewOrderStatusesConnote").textbox("clear"),$("#fldNewOrderStatusesCarrier").textbox("clear"),$("#fldNewOrderStatusesComment").textbox("clear"),$("#fldNewOrderStatusesBatchno").textbox("clear"),P)$("#fldNewOrderPONo").textbox("clear"),$("#fldNewOrderOrderName").textbox("clear"),$("#cbNewOrderClients").combotree("clear"),$("#cbNewOrderVersions").combobox("clear"),$("#fldNewOrderFreight").numberbox("clear"),$("#fldNewOrderName").textbox("clear"),$("#fldNewOrderAddress1").textbox("clear"),$("#fldNewOrderAddress2").textbox("clear"),$("#fldNewOrderAddress3").textbox("clear"),$("#fldNewOrderAddress4").textbox("clear"),$("#fldNewOrderCity").textbox("clear"),$("#fldNewOrderPostcode").textbox("clear"),$("#cbNewOrderCountry").combobox("clear"),$("#cbNewOrderState").combobox("clear"),$("#fldNewOrderShiptoName").textbox("clear"),$("#fldNewOrderShiptoAddress1").textbox("clear"),$("#fldNewOrderShiptoAddress2").textbox("clear"),$("#fldNewOrderShiptoAddress3").textbox("clear"),$("#fldNewOrderShiptoAddress4").textbox("clear"),$("#fldNewOrderShiptoCity").textbox("clear"),$("#fldNewOrderShiptoPostcode").textbox("clear"),$("#cbNewOrderShiptoCountry").combobox("clear"),$("#cbNewOrderShiptoState").combobox("clear"),$("#fldNewOrderShiptoNote").textbox("clear"),$("#cbNewOrderCountry").combobox("setValue",defaultCountry),$("#cbNewOrderShiptoCountry").combobox("setValue",defaultCountry),$("#cbNewOrderTemplateQuote").combobox("clear"),$("#cbNewOrderTemplateOrder").combobox("clear"),$("#cbNewOrderTemplateInvoice").combobox("clear"),$("#dtNewOrderStartDate").datebox("clear"),$("#dtNewOrderEndDate").datebox("clear"),$("#btnOrderNewAdd").linkbutton("disable"),$("#tbOrderNewNew").linkbutton("enable"),$("#tbOrderNewClear").linkbutton("enable"),$("#tbOrderNewEdit").linkbutton("enable"),$("#tbOrderNewCancel").linkbutton("enable"),$("#tbOrderNewSave").linkbutton("enable"),$("#tbOrderNewRemove").linkbutton("enable"),$("#cbNewOrderClients").combotree("enable"),$("#fldNewOrderPONo").textbox("enable"),$("#fldNewOrderOrderName").textbox("enable");else if(!_.isEmpty(d)){$("#fldNewOrderPONo").textbox("setValue",d.pono),$("#fldNewOrderOrderName").textbox("setValue",d.name),$("#cbNewOrderClients").combotree("setValue",d.clientid),$("#fldNewOrderFreight").numberbox("setValue",d.freightprice),i=[];for(var e=1;e<=d.numversions;e++)i.push({name:e});$("#cbNewOrderVersions").combobox("loadData",i),$("#cbNewOrderVersions").combobox("setValue",d.activeversion),$("#fldNewOrderName").textbox("setValue",d.invoicetoname),$("#fldNewOrderAddress1").textbox("setValue",d.invoicetoaddress1),$("#fldNewOrderAddress2").textbox("setValue",d.invoicetoaddress2),$("#fldNewOrderAddress3").textbox("setValue",d.invoicetoaddress3),$("#fldNewOrderAddress4").textbox("setValue",d.invoicetoaddress4),$("#fldNewOrderCity").textbox("setValue",d.invoicetocity),$("#fldNewOrderPostcode").textbox("setValue",d.invoicetopostcode),$("#cbNewOrderCountry").combobox("setValue",d.invoicetocountry),$("#cbNewOrderState").combobox("setValue",d.invoicetostate),$("#fldNewOrderShiptoName").textbox("setValue",d.shiptoname),$("#fldNewOrderShiptoAddress1").textbox("setValue",d.shiptoaddress1),$("#fldNewOrderShiptoAddress2").textbox("setValue",d.shiptoaddress2),$("#fldNewOrderShiptoAddress3").textbox("setValue",d.shiptoaddress3),$("#fldNewOrderShiptoAddress4").textbox("setValue",d.shiptoaddress4),$("#fldNewOrderShiptoCity").textbox("setValue",d.shiptocity),$("#fldNewOrderShiptoPostcode").textbox("setValue",d.shiptopostcode),$("#cbNewOrderShiptoCountry").combobox("setValue",d.shiptocountry),$("#cbNewOrderShiptoState").combobox("setValue",d.shiptostate),$("#fldNewOrderShiptoNote").textbox("setValue",d.shiptonote),$("#cbNewOrderTemplateQuote").combobox("setValue",d.quotetemplateid),$("#cbNewOrderTemplateOrder").combobox("setValue",d.ordertemplateid),$("#cbNewOrderTemplateInvoice").combobox("setValue",d.invoicetemplateid),$("#dtNewOrderStartDate").datebox("setValue",d.startdate),$("#dtNewOrderEndDate").datebox("setValue",d.enddate),_.isBlank(d.invoiceno)?($("#fldNewOrderPONo").textbox("enable"),$("#fldNewOrderOrderName").textbox("enable"),$("#btnOrderNewAdd").linkbutton("enable"),$("#tbOrderNewNew").linkbutton("enable"),$("#tbOrderNewClear").linkbutton("enable"),$("#tbOrderNewEdit").linkbutton("enable"),$("#tbOrderNewCancel").linkbutton("enable"),$("#tbOrderNewSave").linkbutton("enable"),$("#tbOrderNewRemove").linkbutton("enable")):($("#fldNewOrderPONo").textbox("disable"),$("#fldNewOrderOrderName").textbox("disable"),$("#btnOrderNewAdd").linkbutton("disable"),$("#tbOrderNewNew").linkbutton("disable"),$("#tbOrderNewClear").linkbutton("disable"),$("#tbOrderNewEdit").linkbutton("disable"),$("#tbOrderNewCancel").linkbutton("disable"),$("#tbOrderNewSave").linkbutton("disable"),$("#tbOrderNewRemove").linkbutton("disable")),$("#cbNewOrderClients").combotree("disable"),$("#dlgOrderNew").dialog("setTitle","Modify "+d.orderno+", version "+d.activeversion),doServerDataMessage("listorderdetails",{quoteid:A,version:d.activeversion},{type:"refresh"})}doTextboxFocus("fldNewOrderPONo")}function w(){doGridCalcTotals("divOrderNewProductsG","price","qty","discount","expressfee")}function v(e,t){if(0<t.data.rs.length){var d=t.data.rs[0],r="P.O. ["+d.pono+"] belongs to order ["+d.orderno+"]";_.isUndefined(d.clientname)||(r+=" for client ["+d.clientname+"]"),doShowError(r)}}function N(e,t){$("#dlgOrderNew").dialog("close")}function m(e,o){doGridGetEditor("divOrderNewProductsG",o.pdata.rowindex,"price",function(r){doGridGetEditor("divOrderNewProductsG",o.pdata.rowindex,"qty",function(e){var t=$(e.target).numberbox("getValue");if(!_.isNull(o.data.price.minqty)){var d=_.toBigNum(o.data.price.minqty);(_.isBlank(t)||d.greaterThan(t))&&$(e.target).numberbox("setValue",o.data.price.minqty)}$(r.target).numberbox("setValue",o.data.price.unitprice)})})}function x(e,t){switch(t.pdata.type){case"refresh":$("#fldNewOrderOrderName").textbox("setValue",t.data.client.name),$("#btnOrderNewAdd").linkbutton("enable");case"invoiceto":$("#fldNewOrderName").textbox("setValue",t.data.client.name),$("#fldNewOrderAddress1").textbox("setValue",t.data.client.address1),$("#fldNewOrderAddress2").textbox("setValue",t.data.client.address2),$("#fldNewOrderAddress3").textbox("setValue",t.data.client.address3),$("#fldNewOrderAddress4").textbox("setValue",t.data.client.address4),$("#fldNewOrderCity").textbox("setValue",t.data.client.city),$("#fldNewOrderPostcode").textbox("setValue",t.data.client.postcode),$("#cbNewOrderCountry").combobox("setValue",t.data.client.country),$("#cbNewOrderState").combobox("setValue",t.data.client.state);default:$("#fldNewOrderShiptoName").textbox("setValue",t.data.client.name),$("#fldNewOrderShiptoAddress1").textbox("setValue",_.isBlank(t.data.client.shipaddress1)?t.data.client.address1:t.data.client.shipaddress1),$("#fldNewOrderShiptoAddress2").textbox("setValue",_.isBlank(t.data.client.shipaddress2)?t.data.client.address2:t.data.client.shipaddress2),$("#fldNewOrderShiptoAddress3").textbox("setValue",_.isBlank(t.data.client.shipaddress3)?t.data.client.address3:t.data.client.shipaddress3),$("#fldNewOrderShiptoAddress4").textbox("setValue",_.isBlank(t.data.client.shipaddress4)?t.data.client.address4:t.data.client.shipaddress4),$("#fldNewOrderShiptoCity").textbox("setValue",_.isBlank(t.data.client.shipcity)?t.data.client.city:t.data.client.shipcity),$("#fldNewOrderShiptoPostcode").textbox("setValue",_.isBlank(t.data.client.shippostcode)?t.data.client.postcode:t.data.client.shippostcode),$("#cbNewOrderShiptoCountry").textbox("setValue",_.isBlank(t.data.client.shipcountry)?t.data.client.country:t.data.client.shipcountry),$("#cbNewOrderShiptoState").textbox("setValue",_.isBlank(t.data.client.shipstate)?t.data.client.state:t.data.client.shipstate)}}function O(e,t){_.isNull(A)||doServerDataMessage("loadorder",{quoteid:A},{type:"refresh"})}function h(e,t){d=t.data.order,p()}function g(e,t){$("#divOrderNewProductsG").datagrid("loadData",t.data.rs),w()}function S(){var e=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("listorderdetails",{quoteid:A,version:e},{type:"refresh"})}function y(e,t){doServerDataMessage("listorderstatuses",{quoteid:A},{type:"refresh",orderstatusid:t.data.orderstatusid})}function G(e,t){var d;"new"==t?(d=doGetComboTreeSelectedId("cbNewOrderClients"),doDlgProductSelect(d,!0,!1,function(e,t,d,r,o){if(P)$("#divOrderNewProductsG").datagrid("appendRow",{id:e,productid:e,qty:d,price:r,isrepeat:o}),w();else{var i=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("neworderdetail",{quoteid:A,version:i,productid:e,qty:d,price:r,discount:null,expressfee:null},{type:"refresh"})}})):"clear"==t?$("#divOrderNewProductsG").datagrid("clearSelections"):"edit"==t?doGridGetSelectedRowData("divOrderNewProductsG",function(e){doGridStartEdit("divOrderNewProductsG",r,function(e,t){r=t,doGridGetEditor("divOrderNewProductsG",r,"price",function(e){})})}):"cancel"==t?r=doGridCancelEdit("divOrderNewProductsG",r):"save"==t?(doGridEndEditGetRow("divOrderNewProductsG",r,function(e){if(P)w();else{var t=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("saveorderdetail",{orderdetailid:e.id,productid:e.productid,price:e.price,qty:e.qty,discount:e.discount,expressfee:e.expressfee,isrepeat:e.isrepeat,version:t},{type:"refresh"})}}),r=null):"remove"==t&&(doGridGetSelectedRowData("divOrderNewProductsG",function(t){doPromptOkCancel("Remove "+doGetCodeFromIdInObjArray(cache_products,t.productid)+"?",function(e){e&&(P?(doGridRemoveRow("divOrderNewProductsG",t),w()):doServerDataMessage("expireorderdetail",{orderdetailid:t.id},{type:"refresh"}))})})||doShowError("Please select a product to remove"))}function V(e,t){"new"==t?doServerDataMessage("newordernote",{quoteid:A},{type:"refresh"}):"clear"==t?$("#divNewQuoteNotesG").datagrid("clearSelections"):"edit"==t?doGridGetSelectedRowData("divNewQuoteNotesG",function(e,t){_.isNull(a)&&(a=t,l="divOrderNote-id-"+e.id,n=$("#"+l).html(),s=new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"}).panelInstance(l,{hasPanel:!0}))}):"cancel"==t?a=doGridCancelEdit("divNewOrderNotesG",a,function(){s.removeInstance(l),$("#"+l).html(n),s=n=null}):"save"==t?doGridEndEditGetRow("divNewOrderNotesG",a,function(e){var t=nicEditors.findEditor(l).getContent();doServerDataMessage("saveordernote",{ordernoteid:e.id,notes:t},{type:"refresh"}),s.removeInstance(l),a=s=n=null}):"remove"==t?doGridGetSelectedRowData("divNewOrderNotesG",function(t){doPromptOkCancel("Remove selected note?",function(e){e&&doServerDataMessage("expireorderote",{ordernoteid:t.id},{type:"refresh"})})})||doShowError("Please select a note to remove"):"search"==t&&doDlgNoteSearch(function(e){doServerDataMessage("searchordernote",{quoteid:A,words:e},{type:"refresh"})},function(){doServerDataMessage("listordernotes",{quoteid:A},{type:"refresh"})})}function E(e,t){"clear"==t?$("#divNewOrderAttachmentsG").datagrid("clearSelections"):"edit"==t?doGridStartEdit("divNewOrderAttachmentsG",r,function(e,t){c=t,doGridGetEditor("divNewOrderAttachmentsG",c,"description",function(e){})}):"cancel"==t?c=doGridCancelEdit("divNewOrderAttachmentsG",r):"save"==t?(doGridEndEditGetRow("divNewOrderAttachmentsG",c,function(e){doServerDataMessage("saveorderattachment",{orderattachmentid:e.id,description:e.description,isthumbnail:e.isthumbnail},{type:"refresh"})}),c=null):"remove"==t?doGridGetSelectedRowData("divNewOrderAttachmentsG",function(t){doPromptOkCancel("Remove attachment "+t.description+"?",function(e){e&&doServerDataMessage("expireorderattachment",{orderattachmentid:t.id},{type:"refresh"})})})||doShowError("Please select an attachment to remove"):"download"==t&&doGridGetSelectedRowData("divNewOrderAttachmentsG",function(e){doThrowOrderAttachment(e.id)})}$("#divEvents").on("newordernote",e),$("#divEvents").on("saveordernote",e),$("#divEvents").on("ordernotecreated",e),$("#divEvents").on("ordernotesaved",e),$("#divEvents").on("listordernotes",u),$("#divEvents").on("listorderattachments",f),$("#divEvents").on("orderattachmentcreated",b),$("#divEvents").on("orderattachmentsaved",b),$("#divEvents").on("orderattachmentexpired",b),$("#divEvents").on("saveorderattachment",b),$("#divEvents").on("expireorderattachment",b),$("#divEvents").on("checkorderpo",v),$("#divEvents").on("neworder",N),$("#divEvents").on("saveorder",N),$("#divEvents").on("getprice",m),$("#divEvents").on("loadorder",h),$("#divEvents").on("loadclient",x),$("#divEvents").on("listorderdetails",g),$("#divEvents").on("saveorderdetail",S),$("#divEvents").on("neworderdetail",S),$("#divEvents").on("expireorderdetail",S),$("#divEvents").on("newversionorder",O),$("#divEvents").on("listorderstatuses",function(e,t){var d=[];$("#cbNewOrderStatusesStatus").combobox("clear"),$("#fldNewOrderStatusesConnote").textbox("clear"),$("#fldNewOrderStatusesCarrier").textbox("clear"),$("#fldNewOrderStatusesComment").textbox("clear"),$("#fldNewOrderStatusesBatchno").textbox("clear"),t.data.rs.forEach(function(e){d.push({id:doNiceId(e.id),status:e.status,carriername:doNiceString(e.carriername),connote:doNiceString(e.connote),comments:doNiceString(e.comments),batchno:doNiceString(e.batchno),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewOrderStatusesG").datagrid("loadData",d),_.isUndefined(t.pdata.orderstatusid)||_.isNull(t.pdata.orderstatusid)||$("#divNewOrderStatusesG").datagrid("selectRecord",t.pdata.orderstatusid)}),$("#divEvents").on("neworderstatus",y),$("#divEvents").on("orderstatuscreated",y),$("#divEvents").on("ordernewpopup",G),$("#divEvents").on("ordernotespopup",V),$("#divEvents").on("orderattachmentspopup",E),$("#divEvents").on("orderstatuspopup",function(e,t){var d,r,o,i,a;"new"==t?(d=$("#cbNewOrderStatusesStatus").combobox("getValue"),r=$("#fldNewOrderStatusesConnote").textbox("getValue"),o=$("#fldNewOrderStatusesCarrier").textbox("getValue"),i=$("#fldNewOrderStatusesComment").textbox("getValue"),a=$("#fldNewOrderStatusesBatchno").textbox("getValue"),_.isBlank(d)&&(d=0),doServerDataMessage("neworderstatus",{quoteid:A,status:d,connote:r,carrier:o,comment:i,batchno:a},{type:"refresh"})):"clear"==t&&$("#divNewOrderStatusesG").datagrid("clearSelections")}),$("#dlgOrderNew").dialog({onClose:function(){$("#divEvents").off("newordernote",e),$("#divEvents").off("saveordernote",e),$("#divEvents").off("ordernotecreated",e),$("#divEvents").off("ordernotesaved",e),$("#divEvents").off("listordernotes",u),$("#divEvents").off("listorderattachments",f),$("#divEvents").off("orderattachmentcreated",b),$("#divEvents").off("orderattachmentsaved",b),$("#divEvents").off("orderattachmentexpired",b),$("#divEvents").off("saveorderattachment",b),$("#divEvents").off("expireorderattachment",b),$("#divEvents").off("checkorderpo",v),$("#divEvents").off("neworder",N),$("#divEvents").off("saveorder",N),$("#divEvents").off("getprice",m),$("#divEvents").off("loadorder",h),$("#divEvents").off("loadclient",x),$("#divEvents").off("listorderdetails",g),$("#divEvents").off("saveorderdetail",S),$("#divEvents").off("neworderdetail",S),$("#divEvents").off("expireorderdetail",S),$("#divEvents").off("newversionorder",O),$("#divEvents").off("ordernewpopup",G),$("#divEvents").off("ordernotespopup",V),$("#divEvents").off("orderattachmentspopup",E)},onOpen:function(){selectedQuoteIdAttachmentId=A,$("#cbNewOrderClients").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("loadclient",{clientid:e.id},{type:"refresh"})}}),$("#cbNewOrderVersions").combobox({valueField:"name",textField:"name",data:i,limitToList:!0,onSelect:function(e){doServerDataMessage("listorderdetails",{quoteid:A,version:e.name},{type:"refresh"})}}),$("#cbNewOrderInvoiceAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("loadclient",{clientid:e.id},{type:"invoiceto"})}}),$("#cbNewOrderShiptoAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("loadclient",{clientid:e.id},{type:"shipto"})}}),$("#cbNewOrderCountry").combobox({valueField:"country",textField:"country",data:cache_countries,limitToList:!0,onSelect:function(e){t=doGetStatesFromCountry(e.country),$("#cbNewOrderState").combobox("loadData",t)}}),$("#cbNewOrderState").combobox({valueField:"state",textField:"state",data:o,limitToList:!0}),$("#cbNewOrderShiptoCountry").combobox({valueField:"country",textField:"country",data:cache_countries,limitToList:!0,onSelect:function(e){o=doGetStatesFromCountry(e.country),$("#cbNewOrderShiptoState").combobox("loadData",o)}}),$("#cbNewOrderShiptoState").combobox({valueField:"state",textField:"state",data:o,limitToList:!0}),$("#cbNewOrderTemplateQuote").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0}),$("#cbNewOrderTemplateOrder").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0}),$("#cbNewOrderTemplateInvoice").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0}),$("#fldNewOrderPONo").textbox({onChange:function(e,t){_.isBlank(e)||e!=t&&doServerDataMessage("checkorderpo",{quoteid:A,pono:e},{type:"refresh"})}}),$("#dtNewOrderStartDate").datebox(),$("#dtNewOrderEndDate").datebox(),$("#cbNewOrderStatusesStatus").combobox({valueField:"id",textField:"name",data:orderstatustypes}),$("#divOrderNewProductsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbOrderNew",showFooter:!0,columns:[[{title:"Product",field:"productid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",groupField:"productcategoryname",data:cache_products,onSelect:function(e){var o;o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,d){var r=doGetComboTreeSelectedId("cbNewOrderClients");doGridGetEditor("divOrderNewProductsG",d,"productid",function(e){var t=$(e.target).numberbox("getValue");doServerDataMessage("getprice",{clientid:r,productid:o.id,qty:t},{type:"refresh",rowindex:d})})})}}},formatter:function(e,t){return doGetCodeFromIdInObjArray(cache_products,e)}},{title:"Price",field:"price",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4}},formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Qty",field:"qty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4,onChange:function(e,t){var o;_.isNull(t)||e==t||(o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,d){var r=doGetComboTreeSelectedId("cbNewOrderClients");doGridGetEditor("divOrderNewProductsG",d,"productid",function(e){var t=$(e.target).combobox("getValue");doServerDataMessage("getprice",{clientid:r,productid:t,qty:o},{type:"refresh",rowindex:d})})}))}}},formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatqty(e)}},{title:"Discount",field:"discount",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2,onChange:function(e,t){var o;o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,t){var d=$("#divOrderNewProductsG").datagrid("getEditors",t),r=$(d[4].target).numberbox("getValue");0==o||_.isBlank(o)||0==r||_.isBlank(r)||($(d[4].target).numberbox("clear"),doShowWarning("You can't have a fee and discount..."))})}}},formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Express Fee",field:"expressfee",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2,onChange:function(e,t){var o;o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,t){var d=$("#divOrderNewProductsG").datagrid("getEditors",t),r=$(d[3].target).numberbox("getValue");0==o||_.isBlank(o)||0==r||_.isBlank(r)||($(d[3].target).numberbox("clear"),doShowWarning("You can't have a discount and fee..."))})}}},formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Repeat?",field:"isrepeat",width:80,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(e,t){if(!_.isUndefined(e))return mapBoolToImage(e)}}]],onRowContextMenu:function(e,t,d){doGridContextMenu("divOrderNewProductsG","divOrderNewMenuPopup",e,t,d)},onDblClickCell:function(e,d,t){doGridGetSelectedRowData("divOrderNewProductsG",function(e){doGridStartEdit("divOrderNewProductsG",r,function(e,t){r=t,-1!=["modified","by"].indexOf(d)&&(d="price"),doGridGetEditor("divOrderNewProductsG",r,d,function(e){})})})}}),$("#divNewOrderNotesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,toolbar:"#tbOrderNotes",data:[],view:$.extend({},$.fn.datagrid.defaults.view,{renderRow:function(e,t,d,r,o){var i=[];return!d&&o.id?i.push('<td style="width: 950px;; padding: 5px 5px; border: 0;">  <div style="float: left; margin-left: 10px;">    <p><span class="c-label">Modified: </span>'+o.date+'</p>    <p><span class="c-label">By: </span>'+o.by+'</p>  </div>  <div style="clear: both;"></div>  <div id="divOrderNote-id-'+o.id+'" style="float: left; margin-left: 10px; margin-right: 10px; width: 100%; height: 100px; border: 1px dashed #ddd">'+o.notes+"</div> </td>"):i.push('<td style="width: 100%; padding: 5px 5px; border: 0;"></td>'),i.join("")}}),onDblClickRow:function(e,t){_.isNull(a)&&t&&(a=e,l="divOrderNote-id-"+t.id,n=$("#"+l).html(),s=new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"}).panelInstance(l,{hasPanel:!0}))}}),$("#divNewOrderAttachmentsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:"#tbOrderAttachments",columns:[[{title:"Name",field:"name",width:200,align:"left",resizable:!0},{title:"Description",field:"description",width:300,align:"left",resizable:!0,editor:"text"},{title:"Type",field:"mimetype",width:100,align:"center",resizable:!0},{title:"Size",field:"size",width:150,align:"right",resizable:!0,formatter:function(e,t){return filesize(e,{base:10})}},{title:"Thumbnail",field:"isthumbnail",width:150,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(e,t){return mapBoolToImage(e)}},{title:"Image",field:"image",width:50,align:"center",resizable:!0},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,d){doGridContextMenu("divNewOrderAttachmentsG","divOrderAttachmentsMenuPopup",e,t,d)},onDblClickCell:function(e,t,d){doGridStartEdit("divNewOrderAttachmentsG",c,function(e,t){c=t,doGridGetEditor("divNewOrderAttachmentsG",c,"description",function(e){})})}}),$("#divNewOrderStatusesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:"#tbOrderStatuses",frozenColumns:[[{title:"Status",field:"status",width:200,align:"left",resizable:!0,formatter:function(e,t){return doGetStringFromIdInObjArray(orderstatustypes,e)}}]],columns:[[{title:"Con Note",field:"connote",width:200,align:"left",resizable:!0},{title:"Carrier",field:"carriername",width:150,align:"left",resizable:!0},{title:"Comments",field:"comments",width:200,align:"left",resizable:!0},{title:"Batch No.",field:"batchno",width:150,align:"left",resizable:!0},{title:"Modified",field:"date",width:150,align:"left",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,d){doGridContextMenu("divNewOrderStatusesG","divOrderStatusesMenuPopup",e,t,d)},onDblClickCell:function(e,t,d){}}),P?$("#btnOrderNewAdd").linkbutton({text:"Add"}):$("#btnOrderNewAdd").linkbutton({text:"Save"}),_.isNull(A)?p():(doServerDataMessage("loadorder",{quoteid:A},{type:"refresh"}),doServerDataMessage("listorderattachments",{quoteid:A},{type:"refresh"}),doServerDataMessage("listorderstatuses",{quoteid:A},{type:"refresh"}),doServerDataMessage("listordernotes",{quoteid:A},{type:"refresh"})),$("#newordertabs").tabs({selected:0}),myperms.cancreateorders||($("#btnOrderNewAdd").css("display","none"),$("#btnOrderNewVersion").css("display","none"))},buttons:[{text:"Add",disabled:!0,id:"btnOrderNewAdd",handler:function(){var e=$("#fldNewOrderPONo").textbox("getValue"),t=$("#fldNewOrderOrderName").textbox("getValue"),d=$("#cbNewOrderClients").combotree("getValue"),r=$("#fldNewOrderFreight").numberbox("getValue"),o=$("#fldNewOrderName").textbox("getValue"),i=$("#fldNewOrderAddress1").textbox("getValue"),a=$("#fldNewOrderAddress2").textbox("getValue"),n=$("#fldNewOrderAddress3").textbox("getValue"),s=$("#fldNewOrderAddress4").textbox("getValue"),l=$("#fldNewOrderCity").textbox("getValue"),c=$("#fldNewOrderPostcode").textbox("getValue"),u=$("#cbNewOrderCountry").combobox("getValue"),b=$("#cbNewOrderState").combobox("getValue"),f=$("#fldNewOrderShiptoName").textbox("getValue"),p=$("#fldNewOrderShiptoAddress1").textbox("getValue"),w=$("#fldNewOrderShiptoAddress2").textbox("getValue"),v=$("#fldNewOrderShiptoAddress3").textbox("getValue"),N=$("#fldNewOrderShiptoAddress4").textbox("getValue"),m=$("#fldNewOrderShiptoCity").textbox("getValue"),x=$("#fldNewOrderShiptoPostcode").textbox("getValue"),O=$("#cbNewOrderShiptoCountry").combobox("getValue"),h=$("#cbNewOrderShiptoState").combobox("getValue"),g=$("#fldNewOrderShiptoNote").textbox("getValue"),S=$("#dtNewOrderStartDate").datebox("getValue"),y=$("#dtNewOrderEndDate").datebox("getValue"),G=$("#cbNewOrderTemplateQuote").combobox("getValue"),V=$("#cbNewOrderTemplateOrder").combobox("getValue"),E=$("#cbNewOrderTemplateInvoice").combobox("getValue"),C=$("#divOrderNewProductsG").datagrid("getData");if(_.isBlank(e)&&_.isBlank(t)&&_.isBlank(d))doMandatoryTextbox("Need at least a P.O. number or name","fldNewOrderPONo");else if(P)doServerDataMessage("neworderclient",{name:t,pono:e,clientid:d,startdate:S,enddate:y,invoicetoname:o,address1:i,address2:a,address3:n,address4:s,city:l,postcode:c,country:u,state:b,shiptoname:f,shiptoaddress1:p,shiptoaddress2:w,shiptoaddress3:v,shiptoaddress4:N,shiptocity:m,shiptopostcode:x,shiptocountry:O,shiptostate:h,shiptonote:g,quotetemplateid:G,ordertemplateid:V,invoicetemplateid:E,freightprice:r,products:C.rows},{type:"refresh"});else{var D=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("saveorder",{quoteid:A,clientid:d,name:t,pono:e,activeversion:D,startdate:S,enddate:y,invoicetoname:o,address1:i,address2:a,address3:n,address4:s,city:l,postcode:c,country:u,state:b,shiptoname:f,shiptoaddress1:p,shiptoaddress2:w,shiptoaddress3:v,shiptoaddress4:N,shiptocity:m,shiptopostcode:x,shiptocountry:O,shiptostate:h,shiptonote:g,quotetemplateid:G,ordertemplateid:V,invoicetemplateid:E,freightprice:r},{type:"refresh"})}}},{text:"New Version",id:"btnOrderNewVersion",handler:function(){doPromptOkCancel("Create new version from version "+d.activeversion+"?",function(e){e&&doServerDataMessage("newversionorder",{quoteid:A,version:d.activeversion},{type:"refresh"})})}},{text:"Reset",handler:function(){p()}},{text:"Close",handler:function(){$("#dlgOrderNew").dialog("close")}}]}).dialog("center").dialog("open")}