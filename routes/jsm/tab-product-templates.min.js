var producttemplatesTabWidgetsLoaded=!1;function doTemplatesTabSearch(e,t){doSearchCodeNameInTree("divTemplatesTG",e)}function doProductTemplatesTabWidgets(){var i=null;function e(e,t){doServerMessage("listproducttemplates",{type:"refresh",producttemplateid:t.data.producttemplateid})}producttemplatesTabWidgetsLoaded||(producttemplatesTabWidgetsLoaded=!0,$("#divEvents").on("listproducttemplates",function(e,t){$("#divTemplatesTG").treegrid("reload"),doExpandTreeToId("divTemplatesTG",t.pdata.producttemplateid)}),$("#divEvents").on("newproducttemplate",e),$("#divEvents").on("saveproducttemplate",e),$("#divEvents").on("changeproducttemplateparent",e),$("#divEvents").on("duplicateproducttemplate",e),$("#divEvents").on("expireproducttemplate",e),$("#divEvents").on("producttemplatesynced",e),$("#divEvents").on("newproducttemplatedetail",e),$("#divEvents").on("saveproducttemplatedetail",e),$("#divEvents").on("expireproducttemplatedetail",e),$("#divEvents").on("producttemplatedetailcreated",e),$("#divEvents").on("producttemplatedetailsaved",e),$("#divEvents").on("producttemplatedetailexpired",e),$("#divEvents").on("productupdated",e),$("#divEvents").on("producttemplatespopup",function(e,t){var d;"newroot"==t?doServerDataMessage("newproducttemplate",{parentid:null,name:"New Template",code:"New Code"},{type:"refresh"}):"new"==t?doTreeGridGetSelectedRowData("divTemplatesTG",function(e){doServerDataMessage("newproducttemplate",{parentid:e.id,name:"New Template"},{type:"refresh"})}):"clear"==t?$("#divTemplatesTG").treegrid("unselectAll"):"edit"==t?doTreeGridStartEdit("divTemplatesTG",i,function(e,t){i=t,doTreeGridGetEditor("divTemplatesTG",i,"name",function(e){})}):"cancel"==t?i=doTreeGridCancelEdit("divTemplatesTG",i):"save"==t?(doTreeGridEndEditGetRow("divTemplatesTG",i,function(e){doServerDataMessage("saveproducttemplate",{producttemplateid:e.id,name:e.name,code:e.code,clientid:e.clientid,taxcodeid:e.taxcodeid,price:e.price,qty:e.qty},{type:"refresh"})}),i=null):"remove"==t?(d=$("#divTemplatesTG").treegrid("getSelected"))?doPromptYesNoCancel("Remove "+d.name+" and ALL subtemplates (Yes) or ONLY this template (No)?",function(e){_.isNull(e)||doServerDataMessage("expireproducttemplate",{producttemplateid:d.id,cascade:e},{type:"refresh"})}):doShowError("Please select an template to remove"):"removeparent"==t?doTreeGridGetSelectedRowData("divTemplatesTG",function(e){doServerDataMessage("changeproducttemplateparent",{producttemplateid:e.id,parentid:null},{type:"refresh"})}):"duplicate"==t?doTreeGridGetSelectedRowData("divTemplatesTG",function(e){doServerDataMessage("duplicateproducttemplate",{producttemplateid:e.id},{type:"refresh"})}):"details"==t&&(doTreeGridGetSelectedRowData("divTemplatesTG",function(e){doDlgTemplateDetails(e)})||doShowError("Please select a template to view/edit details"))}),$("#divTemplatesTG").treegrid({idField:"id",treeField:"code",lines:!0,collapsible:!0,fitColumns:!1,autoRowHeight:!1,rownumbers:!0,striped:!0,toolbar:"#tbTemplates",showFooter:!0,sortName:"code",sortOrder:"asc",remoteSort:!1,multiSort:!0,loader:function(e,t,d){t({total:cache_producttemplates.length,rows:cache_producttemplates}),$("#divTemplatesTG").treegrid("reloadFooter",[{code:'<span class="totals_footer">'+doGetCountTreeArray(cache_producttemplates)+" Templates</span>"}])},frozenColumns:[[{title:"Code",field:"code",width:200,align:"left",resizable:!0,editor:"text",sortable:!0}]],columns:[[{title:"Name",field:"name",width:300,align:"left",resizable:!0,editor:"text",sortable:!0},{title:"Client",field:"clientid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"name",data:cache_clients,onSelect:function(e){}}},formatter:function(e,t){return doGetStringFromIdInObjArray(cache_clients,e)}},{title:"Tax Code",field:"taxcodeid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"name",data:cache_taxcodes,onSelect:function(e){}}},formatter:function(e,t){return doGetStringFromIdInObjArray(cache_taxcodes,e)}},{title:"RRP",field:"price",width:150,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2}},formatter:function(e,t,d){return _.niceformatnumber(e)}},{title:"Qty",field:"qty",width:150,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:0}},formatter:function(e,t,d){return _.niceformatqty(e)}},{title:"Total Cost",field:"totalprice",width:150,align:"right",resizable:!0,formatter:function(e,t,d){return _.niceformatnumber(e)}},{title:"#Products",field:"numproducts",width:150,align:"right",resizable:!0},{title:"Unit Cost",field:"unitcost",width:150,align:"right",resizable:!0,formatter:function(e,t,d){return function(e,t,d){var i=_.toBigNum(t.qty);if(!i.isZero()){var r=_.toBigNum(t.totalprice).dividedBy(i);return _.formatnumber(r,6)}}(0,t)}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0,sortable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0,sortable:!0}]],onContextMenu:function(e,t){doTreeGridContextMenu("divTemplatesTG","divTemplatesMenuPopup",e,t)},onLoadSuccess:function(e){$(this).treegrid("enableDnd")},onDblClickCell:function(e,t){},onBeforeDrag:function(e){return!i},onDragOver:function(e,t){return!_.isUN(e)},onBeforeDrop:function(e,t,d){return!0},onDrop:function(e,t,d){var i=_.isUN(e)?null:e.id;doServerDataMessage("changeproducttemplateparent",{producttemplateid:t.id,parentid:i},{type:"refresh"})},onDblClickCell:function(d,e){doTreeGridStartEdit("divTemplatesTG",i,function(e,t){i=t,-1!=["numproducts","modified","by"].indexOf(d)&&(d="name"),doTreeGridGetEditor("divTemplatesTG",i,d,function(e){})})}}))}