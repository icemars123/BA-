var producttemplatesTabWidgetsLoaded=!1;function doTemplatesTabSearch(e,f){doSearchCodeNameInTree("divTemplatesTG",e)}
function doProductTemplatesTabWidgets(){function e(){doTreeGridGetSelectedRowData("divTemplatesTG",function(a){doServerDataMessage("newproducttemplate",{parentid:a.id,name:"New Template"},{type:"refresh"})})}function f(){doTreeGridStartEdit("divTemplatesTG",d,function(a,b){d=b;doTreeGridGetEditor("divTemplatesTG",d,"name",function(a){})})}function g(){doTreeGridEndEditGetRow("divTemplatesTG",d,function(a){doServerDataMessage("saveproducttemplate",{producttemplateid:a.id,name:a.name,code:a.code,clientid:a.clientid,
taxcodeid:a.taxcodeid,price:a.price,qty:a.qty},{type:"refresh"})});d=null}function h(){var a=$("#divTemplatesTG").treegrid("getSelected");a?doPromptYesNoCancel("Remove "+a.name+" and ALL subtemplates (Yes) or ONLY this template (No)?",function(b){_.isNull(b)||doServerDataMessage("expireproducttemplate",{producttemplateid:a.id,cascade:b},{type:"refresh"})}):doShowError("Please select an template to remove")}function k(){doTreeGridGetSelectedRowData("divTemplatesTG",function(a){doServerDataMessage("duplicateproducttemplate",
{producttemplateid:a.id},{type:"refresh"})})}function l(){doTreeGridGetSelectedRowData("divTemplatesTG",function(a){doDlgTemplateDetails(a)})||doShowError("Please select a template to view/edit details")}function m(){doTreeGridGetSelectedRowData("divTemplatesTG",function(a){doServerDataMessage("changeproducttemplateparent",{producttemplateid:a.id,parentid:null},{type:"refresh"})})}function c(a,b){doServerMessage("listproducttemplates",{type:"refresh",producttemplateid:b.data.producttemplateid})}var d=
null;producttemplatesTabWidgetsLoaded||(producttemplatesTabWidgetsLoaded=!0,$("#divEvents").on("listproducttemplates",function(a,b){$("#divTemplatesTG").treegrid("reload");doExpandTreeToId("divTemplatesTG",b.pdata.producttemplateid)}),$("#divEvents").on("newproducttemplate",c),$("#divEvents").on("saveproducttemplate",c),$("#divEvents").on("changeproducttemplateparent",c),$("#divEvents").on("duplicateproducttemplate",c),$("#divEvents").on("expireproducttemplate",c),$("#divEvents").on("producttemplatesynced",
c),$("#divEvents").on("newproducttemplatedetail",c),$("#divEvents").on("saveproducttemplatedetail",c),$("#divEvents").on("expireproducttemplatedetail",c),$("#divEvents").on("producttemplatedetailcreated",c),$("#divEvents").on("producttemplatedetailsaved",c),$("#divEvents").on("producttemplatedetailexpired",c),$("#divEvents").on("productupdated",c),$("#divEvents").on("producttemplatespopup",function(a,b){"newroot"==b?doServerDataMessage("newproducttemplate",{parentid:null,name:"New Template",code:"New Code"},
{type:"refresh"}):"new"==b?e():"clear"==b?$("#divTemplatesTG").treegrid("unselectAll"):"edit"==b?f():"cancel"==b?d=doTreeGridCancelEdit("divTemplatesTG",d):"save"==b?g():"remove"==b?h():"removeparent"==b?m():"duplicate"==b?k():"details"==b&&l()}),$("#divTemplatesTG").treegrid({idField:"id",treeField:"code",lines:!0,collapsible:!0,fitColumns:!1,autoRowHeight:!1,rownumbers:!0,striped:!0,toolbar:"#tbTemplates",showFooter:!0,sortName:"code",sortOrder:"asc",remoteSort:!1,multiSort:!0,loader:function(a,
b,c){b({total:cache_producttemplates.length,rows:cache_producttemplates});$("#divTemplatesTG").treegrid("reloadFooter",[{code:'<span class="totals_footer">'+doGetCountTreeArray(cache_producttemplates)+" Templates</span>"}])},frozenColumns:[[{title:"Code",field:"code",width:200,align:"left",resizable:!0,editor:"text",sortable:!0}]],columns:[[{title:"Name",field:"name",width:300,align:"left",resizable:!0,editor:"text",sortable:!0},{title:"Client",field:"clientid",width:200,align:"left",resizable:!0,
editor:{type:"combobox",options:{valueField:"id",textField:"name",data:cache_clients,onSelect:function(a){}}},formatter:function(a,b){return doGetStringFromIdInObjArray(cache_clients,a)}},{title:"Tax Code",field:"taxcodeid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"name",data:cache_taxcodes,onSelect:function(a){}}},formatter:function(a,b){return doGetStringFromIdInObjArray(cache_taxcodes,a)}},{title:"RRP",field:"price",width:150,align:"right",
resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2}},formatter:function(a,b,c){return _.niceformatnumber(a)}},{title:"Qty",field:"qty",width:150,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:0}},formatter:function(a,b,c){return _.niceformatqty(a)}},{title:"Total Cost",field:"totalprice",width:150,align:"right",resizable:!0,formatter:function(a,b,c){return _.niceformatnumber(a)}},{title:"#Products",field:"numproducts",width:150,
align:"right",resizable:!0},{title:"Unit Cost",field:"unitcost",width:150,align:"right",resizable:!0,formatter:function(a,b,c){a=_.toBigNum(b.qty);a.isZero()?b=void 0:(b=_.toBigNum(b.totalprice).dividedBy(a),b=_.formatnumber(b,6));return b}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0,sortable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0,sortable:!0}]],onContextMenu:function(a,b){doTreeGridContextMenu("divTemplatesTG","divTemplatesMenuPopup",a,b)},onLoadSuccess:function(a){$(this).treegrid("enableDnd")},
onBeforeDrag:function(a){return d?!1:!0},onDragOver:function(a,b){return _.isUN(a)?!1:!0},onBeforeDrop:function(a,b,c){return!0},onDrop:function(a,b,c){a=_.isUN(a)?null:a.id;doServerDataMessage("changeproducttemplateparent",{producttemplateid:b.id,parentid:a},{type:"refresh"})},onDblClickCell:function(a,b){doTreeGridStartEdit("divTemplatesTG",d,function(b,c){d=c;-1!=["numproducts","modified","by"].indexOf(a)&&(a="name");doTreeGridGetEditor("divTemplatesTG",d,a,function(a){})})}}))};
