function doDlgTemplateDetails(o){var i=null,e=[{text:"New",iconCls:"icon-add",handler:d},{text:"Clear",iconCls:"icon-clear",handler:function(){$("#divTemplateProductsG").datagrid("clearSelections")}},{text:"Edit",iconCls:"icon-edit",handler:a},{text:"Cancel",iconCls:"icon-cancel",handler:function(){i=doGridCancelEdit("divTemplateProductsG",i)}},{text:"Save",iconCls:"icon-save",handler:function(){doGridEndEditGetRow("divTemplateProductsG",i,function(e){var t=e.qty;1==e.pertemplateqty&&(t=_.toBigNum(t).ceil().toFixed(0),$("#divTemplateProductsG").datagrid("updateRow",{index:i,row:{qty:t}})),doServerDataMessage("saveproducttemplatedetail",{producttemplatedetailid:e.id,productid:e.productid,taxcodeid:e.taxcodeid,price:e.price,qty:t,pertemplateqty:e.pertemplateqty},{type:"refresh"})}),i=null}},{text:"Remove",iconCls:"icon-remove",handler:r},{text:"Sync Subtemplates",iconCls:"icon-sync",handler:function(){doPromptOkCancel("This will replace all products of all sub-templates with the products from this template. Are you sure?",function(e){e&&doServerDataMessage("syncproducttemplate",{producttemplateid:o.id},{type:"refresh"})})}}];function d(){doDlgProductSelect(o.clientid,!1,!0,function(e,t,d,i){doServerDataMessage("newproducttemplatedetail",{producttemplateid:o.id,productid:e,qty:d,price:i},{type:"refresh"})})}function a(){doGridStartEdit("divTemplateProductsG",i,function(e,t){i=t,doGridGetEditor("divTemplateProductsG",i,"name",function(e){})})}function r(){doGridGetSelectedRowData("divTemplateProductsG",function(t){doPromptOkCancel("Remove "+doGetStringFromIdInObjArray(cache_products,t.productid)+"?",function(e){e&&doServerDataMessage("expireproducttemplatedetail",{producttemplatedetailid:t.id},{type:"refresh"})})})||doShowError("Please select a product to remove")}function t(e,t){var d=[];t.data.rs.forEach(function(e){d.push({id:doNiceId(e.id),productid:doNiceId(e.productid),productcategoryid:doNiceId(e.productcategoryid),taxcodeid:doNiceId(e.taxcodeid),price:doNiceString(e.price),gst:doNiceString(e.gst),qty:doNiceString(e.qty),pertemplateqty:e.pertemplateqty,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divTemplateProductsG").datagrid("loadData",d),doGridCalcTotals("divTemplateProductsG","price","qty"),_.isUndefined(t.pdata.producttemplatedetailid)||_.isNull(t.pdata.producttemplatedetailid)||$("#divTemplateProductsG").datagrid("selectRecord",t.pdata.producttemplatedetailid)}function l(e,t){t.data.producttemplateid==o.id&&doServerDataMessage("listproductsbytemplate",{producttemplateid:o.id},{type:"refresh",producttemplatedetailid:t.data.producttemplatedetailid})}function c(e,t){"new"==t?d():"edit"==t?a():"remove"==t?r():"viewproduct"==t&&doGridGetSelectedRowData("divTemplateProductsG",function(e){doSelectInventoryTab(0),$("#divEvents").trigger("gotoproduct",{productcategoryid:e.productcategoryid,productid:e.productid}),$("#dlgTemplateDetails").dialog("close")})}$("#divEvents").on("listproductsbytemplate",t),$("#divEvents").on("newproducttemplatedetail",l),$("#divEvents").on("saveproducttemplatedetail",l),$("#divEvents").on("expireproducttemplatedetail",l),$("#divEvents").on("producttemplatedetailcreated",l),$("#divEvents").on("producttemplatedetailsaved",l),$("#divEvents").on("producttemplatedetailexpired",l),$("#divEvents").on("productupdated",l),$("#divEvents").on("templatedetailspopup",c),$("#dlgTemplateDetails").dialog({title:"Template "+o.name,onClose:function(){$("#divEvents").off("listproductsbytemplate",t),$("#divEvents").off("newproducttemplatedetail",l),$("#divEvents").off("saveproducttemplatedetail",l),$("#divEvents").off("expireproducttemplatedetail",l),$("#divEvents").off("producttemplatedetailcreated",l),$("#divEvents").off("producttemplatedetailsaved",l),$("#divEvents").off("producttemplatedetailexpired",l),$("#divEvents").off("productupdated",l),$("#divEvents").off("templatedetailspopup",c)},onOpen:function(){$("#divTemplateProductsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:e,showFooter:!0,columns:[[{title:"Product",field:"productid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",groupField:"productcategoryname",data:cache_products,onSelect:function(e){doGridChangeCellLabelValue("divTemplateProductsG",i,"price",e.costprice)}}},formatter:function(e,t){return doGetCodeFromIdInObjArray(cache_products,e)}},{title:"Tax Code",field:"taxcodeid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"name",data:cache_taxcodes,onSelect:function(e){}}},formatter:function(e,t){return doGetStringFromIdInObjArray(cache_taxcodes,e)}},{title:"Price",field:"price",width:100,align:"right",resizable:!0,editor:"label",formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Qty",field:"qty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4}},formatter:function(e,t,d){return _.isUndefined(t.id)?e:_.niceformatqty(e)}},{title:"Whole/Tmpl",field:"pertemplateqty",width:100,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(e,t){return mapBoolToImage(e)}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,d){doGridContextMenu("divTemplateProductsG","divTemplatesDetailsMenuPopup",e,t,d)},onDblClickCell:function(e,d,t){doGridStartEdit("divTemplateProductsG",i,function(e,t){i=t,-1!=["qty"].indexOf(d)&&(d="qty"),doGridGetEditor("divTemplateProductsG",i,d,function(e){})})}}),doServerDataMessage("listproductsbytemplate",{producttemplateid:o.id},{type:"refresh"})},buttons:[{text:"Close",handler:function(){$("#dlgTemplateDetails").dialog("close")}}]}).dialog("center").dialog("open")}