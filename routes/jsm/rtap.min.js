function doInsertRfidTap(o,s,i){global.pg.connect(global.cs,function(e,a,l){if(e)global.log.error({rtap:!0},global.text_nodbconnection);else{var r=new global.pgtx(a);r.begin(function(e){e?(l(),global.log.error({rtap:!0},global.text_notxstart+" "+e.message)):a.query("insert into rtap (customers_id,reader,rfid) values ($1,$2,$3)",[global.config.defaults.defaultcustomerid,o,s],function(o,e){o?r.rollback(function(e){l(),global.log.error({rtap:!0},global.text_dbexception+" "+o.message)}):a.query("select e1.lastname,e1.firstname,e1.code from employees e1 where customers_id=$1 and altcode=$2",[global.config.defaults.defaultcustomerid,s],function(o,e){if(o)r.rollback(function(e){l(),global.log.error({rtap:!0},global.text_dbexception+" "+o.message)});else{var a=0<e.rows.length?e.rows[0].lastname:"",t=0<e.rows.length?e.rows[0].firstname:"",n=0<e.rows.length?e.rows[0].code:"";r.commit(function(o,e){o?r.rollback(function(e){l(),global.log.error({rtap:!0},global.text_committx+" "+o.message)}):(l(),global.pr.sendToRoom(global.config.env.notificationschannel,"newrtap",{tag:s,lastname:a,firstname:t,code:n,datecreated:i.format("YYYY-MM-DD HH:mm:ss")}))})}})})})}})}exports.RfidTap=function(e,o){var a,t=0,n="";if(__.isUndefined(e.body))n="Missing input",t=-2;else{var l=e.body;if(!__.isUndefined(l.tag)&&!__.isUndefined(l.reader)){var r=__.sanitiseAsString(l.tag).toLowerCase(),s=__.sanitiseAsString(l.reader).toLowerCase(),i=global.moment();global.rtaps.get(global.config.redis.rtap+r,function(e,o){e||(__.isNull(o)?global.safejsonstringify({tag:r,reader:s,datecreated:i.format("YYYY-MM-DD HH:mm:ss")},function(e,o){e||(global.rtaps.set(global.config.redis.rtap+r,o),doInsertRfidTap(s,r,i))}):global.safejsonparse(o,function(e,o){if(!e){var a=global.moment(o.datecreated),t=i.diff(a,global.config.env.tapdistance);console.log("tag: "+r),t>global.config.env.mintapdistance?(console.log("writing"),global.safejsonstringify({tag:r,reader:s,datecreated:i.format("YYYY-MM-DD HH:mm:ss")},function(e,o){e||(global.rtaps.set(global.config.redis.rtap+r,o),doInsertRfidTap(s,r,i))})):console.log("last seen: "+t)}}))})}}a={rc:t,msg:n},o.json(a)};