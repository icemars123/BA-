var buildtemplatesTabWidgetsLoaded=!1;function doBuildTemplatesTabSearch(e,t){doSearchCodeNameInTree("divBuildTemplatesTG",e)}function doBuildTemplatesTabWidgets(){var d=null;function e(e,t){doServerMessage("listbuildtemplateroots",{type:"refresh",buildtemplateid:t.data.buildtemplateid})}function i(){$("#divBuildTemplatesTG").treegrid("reloadFooter",[{code:'<span class="totals_footer">'+doGetCountTreeArray(cache_buildtemplates)+" Templates</span>"}])}buildtemplatesTabWidgetsLoaded||(buildtemplatesTabWidgetsLoaded=!0,$("#divEvents").on("newbuildtemplate",e),$("#divEvents").on("savebuildtemplate",e),$("#divEvents").on("changebuildtemplateparent",e),$("#divEvents").on("duplicatebuildtemplate",e),$("#divEvents").on("expirebuildtemplate",e),$("#divEvents").on("syncbuildtemplatestomaster",e),$("#divEvents").on("productupdated",e),$("#divEvents").on("listbuildtemplates",function(e,t){$("#divBuildTemplatesTG").treegrid("loadData",cache_buildtemplates),i(),doExpandTreeToId("divBuildTemplatesTG",t.pdata.buildtemplateid)}),$("#divEvents").on("buildtemplategetchildren",function(e,t){$("#divBuildTemplatesTG").treegrid("loadData",cache_buildtemplates),i(),doExpandTreeToId("divBuildTemplatesTG",t.pdata.buildtemplateid,!0),doShowGridLoaded("divBuildTemplatesTG")}),$("#divEvents").on("buildtemplatespopup",function(e,t){"newroot"==t?doSelectTemplatesTabWidgets():"new"==t?doTreeGridGetSelectedRowData("divBuildTemplatesTG",function(e){doSelectTemplatesTabWidgets(e.id)}):"clear"==t?$("#divBuildTemplatesTG").treegrid("unselectAll"):"edit"==t?doTreeGridStartEdit("divBuildTemplatesTG",d,function(e,t){d=t,doTreeGridGetEditor("divBuildTemplatesTG",d,"name",function(e){})}):"cancel"==t?d=doTreeGridCancelEdit("divBuildTemplatesTG",d):"save"==t?(doTreeGridEndEditGetRow("divBuildTemplatesTG",d,function(e){doServerDataMessage("savebuildtemplate",{buildtemplateid:e.id,clientid:e.clientid,taxcodeid:e.taxcodeid,price:e.price,qty:e.qty},{type:"refresh"})}),d=null):"remove"==t?doTreeGridGetSelectedRowData("divBuildTemplatesTG",function(t){doPromptYesNoCancel("Remove "+t.clientname+" and ALL subtemplates (Yes) or ONLY this template (No)?",function(e){_.isNull(e)||doServerDataMessage("expirebuildtemplate",{buildtemplateid:t.id,cascade:e},{type:"refresh"})})})||doShowError("Please select a template to remove"):"removeparent"==t?doTreeGridGetSelectedRowData("divBuildTemplatesTG",function(e){doServerDataMessage("changebuildtemplateparent",{buildtemplateid:e.id,parentid:null},{type:"refresh"})}):"duplicate"==t?doTreeGridGetSelectedRowData("divBuildTemplatesTG",function(e){doServerDataMessage("duplicatebuildtemplate",{buildtemplateid:e.id},{type:"refresh"})}):"details"==t?doTreeGridGetSelectedRowData("divBuildTemplatesTG",function(e){doDlgBuildTemplateDetails(e)})||doShowError("Please select a template to view/edit details"):"mastersync"==t?doPromptOkCancel("This will replace all products of all build templates with the products from the corresponding master templates. Are you sure?",function(e){e&&doServerMessage("syncbuildtemplatestomaster",{type:"refresh"})}):"search"==t?doDlgBuildTemplateSearch(function(e){primus.emit("buildtemplategetchildren",{fguid:fguid,uuid:uuid,session:session,buildtemplateid:e.id,pdata:{type:"refresh"}})}):"build"==t?doTreeGridGetSelectedRowData("divBuildTemplatesTG",function(e){doDlgTemplateBuild(e)})||doShowError("Please select a template to build"):"newproduct"==t&&doTreeGridGetSelectedRowData("divBuildTemplatesTG",function(e){doDlgProductFromBuildTemplate(e.id,e.code,e.name,e.clientid)})}),$("#divBuildTemplatesTG").treegrid({idField:"id",treeField:"code",lines:!0,collapsible:!0,fitColumns:!1,autoRowHeight:!1,rownumbers:!0,striped:!0,toolbar:"#tbBuildTemplates",showFooter:!0,frozenColumns:[[{title:"Code",field:"code",width:200,align:"left",resizable:!0,editor:"text"}]],columns:[[{title:"Name",field:"name",width:300,align:"left",resizable:!0,editor:"text"},{title:"Tax Code",field:"taxcodeid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"name",data:cache_taxcodes,onSelect:function(e){}}},formatter:function(e,t){return doGetStringFromIdInObjArray(cache_taxcodes,e)}},{title:"Price",field:"price",width:150,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2}},formatter:function(e,t,i){return _.niceformatnumber(e)}},{title:"Qty",field:"qty",width:150,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:0}},formatter:function(e,t,i){return _.niceformatqty(e)}},{title:"Total Cost",field:"totalprice",width:150,align:"right",resizable:!0,formatter:function(e,t,i){return _.niceformatnumber(e)}},{title:"#Products",field:"numproducts",width:150,align:"right",resizable:!0},{title:"Unit Cost",field:"unitcost",width:150,align:"right",resizable:!0,formatter:function(e,t,i){return function(e,t,i){var d=_.toBigNum(t.qty);if(!d.isZero()){var l=_.toBigNum(t.totalprice).dividedBy(d);return _.niceformatnumber(l)}}(0,t)}},{title:"Master",field:"producttemplateheaderid",width:300,align:"left",resizable:!0,formatter:function(e,t,i){return doGetNameFromTreeArray(cache_producttemplates,e)}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onContextMenu:function(e,t){doTreeGridContextMenu("divBuildTemplatesTG","divBuildTemplatesMenuPopup",e,t)},onLoadSuccess:function(e){$(this).treegrid("enableDnd")},onBeforeDrag:function(e){return!d},onDragOver:function(e,t){return!0},onBeforeDrop:function(e,t,i){return!0},onDrop:function(e,t,i){doServerDataMessage("changebuildtemplateparent",{buildtemplateid:t.id,parentid:e.id},{type:"refresh"})},onClickRow:function(e){if(_.isNull(e.parentid)){var t=$("#divBuildTemplatesTG").treegrid("getChildren",e.id);(_.isUN(t)||0==t.length)&&(doShowGridLoading("divBuildTemplatesTG"),doServerDataMessage("buildtemplategetchildren",{buildtemplateid:e.id},{type:"refresh"}))}},onDblClickCell:function(i,e){doTreeGridStartEdit("divBuildTemplatesTG",d,function(e,t){d=t,-1!=["numproducts","modified","by"].indexOf(i)&&(i="name"),doTreeGridGetEditor("divBuildTemplatesTG",d,i,function(e){})})}}))}