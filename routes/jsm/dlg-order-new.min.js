var selectedOrderIdAttachmentId=null;
function doDlgOrderNew(J,d){function Q(){doGridGetSelectedRowData("divNewOrderNotesG",function(b,a){_.isNull(k)&&(k=a,g="divOrderNote-id-"+b.id,q=$("#"+g).html(),n=(new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"})).panelInstance(g,{hasPanel:!0}))})}function R(){k=doGridCancelEdit("divNewOrderNotesG",k,function(){n.removeInstance(g);$("#"+g).html(q);n=q=null})}function M(){doGridEndEditGetRow("divNewOrderNotesG",k,function(b){var a=nicEditors.findEditor(g).getContent();doServerDataMessage("saveordernote",
{ordernoteid:b.id,notes:a},{type:"refresh"});n.removeInstance(g);k=n=q=null})}function S(){doGridGetSelectedRowData("divNewOrderNotesG",function(b){doPromptOkCancel("Remove selected note?",function(a){a&&doServerDataMessage("expireorderote",{ordernoteid:b.id},{type:"refresh"})})})||doShowError("Please select a note to remove")}function T(){doDlgNoteSearch(function(b){doServerDataMessage("searchordernote",{orderid:d,words:b},{type:"refresh"})},function(){doServerDataMessage("listordernotes",{orderid:d},
{type:"refresh"})})}function l(b,a){d==a.data.orderid&&doServerDataMessage("listordernotes",{orderid:d},{ordernoteid:a.data.ordernoteid,type:"refresh"})}function y(b,a){var f=[];a.data.rs.forEach(function(a){f.push({id:doNiceId(a.id),notes:doNiceString(a.notes),date:doNiceDateModifiedOrCreated(a.datemodified,a.datecreated),by:doNiceModifiedBy(a.datemodified,a.usermodified,a.usercreated)})});$("#divNewOrderNotesG").datagrid("loadData",f);_.isUndefined(a.pdata.ordernoteid)||_.isNull(a.pdata.ordernoteid)||
$("#divNewOrderNotesG").datagrid("selectRecord",a.pdata.ordernoteid)}function V(){doGridStartEdit("divNewOrderAttachmentsG",e,function(b,a){m=a;doGridGetEditor("divNewOrderAttachmentsG",m,"description",function(a){})})}function W(){doGridEndEditGetRow("divNewOrderAttachmentsG",m,function(b){doServerDataMessage("saveorderattachment",{orderattachmentid:b.id,description:b.description,isthumbnail:b.isthumbnail},{type:"refresh"})});m=null}function X(){doGridGetSelectedRowData("divNewOrderAttachmentsG",
function(b){doPromptOkCancel("Remove attachment "+b.description+"?",function(a){a&&doServerDataMessage("expireorderattachment",{orderattachmentid:b.id},{type:"refresh"})})})||doShowError("Please select an attachment to remove")}function Y(){doGridGetSelectedRowData("divNewOrderAttachmentsG",function(b){doThrowOrderAttachment(b.id)})}function h(b,a){d==a.data.orderid&&doServerDataMessage("listorderattachments",{orderid:d},{type:"refresh"})}function z(b,a){var f=[];a.data.rs.forEach(function(a){var b=
_.isNull(a.image)||_.isUndefined(a.image)?"":'<image src="'+a.image+'" width="35px">';f.push({id:doNiceId(a.id),name:doNiceString(a.name),description:doNiceString(a.description),mimetype:'<a href="javascript:void(0);" onClick="doThrowOrderAttachment('+a.id+');">'+mapMimeTypeToImage(a.mimetype)+"</a>",size:doNiceString(a.size),isthumbnail:a.isthumbnail,image:b,date:doNiceDateModifiedOrCreated(a.datemodified,a.datecreated),by:doNiceModifiedBy(a.datemodified,a.usermodified,a.usercreated)})});$("#divNewOrderAttachmentsG").datagrid("loadData",
f)}function x(){$("#cbNewOrderInvoiceAddress").combotree("clear");$("#cbNewOrderShiptoAddress").combotree("clear");$("#divOrderNewProductsG").datagrid("loadData",[]);$("#cbNewOrderStatusesStatus").combobox("clear");$("#fldNewOrderStatusesConnote").textbox("clear");$("#fldNewOrderStatusesCarrier").textbox("clear");$("#fldNewOrderStatusesComment").textbox("clear");$("#fldNewOrderStatusesBatchno").textbox("clear");if(r)$("#fldNewOrderPONo").textbox("clear"),$("#fldNewOrderOrderName").textbox("clear"),
$("#cbNewOrderClients").combotree("clear"),$("#cbNewOrderVersions").combobox("clear"),$("#fldNewOrderFreight").numberbox("clear"),$("#fldNewOrderName").textbox("clear"),$("#fldNewOrderAddress1").textbox("clear"),$("#fldNewOrderAddress2").textbox("clear"),$("#fldNewOrderAddress3").textbox("clear"),$("#fldNewOrderAddress4").textbox("clear"),$("#fldNewOrderCity").textbox("clear"),$("#fldNewOrderPostcode").textbox("clear"),$("#cbNewOrderCountry").combobox("clear"),$("#cbNewOrderState").combobox("clear"),
$("#fldNewOrderShiptoName").textbox("clear"),$("#fldNewOrderShiptoAddress1").textbox("clear"),$("#fldNewOrderShiptoAddress2").textbox("clear"),$("#fldNewOrderShiptoAddress3").textbox("clear"),$("#fldNewOrderShiptoAddress4").textbox("clear"),$("#fldNewOrderShiptoCity").textbox("clear"),$("#fldNewOrderShiptoPostcode").textbox("clear"),$("#cbNewOrderShiptoCountry").combobox("clear"),$("#cbNewOrderShiptoState").combobox("clear"),$("#fldNewOrderShiptoNote").textbox("clear"),$("#cbNewOrderCountry").combobox("setValue",
defaultCountry),$("#cbNewOrderShiptoCountry").combobox("setValue",defaultCountry),$("#cbNewOrderTemplateQuote").combobox("clear"),$("#cbNewOrderTemplateOrder").combobox("clear"),$("#cbNewOrderTemplateInvoice").combobox("clear"),$("#dtNewOrderStartDate").datebox("clear"),$("#dtNewOrderEndDate").datebox("clear"),$("#btnOrderNewAdd").linkbutton("disable"),$("#tbOrderNewNew").linkbutton("enable"),$("#tbOrderNewClear").linkbutton("enable"),$("#tbOrderNewEdit").linkbutton("enable"),$("#tbOrderNewCancel").linkbutton("enable"),
$("#tbOrderNewSave").linkbutton("enable"),$("#tbOrderNewRemove").linkbutton("enable"),$("#cbNewOrderClients").combotree("enable"),$("#fldNewOrderPONo").textbox("enable"),$("#fldNewOrderOrderName").textbox("enable");else if(!_.isEmpty(c)){var b=J?c.quoteno:c.orderno;$("#fldNewOrderPONo").textbox("setValue",c.pono);$("#fldNewOrderOrderName").textbox("setValue",c.name);$("#cbNewOrderClients").combotree("setValue",c.clientid);$("#fldNewOrderFreight").numberbox("setValue",c.freightprice);t=[];for(var a=
1;a<=c.numversions;a++)t.push({name:a});$("#cbNewOrderVersions").combobox("loadData",t);$("#cbNewOrderVersions").combobox("setValue",c.activeversion);$("#fldNewOrderName").textbox("setValue",c.invoicetoname);$("#fldNewOrderAddress1").textbox("setValue",c.invoicetoaddress1);$("#fldNewOrderAddress2").textbox("setValue",c.invoicetoaddress2);$("#fldNewOrderAddress3").textbox("setValue",c.invoicetoaddress3);$("#fldNewOrderAddress4").textbox("setValue",c.invoicetoaddress4);$("#fldNewOrderCity").textbox("setValue",
c.invoicetocity);$("#fldNewOrderPostcode").textbox("setValue",c.invoicetopostcode);$("#cbNewOrderCountry").combobox("setValue",c.invoicetocountry);$("#cbNewOrderState").combobox("setValue",c.invoicetostate);$("#fldNewOrderShiptoName").textbox("setValue",c.shiptoname);$("#fldNewOrderShiptoAddress1").textbox("setValue",c.shiptoaddress1);$("#fldNewOrderShiptoAddress2").textbox("setValue",c.shiptoaddress2);$("#fldNewOrderShiptoAddress3").textbox("setValue",c.shiptoaddress3);$("#fldNewOrderShiptoAddress4").textbox("setValue",
c.shiptoaddress4);$("#fldNewOrderShiptoCity").textbox("setValue",c.shiptocity);$("#fldNewOrderShiptoPostcode").textbox("setValue",c.shiptopostcode);$("#cbNewOrderShiptoCountry").combobox("setValue",c.shiptocountry);$("#cbNewOrderShiptoState").combobox("setValue",c.shiptostate);$("#fldNewOrderShiptoNote").textbox("setValue",c.shiptonote);$("#cbNewOrderTemplateQuote").combobox("setValue",c.quotetemplateid);$("#cbNewOrderTemplateOrder").combobox("setValue",c.ordertemplateid);$("#cbNewOrderTemplateInvoice").combobox("setValue",
c.invoicetemplateid);$("#dtNewOrderStartDate").datebox("setValue",c.startdate);$("#dtNewOrderEndDate").datebox("setValue",c.enddate);_.isBlank(c.invoiceno)?($("#fldNewOrderPONo").textbox("enable"),$("#fldNewOrderOrderName").textbox("enable"),$("#btnOrderNewAdd").linkbutton("enable"),$("#tbOrderNewNew").linkbutton("enable"),$("#tbOrderNewClear").linkbutton("enable"),$("#tbOrderNewEdit").linkbutton("enable"),$("#tbOrderNewCancel").linkbutton("enable"),$("#tbOrderNewSave").linkbutton("enable"),$("#tbOrderNewRemove").linkbutton("enable")):
($("#fldNewOrderPONo").textbox("disable"),$("#fldNewOrderOrderName").textbox("disable"),$("#btnOrderNewAdd").linkbutton("disable"),$("#tbOrderNewNew").linkbutton("disable"),$("#tbOrderNewClear").linkbutton("disable"),$("#tbOrderNewEdit").linkbutton("disable"),$("#tbOrderNewCancel").linkbutton("disable"),$("#tbOrderNewSave").linkbutton("disable"),$("#tbOrderNewRemove").linkbutton("disable"));$("#cbNewOrderClients").combotree("disable");$("#dlgOrderNew").dialog("setTitle","Modify "+b+", version "+c.activeversion);
doServerDataMessage("listorderdetails",{orderid:d,version:c.activeversion},{type:"refresh"})}doTextboxFocus("fldNewOrderPONo")}function Z(b){doGridGetSelectedRowData("divOrderNewProductsG",function(a,f){var c=doGetComboTreeSelectedId("cbNewOrderClients");doGridGetEditor("divOrderNewProductsG",f,"productid",function(a){a=$(a.target).numberbox("getValue");doServerDataMessage("getprice",{clientid:c,productid:b.id,qty:a},{type:"refresh",rowindex:f})})})}function aa(b){doGridGetSelectedRowData("divOrderNewProductsG",
function(a,f){var c=doGetComboTreeSelectedId("cbNewOrderClients");doGridGetEditor("divOrderNewProductsG",f,"productid",function(a){a=$(a.target).combobox("getValue");doServerDataMessage("getprice",{clientid:c,productid:a,qty:b},{type:"refresh",rowindex:f})})})}function u(){doGridCalcTotals("divOrderNewProductsG","price","qty","discount","expressfee")}function ba(){var b=doGetComboTreeSelectedId("cbNewOrderClients");doDlgProductSelect(b,!0,!1,function(a,b,c,K,e){r?($("#divOrderNewProductsG").datagrid("appendRow",
{id:a,productid:a,qty:c,price:K,isrepeat:e}),u()):(b=$("#cbNewOrderVersions").combobox("getValue"),doServerDataMessage("neworderdetail",{orderid:d,version:b,productid:a,qty:c,price:K,discount:null,expressfee:null},{type:"refresh"}))})}function ca(){doGridGetSelectedRowData("divOrderNewProductsG",function(b){doGridStartEdit("divOrderNewProductsG",e,function(a,b){e=b;doGridGetEditor("divOrderNewProductsG",e,"price",function(a){})})})}function da(){doGridEndEditGetRow("divOrderNewProductsG",e,function(b){if(r)u();
else{var a=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("saveorderdetail",{orderdetailid:b.id,productid:b.productid,price:b.price,qty:b.qty,discount:b.discount,expressfee:b.expressfee,isrepeat:b.isrepeat,version:a},{type:"refresh"})}});e=null}function ea(){doGridGetSelectedRowData("divOrderNewProductsG",function(b){doPromptOkCancel("Remove "+doGetCodeFromIdInObjArray(cache_products,b.productid)+"?",function(a){a&&(r?(doGridRemoveRow("divOrderNewProductsG",b),u()):doServerDataMessage("expireorderdetail",
{orderdetailid:b.id},{type:"refresh"}))})})||doShowError("Please select a product to remove")}function A(b,a){0<a.data.rs.length&&(b=a.data.rs[0],a="P.O. ["+b.pono+"] belongs to order ["+b.orderno+"]",_.isUndefined(b.clientname)||(a+=" for client ["+b.clientname+"]"),doShowError(a))}function v(b,a){$("#dlgOrderNew").dialog("close")}function B(b,a){doGridGetEditor("divOrderNewProductsG",a.pdata.rowindex,"price",function(b){doGridGetEditor("divOrderNewProductsG",a.pdata.rowindex,"taxcodeid",function(c){doGridGetEditor("divOrderNewProductsG",
a.pdata.rowindex,"qty",function(f){var d=$(f.target).numberbox("getValue");if(!_.isNull(a.data.price.minqty)){var U=_.toBigNum(a.data.price.minqty);(_.isBlank(d)||U.greaterThan(d))&&$(f.target).numberbox("setValue",a.data.price.minqty)}$(b.target).numberbox("setValue",a.data.price.unitprice);$(c.target).combobox("setValue",a.data.price.taxcodeid)})})})}function C(b,a){switch(a.pdata.type){case "refresh":$("#fldNewOrderOrderName").textbox("setValue",a.data.client.name),$("#btnOrderNewAdd").linkbutton("enable");
case "invoiceto":$("#fldNewOrderName").textbox("setValue",a.data.client.name),$("#fldNewOrderAddress1").textbox("setValue",a.data.client.address1),$("#fldNewOrderAddress2").textbox("setValue",a.data.client.address2),$("#fldNewOrderAddress3").textbox("setValue",a.data.client.address3),$("#fldNewOrderAddress4").textbox("setValue",a.data.client.address4),$("#fldNewOrderCity").textbox("setValue",a.data.client.city),$("#fldNewOrderPostcode").textbox("setValue",a.data.client.postcode),$("#cbNewOrderCountry").combobox("setValue",
a.data.client.country),$("#cbNewOrderState").combobox("setValue",a.data.client.state);default:$("#fldNewOrderShiptoName").textbox("setValue",a.data.client.name),$("#fldNewOrderShiptoAddress1").textbox("setValue",_.isBlank(a.data.client.shipaddress1)?a.data.client.address1:a.data.client.shipaddress1),$("#fldNewOrderShiptoAddress2").textbox("setValue",_.isBlank(a.data.client.shipaddress2)?a.data.client.address2:a.data.client.shipaddress2),$("#fldNewOrderShiptoAddress3").textbox("setValue",_.isBlank(a.data.client.shipaddress3)?
a.data.client.address3:a.data.client.shipaddress3),$("#fldNewOrderShiptoAddress4").textbox("setValue",_.isBlank(a.data.client.shipaddress4)?a.data.client.address4:a.data.client.shipaddress4),$("#fldNewOrderShiptoCity").textbox("setValue",_.isBlank(a.data.client.shipcity)?a.data.client.city:a.data.client.shipcity),$("#fldNewOrderShiptoPostcode").textbox("setValue",_.isBlank(a.data.client.shippostcode)?a.data.client.postcode:a.data.client.shippostcode),$("#cbNewOrderShiptoCountry").textbox("setValue",
_.isBlank(a.data.client.shipcountry)?a.data.client.country:a.data.client.shipcountry),$("#cbNewOrderShiptoState").textbox("setValue",_.isBlank(a.data.client.shipstate)?a.data.client.state:a.data.client.shipstate)}}function fa(){doPromptOkCancel("Create new version from version "+c.activeversion+"?",function(b){b&&doServerDataMessage("newversionorder",{orderid:d,version:c.activeversion},{type:"refresh"})})}function D(b,a){_.isNull(d)||doServerDataMessage("loadorder",{orderid:d},{type:"refresh"})}function E(b,
a){c=a.data.order;x()}function F(b,a){$("#divOrderNewProductsG").datagrid("loadData",a.data.rs);u()}function p(){var b=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("listorderdetails",{orderid:d,version:b},{type:"refresh"})}function ha(b){doGridGetSelectedRowData("divOrderNewProductsG",function(a,c){a=$("#divOrderNewProductsG").datagrid("getEditors",c);c=$(a[4].target).numberbox("getValue");0==b||_.isBlank(b)||0==c||_.isBlank(c)||($(a[4].target).numberbox("clear"),doShowWarning("You can't have a fee and discount..."))})}
function ia(b){doGridGetSelectedRowData("divOrderNewProductsG",function(a,c){a=$("#divOrderNewProductsG").datagrid("getEditors",c);c=$(a[3].target).numberbox("getValue");0==b||_.isBlank(b)||0==c||_.isBlank(c)||($(a[3].target).numberbox("clear"),doShowWarning("You can't have a discount and fee..."))})}function G(b,a){doServerDataMessage("listorderstatuses",{orderid:d},{type:"refresh",orderstatusid:a.data.orderstatusid})}function H(b,a){"new"==a?ba():"clear"==a?$("#divOrderNewProductsG").datagrid("clearSelections"):
"edit"==a?ca():"cancel"==a?e=doGridCancelEdit("divOrderNewProductsG",e):"save"==a?da():"remove"==a&&ea()}function I(b,a){"new"==a?doServerDataMessage("newordernote",{orderid:d},{type:"refresh"}):"clear"==a?$("#divNewOrderNotesG").datagrid("clearSelections"):"edit"==a?Q():"cancel"==a?R():"save"==a?M():"remove"==a?S():"search"==a&&T()}function N(b,a){"clear"==a?$("#divNewOrderAttachmentsG").datagrid("clearSelections"):"edit"==a?V():"cancel"==a?m=doGridCancelEdit("divNewOrderAttachmentsG",e):"save"==
a?W():"remove"==a?X():"download"==a&&Y()}var r=_.isUndefined(d)||_.isNull(d),e=null,c={},O=[],w=[],t=[],k=null,q=null,n=null,g=null,m=null,P="";P=r?J?"New Quote":"New Order":J?"Modify Quote":"Modify Order";$("#divEvents").on("newordernote",l);$("#divEvents").on("saveordernote",l);$("#divEvents").on("ordernotecreated",l);$("#divEvents").on("ordernotesaved",l);$("#divEvents").on("listordernotes",y);$("#divEvents").on("listorderattachments",z);$("#divEvents").on("orderattachmentcreated",h);$("#divEvents").on("orderattachmentsaved",
h);$("#divEvents").on("orderattachmentexpired",h);$("#divEvents").on("saveorderattachment",h);$("#divEvents").on("expireorderattachment",h);$("#divEvents").on("checkorderpo",A);$("#divEvents").on("neworder",v);$("#divEvents").on("saveorder",v);$("#divEvents").on("getprice",B);$("#divEvents").on("loadorder",E);$("#divEvents").on("loadclient",C);$("#divEvents").on("listorderdetails",F);$("#divEvents").on("saveorderdetail",p);$("#divEvents").on("neworderdetail",p);$("#divEvents").on("expireorderdetail",
p);$("#divEvents").on("newversionorder",D);$("#divEvents").on("listorderstatuses",function(b,a){var c=[];$("#cbNewOrderStatusesStatus").combobox("clear");$("#fldNewOrderStatusesConnote").textbox("clear");$("#fldNewOrderStatusesCarrier").textbox("clear");$("#fldNewOrderStatusesComment").textbox("clear");$("#fldNewOrderStatusesBatchno").textbox("clear");a.data.rs.forEach(function(a){c.push({id:doNiceId(a.id),status:a.status,carriername:doNiceString(a.carriername),connote:doNiceString(a.connote),comments:doNiceString(a.comments),
batchno:doNiceString(a.batchno),date:doNiceDateModifiedOrCreated(a.datemodified,a.datecreated),by:doNiceModifiedBy(a.datemodified,a.usermodified,a.usercreated)})});$("#divNewOrderStatusesG").datagrid("loadData",c);_.isUndefined(a.pdata.orderstatusid)||_.isNull(a.pdata.orderstatusid)||$("#divNewOrderStatusesG").datagrid("selectRecord",a.pdata.orderstatusid)});$("#divEvents").on("neworderstatus",G);$("#divEvents").on("orderstatuscreated",G);$("#divEvents").on("ordernewpopup",H);$("#divEvents").on("ordernotespopup",
I);$("#divEvents").on("orderattachmentspopup",N);$("#divEvents").on("orderstatuspopup",function(b,a){if("new"==a){b=$("#cbNewOrderStatusesStatus").combobox("getValue");a=$("#fldNewOrderStatusesConnote").textbox("getValue");var c=$("#fldNewOrderStatusesCarrier").textbox("getValue"),e=$("#fldNewOrderStatusesComment").textbox("getValue"),K=$("#fldNewOrderStatusesBatchno").textbox("getValue");_.isBlank(b)&&(b=0);doServerDataMessage("neworderstatus",{orderid:d,status:b,connote:a,carrier:c,comment:e,batchno:K},
{type:"refresh"})}else"clear"==a&&$("#divNewOrderStatusesG").datagrid("clearSelections")});$("#dlgOrderNew").dialog({title:P,onClose:function(){$("#divEvents").off("newordernote",l);$("#divEvents").off("saveordernote",l);$("#divEvents").off("ordernotecreated",l);$("#divEvents").off("ordernotesaved",l);$("#divEvents").off("listordernotes",y);$("#divEvents").off("listorderattachments",z);$("#divEvents").off("orderattachmentcreated",h);$("#divEvents").off("orderattachmentsaved",h);$("#divEvents").off("orderattachmentexpired",
h);$("#divEvents").off("saveorderattachment",h);$("#divEvents").off("expireorderattachment",h);$("#divEvents").off("checkorderpo",A);$("#divEvents").off("neworder",v);$("#divEvents").off("saveorder",v);$("#divEvents").off("getprice",B);$("#divEvents").off("loadorder",E);$("#divEvents").off("loadclient",C);$("#divEvents").off("listorderdetails",F);$("#divEvents").off("saveorderdetail",p);$("#divEvents").off("neworderdetail",p);$("#divEvents").off("expireorderdetail",p);$("#divEvents").off("newversionorder",
D);$("#divEvents").off("ordernewpopup",H);$("#divEvents").off("ordernotespopup",I);$("#divEvents").off("orderattachmentspopup",N)},onOpen:function(){selectedOrderIdAttachmentId=d;$("#cbNewOrderClients").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(b){doServerDataMessage("loadclient",{clientid:b.id},{type:"refresh"})}});$("#cbNewOrderVersions").combobox({valueField:"name",textField:"name",data:t,limitToList:!0,onSelect:function(b){doServerDataMessage("listorderdetails",
{orderid:d,version:b.name},{type:"refresh"})}});$("#cbNewOrderInvoiceAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(b){doServerDataMessage("loadclient",{clientid:b.id},{type:"invoiceto"})}});$("#cbNewOrderShiptoAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(b){doServerDataMessage("loadclient",{clientid:b.id},{type:"shipto"})}});$("#cbNewOrderCountry").combobox({valueField:"country",
textField:"country",data:cache_countries,limitToList:!0,onSelect:function(b){O=doGetStatesFromCountry(b.country);$("#cbNewOrderState").combobox("loadData",O)}});$("#cbNewOrderState").combobox({valueField:"state",textField:"state",data:w,limitToList:!0});$("#cbNewOrderShiptoCountry").combobox({valueField:"country",textField:"country",data:cache_countries,limitToList:!0,onSelect:function(b){w=doGetStatesFromCountry(b.country);$("#cbNewOrderShiptoState").combobox("loadData",w)}});$("#cbNewOrderShiptoState").combobox({valueField:"state",
textField:"state",data:w,limitToList:!0});$("#cbNewOrderTemplateQuote").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0});$("#cbNewOrderTemplateOrder").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0});$("#cbNewOrderTemplateInvoice").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0});$("#fldNewOrderPONo").textbox({onChange:function(b,a){_.isBlank(b)||b!=a&&doServerDataMessage("checkorderpo",
{orderid:d,pono:b},{type:"refresh"})}});$("#dtNewOrderStartDate").datebox();$("#dtNewOrderEndDate").datebox();$("#cbNewOrderStatusesStatus").combobox({valueField:"id",textField:"name",data:orderstatustypes});$("#divOrderNewProductsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbOrderNew",showFooter:!0,columns:[[{title:"Product",field:"productid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",groupField:"productcategoryname",
data:cache_products,onSelect:function(b){Z(b)}}},formatter:function(b,a){return doGetCodeFromIdInObjArray(cache_products,b)}},{title:"Price",field:"price",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4}},formatter:function(b,a,c){return _.isUndefined(a.id)?b:_.niceformatnumber(b)}},{title:"Qty",field:"qty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4,onChange:function(b,a){_.isNull(a)||
b==a||aa(b)}}},formatter:function(b,a,c){return _.isUndefined(a.id)?b:_.niceformatqty(b)}},{title:"Discount",field:"discount",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2,onChange:function(b,a){ha(b)}}},formatter:function(b,a,c){return _.isUndefined(a.id)?b:_.niceformatnumber(b)}},{title:"Express Fee",field:"expressfee",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2,onChange:function(b,
a){ia(b)}}},formatter:function(b,a,c){return _.isUndefined(a.id)?b:_.niceformatnumber(b)}},{title:"Tax Code",field:"taxcodeid",width:100,align:"right",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",data:cache_taxcodes}},formatter:function(b,a){return doGetCodeFromIdInObjArray(cache_taxcodes,b)}},{title:"Repeat?",field:"isrepeat",width:80,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(b,a){if(!_.isUndefined(b))return mapBoolToImage(b)}}]],
onRowContextMenu:function(b,a,c){doGridContextMenu("divOrderNewProductsG","divOrderNewMenuPopup",b,a,c)},onDblClickCell:function(b,a,c){doGridGetSelectedRowData("divOrderNewProductsG",function(b){doGridStartEdit("divOrderNewProductsG",e,function(b,c){e=c;-1!=["modified","by"].indexOf(a)&&(a="price");doGridGetEditor("divOrderNewProductsG",e,a,function(a){})})})}});$("#divNewOrderNotesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,toolbar:"#tbOrderNotes",data:[],view:$.extend({},
$.fn.datagrid.defaults.view,{renderRow:function(b,a,c,d,e){b=[];!c&&e.id?b.push('<td style="width: 950px;; padding: 5px 5px; border: 0;">  <div style="float: left; margin-left: 10px;">    <p><span class="c-label">Modified: </span>'+e.date+'</p>    <p><span class="c-label">By: </span>'+e.by+'</p>  </div>  <div style="clear: both;"></div>  <div id="divOrderNote-id-'+e.id+'" style="float: left; margin-left: 10px; margin-right: 10px; width: 100%; height: 100px; border: 1px dashed #ddd">'+e.notes+"</div> </td>"):
b.push('<td style="width: 100%; padding: 5px 5px; border: 0;"></td>');return b.join("")}}),onDblClickRow:function(b,a){_.isNull(k)&&a&&(k=b,g="divOrderNote-id-"+a.id,q=$("#"+g).html(),n=(new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"})).panelInstance(g,{hasPanel:!0}))}});$("#divNewOrderAttachmentsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:"#tbOrderAttachments",columns:[[{title:"Name",field:"name",width:200,align:"left",resizable:!0},
{title:"Description",field:"description",width:300,align:"left",resizable:!0,editor:"text"},{title:"Type",field:"mimetype",width:100,align:"center",resizable:!0},{title:"Size",field:"size",width:150,align:"right",resizable:!0,formatter:function(b,a){return filesize(b,{base:10})}},{title:"Thumbnail",field:"isthumbnail",width:150,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(b,a){return mapBoolToImage(b)}},{title:"Image",field:"image",width:50,align:"center",
resizable:!0},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(b,a,c){doGridContextMenu("divNewOrderAttachmentsG","divOrderAttachmentsMenuPopup",b,a,c)},onDblClickCell:function(b,a,c){doGridStartEdit("divNewOrderAttachmentsG",m,function(a,b){m=b;doGridGetEditor("divNewOrderAttachmentsG",m,"description",function(a){})})}});$("#divNewOrderStatusesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,
rownumbers:!1,striped:!0,toolbar:"#tbOrderStatuses",frozenColumns:[[{title:"Status",field:"status",width:200,align:"left",resizable:!0,formatter:function(b,a){return doGetStringFromIdInObjArray(orderstatustypes,b)}}]],columns:[[{title:"Con Note",field:"connote",width:200,align:"left",resizable:!0},{title:"Carrier",field:"carriername",width:150,align:"left",resizable:!0},{title:"Comments",field:"comments",width:200,align:"left",resizable:!0},{title:"Batch No.",field:"batchno",width:150,align:"left",
resizable:!0},{title:"Modified",field:"date",width:150,align:"left",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(b,a,c){doGridContextMenu("divNewOrderStatusesG","divOrderStatusesMenuPopup",b,a,c)},onDblClickCell:function(b,a,c){}});r?$("#btnOrderNewAdd").linkbutton({text:"Add"}):$("#btnOrderNewAdd").linkbutton({text:"Save"});_.isNull(d)?x():(doServerDataMessage("loadorder",{orderid:d},{type:"refresh"}),doServerDataMessage("listorderattachments",
{orderid:d},{type:"refresh"}),doServerDataMessage("listorderstatuses",{orderid:d},{type:"refresh"}),doServerDataMessage("listordernotes",{orderid:d},{type:"refresh"}));$("#newordertabs").tabs({selected:0});myperms.cancreateorders||($("#btnOrderNewAdd").css("display","none"),$("#btnOrderNewVersion").css("display","none"))},buttons:[{text:"Add",disabled:!0,id:"btnOrderNewAdd",handler:function(){var b=$("#fldNewOrderPONo").textbox("getValue"),a=$("#fldNewOrderOrderName").textbox("getValue"),c=$("#cbNewOrderClients").combotree("getValue"),
e=$("#fldNewOrderFreight").numberbox("getValue"),g=$("#fldNewOrderName").textbox("getValue"),h=$("#fldNewOrderAddress1").textbox("getValue"),k=$("#fldNewOrderAddress2").textbox("getValue"),l=$("#fldNewOrderAddress3").textbox("getValue"),m=$("#fldNewOrderAddress4").textbox("getValue"),n=$("#fldNewOrderCity").textbox("getValue"),p=$("#fldNewOrderPostcode").textbox("getValue"),q=$("#cbNewOrderCountry").combobox("getValue"),t=$("#cbNewOrderState").combobox("getValue"),u=$("#fldNewOrderShiptoName").textbox("getValue"),
v=$("#fldNewOrderShiptoAddress1").textbox("getValue"),w=$("#fldNewOrderShiptoAddress2").textbox("getValue"),x=$("#fldNewOrderShiptoAddress3").textbox("getValue"),y=$("#fldNewOrderShiptoAddress4").textbox("getValue"),z=$("#fldNewOrderShiptoCity").textbox("getValue"),A=$("#fldNewOrderShiptoPostcode").textbox("getValue"),B=$("#cbNewOrderShiptoCountry").combobox("getValue"),C=$("#cbNewOrderShiptoState").combobox("getValue"),D=$("#fldNewOrderShiptoNote").textbox("getValue"),E=$("#dtNewOrderStartDate").datebox("getValue"),
F=$("#dtNewOrderEndDate").datebox("getValue"),G=$("#cbNewOrderTemplateQuote").combobox("getValue"),H=$("#cbNewOrderTemplateOrder").combobox("getValue"),I=$("#cbNewOrderTemplateInvoice").combobox("getValue"),L=$("#divOrderNewProductsG").datagrid("getData");_.isBlank(b)&&_.isBlank(a)&&_.isBlank(c)?doMandatoryTextbox("Need at least a P.O. number or name","fldNewOrderPONo"):r?doServerDataMessage("neworder",{isquote:J,name:a,pono:b,clientid:c,startdate:E,enddate:F,invoicetoname:g,address1:h,address2:k,
address3:l,address4:m,city:n,postcode:p,country:q,state:t,shiptoname:u,shiptoaddress1:v,shiptoaddress2:w,shiptoaddress3:x,shiptoaddress4:y,shiptocity:z,shiptopostcode:A,shiptocountry:B,shiptostate:C,shiptonote:D,quotetemplateid:G,ordertemplateid:H,invoicetemplateid:I,freightprice:e,products:L.rows},{type:"refresh"}):(L=$("#cbNewOrderVersions").combobox("getValue"),M(),doServerDataMessage("saveorder",{orderid:d,clientid:c,name:a,pono:b,activeversion:L,startdate:E,enddate:F,invoicetoname:g,address1:h,
address2:k,address3:l,address4:m,city:n,postcode:p,country:q,state:t,shiptoname:u,shiptoaddress1:v,shiptoaddress2:w,shiptoaddress3:x,shiptoaddress4:y,shiptocity:z,shiptopostcode:A,shiptocountry:B,shiptostate:C,shiptonote:D,quotetemplateid:G,ordertemplateid:H,invoicetemplateid:I,freightprice:e},{type:"refresh"}))}},{text:"New Version",id:"btnOrderNewVersion",handler:function(){fa()}},{text:"Reset",handler:function(){x()}},{text:"Close",handler:function(){$("#dlgOrderNew").dialog("close")}}]}).dialog("center").dialog("open")}
;
