var selectedOrderIdAttachmentId=null;function doDlgOrderNew(A,P){var k=_.isUndefined(P)||_.isNull(P),d=null,r={},t=[],o=[],i=[],a=null,n=null,s=null,l=null,c=null,e="";function M(){doGridEndEditGetRow("divNewOrderNotesG",a,function(e){var t=nicEditors.findEditor(l).getContent();doServerDataMessage("saveordernote",{ordernoteid:e.id,notes:t},{type:"refresh"}),s.removeInstance(l),a=s=n=null})}function u(e,t){P==t.data.orderid&&doServerDataMessage("listordernotes",{orderid:P},{ordernoteid:t.data.ordernoteid,type:"refresh"})}function b(e,t){var r=[];t.data.rs.forEach(function(e){r.push({id:doNiceId(e.id),notes:doNiceString(e.notes),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewOrderNotesG").datagrid("loadData",r),_.isUndefined(t.pdata.ordernoteid)||_.isNull(t.pdata.ordernoteid)||$("#divNewOrderNotesG").datagrid("selectRecord",t.pdata.ordernoteid)}function f(e,t){P==t.data.orderid&&doServerDataMessage("listorderattachments",{orderid:P},{type:"refresh"})}function p(e,t){var r=[];t.data.rs.forEach(function(e){var t=_.isNull(e.image)||_.isUndefined(e.image)?"":'<image src="'+e.image+'" width="35px">';r.push({id:doNiceId(e.id),name:doNiceString(e.name),description:doNiceString(e.description),mimetype:'<a href="javascript:void(0);" onClick="doThrowOrderAttachment('+e.id+');">'+mapMimeTypeToImage(e.mimetype)+"</a>",size:doNiceString(e.size),isthumbnail:e.isthumbnail,image:t,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewOrderAttachmentsG").datagrid("loadData",r)}function w(){if($("#cbNewOrderInvoiceAddress").combotree("clear"),$("#cbNewOrderShiptoAddress").combotree("clear"),$("#divOrderNewProductsG").datagrid("loadData",[]),$("#cbNewOrderStatusesStatus").combobox("clear"),$("#fldNewOrderStatusesConnote").textbox("clear"),$("#fldNewOrderStatusesCarrier").textbox("clear"),$("#fldNewOrderStatusesComment").textbox("clear"),$("#fldNewOrderStatusesBatchno").textbox("clear"),k)$("#fldNewOrderPONo").textbox("clear"),$("#fldNewOrderOrderName").textbox("clear"),$("#cbNewOrderClients").combotree("clear"),$("#cbNewOrderVersions").combobox("clear"),$("#fldNewOrderFreight").numberbox("clear"),$("#fldNewOrderName").textbox("clear"),$("#fldNewOrderAddress1").textbox("clear"),$("#fldNewOrderAddress2").textbox("clear"),$("#fldNewOrderAddress3").textbox("clear"),$("#fldNewOrderAddress4").textbox("clear"),$("#fldNewOrderCity").textbox("clear"),$("#fldNewOrderPostcode").textbox("clear"),$("#cbNewOrderCountry").combobox("clear"),$("#cbNewOrderState").combobox("clear"),$("#fldNewOrderShiptoName").textbox("clear"),$("#fldNewOrderShiptoAddress1").textbox("clear"),$("#fldNewOrderShiptoAddress2").textbox("clear"),$("#fldNewOrderShiptoAddress3").textbox("clear"),$("#fldNewOrderShiptoAddress4").textbox("clear"),$("#fldNewOrderShiptoCity").textbox("clear"),$("#fldNewOrderShiptoPostcode").textbox("clear"),$("#cbNewOrderShiptoCountry").combobox("clear"),$("#cbNewOrderShiptoState").combobox("clear"),$("#fldNewOrderShiptoNote").textbox("clear"),$("#cbNewOrderCountry").combobox("setValue",defaultCountry),$("#cbNewOrderShiptoCountry").combobox("setValue",defaultCountry),$("#cbNewOrderTemplateQuote").combobox("clear"),$("#cbNewOrderTemplateOrder").combobox("clear"),$("#cbNewOrderTemplateInvoice").combobox("clear"),$("#dtNewOrderStartDate").datebox("clear"),$("#dtNewOrderEndDate").datebox("clear"),$("#btnOrderNewAdd").linkbutton("disable"),$("#tbOrderNewNew").linkbutton("enable"),$("#tbOrderNewClear").linkbutton("enable"),$("#tbOrderNewEdit").linkbutton("enable"),$("#tbOrderNewCancel").linkbutton("enable"),$("#tbOrderNewSave").linkbutton("enable"),$("#tbOrderNewRemove").linkbutton("enable"),$("#cbNewOrderClients").combotree("enable"),$("#fldNewOrderPONo").textbox("enable"),$("#fldNewOrderOrderName").textbox("enable");else if(!_.isEmpty(r)){var e=A?r.quoteno:r.orderno;$("#fldNewOrderPONo").textbox("setValue",r.pono),$("#fldNewOrderOrderName").textbox("setValue",r.name),$("#cbNewOrderClients").combotree("setValue",r.clientid),$("#fldNewOrderFreight").numberbox("setValue",r.freightprice),i=[];for(var t=1;t<=r.numversions;t++)i.push({name:t});$("#cbNewOrderVersions").combobox("loadData",i),$("#cbNewOrderVersions").combobox("setValue",r.activeversion),$("#fldNewOrderName").textbox("setValue",r.invoicetoname),$("#fldNewOrderAddress1").textbox("setValue",r.invoicetoaddress1),$("#fldNewOrderAddress2").textbox("setValue",r.invoicetoaddress2),$("#fldNewOrderAddress3").textbox("setValue",r.invoicetoaddress3),$("#fldNewOrderAddress4").textbox("setValue",r.invoicetoaddress4),$("#fldNewOrderCity").textbox("setValue",r.invoicetocity),$("#fldNewOrderPostcode").textbox("setValue",r.invoicetopostcode),$("#cbNewOrderCountry").combobox("setValue",r.invoicetocountry),$("#cbNewOrderState").combobox("setValue",r.invoicetostate),$("#fldNewOrderShiptoName").textbox("setValue",r.shiptoname),$("#fldNewOrderShiptoAddress1").textbox("setValue",r.shiptoaddress1),$("#fldNewOrderShiptoAddress2").textbox("setValue",r.shiptoaddress2),$("#fldNewOrderShiptoAddress3").textbox("setValue",r.shiptoaddress3),$("#fldNewOrderShiptoAddress4").textbox("setValue",r.shiptoaddress4),$("#fldNewOrderShiptoCity").textbox("setValue",r.shiptocity),$("#fldNewOrderShiptoPostcode").textbox("setValue",r.shiptopostcode),$("#cbNewOrderShiptoCountry").combobox("setValue",r.shiptocountry),$("#cbNewOrderShiptoState").combobox("setValue",r.shiptostate),$("#fldNewOrderShiptoNote").textbox("setValue",r.shiptonote),$("#cbNewOrderTemplateQuote").combobox("setValue",r.quotetemplateid),$("#cbNewOrderTemplateOrder").combobox("setValue",r.ordertemplateid),$("#cbNewOrderTemplateInvoice").combobox("setValue",r.invoicetemplateid),$("#dtNewOrderStartDate").datebox("setValue",r.startdate),$("#dtNewOrderEndDate").datebox("setValue",r.enddate),_.isBlank(r.invoiceno)?($("#fldNewOrderPONo").textbox("enable"),$("#fldNewOrderOrderName").textbox("enable"),$("#btnOrderNewAdd").linkbutton("enable"),$("#tbOrderNewNew").linkbutton("enable"),$("#tbOrderNewClear").linkbutton("enable"),$("#tbOrderNewEdit").linkbutton("enable"),$("#tbOrderNewCancel").linkbutton("enable"),$("#tbOrderNewSave").linkbutton("enable"),$("#tbOrderNewRemove").linkbutton("enable")):($("#fldNewOrderPONo").textbox("disable"),$("#fldNewOrderOrderName").textbox("disable"),$("#btnOrderNewAdd").linkbutton("disable"),$("#tbOrderNewNew").linkbutton("disable"),$("#tbOrderNewClear").linkbutton("disable"),$("#tbOrderNewEdit").linkbutton("disable"),$("#tbOrderNewCancel").linkbutton("disable"),$("#tbOrderNewSave").linkbutton("disable"),$("#tbOrderNewRemove").linkbutton("disable")),$("#cbNewOrderClients").combotree("disable"),$("#dlgOrderNew").dialog("setTitle","Modify "+e+", version "+r.activeversion),doServerDataMessage("listorderdetails",{orderid:P,version:r.activeversion},{type:"refresh"})}doTextboxFocus("fldNewOrderPONo")}function v(){doGridCalcTotals("divOrderNewProductsG","price","qty","discount","expressfee")}function N(e,t){if(0<t.data.rs.length){var r=t.data.rs[0],d="P.O. ["+r.pono+"] belongs to order ["+r.orderno+"]";_.isUndefined(r.clientname)||(d+=" for client ["+r.clientname+"]"),doShowError(d)}}function m(e,t){$("#dlgOrderNew").dialog("close")}function x(e,i){doGridGetEditor("divOrderNewProductsG",i.pdata.rowindex,"price",function(o){doGridGetEditor("divOrderNewProductsG",i.pdata.rowindex,"taxcodeid",function(d){doGridGetEditor("divOrderNewProductsG",i.pdata.rowindex,"qty",function(e){var t=$(e.target).numberbox("getValue");if(!_.isNull(i.data.price.minqty)){var r=_.toBigNum(i.data.price.minqty);(_.isBlank(t)||r.greaterThan(t))&&$(e.target).numberbox("setValue",i.data.price.minqty)}$(o.target).numberbox("setValue",i.data.price.unitprice),$(d.target).combobox("setValue",i.data.price.taxcodeid)})})})}function O(e,t){switch(t.pdata.type){case"refresh":$("#fldNewOrderOrderName").textbox("setValue",t.data.client.name),$("#btnOrderNewAdd").linkbutton("enable");case"invoiceto":$("#fldNewOrderName").textbox("setValue",t.data.client.name),$("#fldNewOrderAddress1").textbox("setValue",t.data.client.address1),$("#fldNewOrderAddress2").textbox("setValue",t.data.client.address2),$("#fldNewOrderAddress3").textbox("setValue",t.data.client.address3),$("#fldNewOrderAddress4").textbox("setValue",t.data.client.address4),$("#fldNewOrderCity").textbox("setValue",t.data.client.city),$("#fldNewOrderPostcode").textbox("setValue",t.data.client.postcode),$("#cbNewOrderCountry").combobox("setValue",t.data.client.country),$("#cbNewOrderState").combobox("setValue",t.data.client.state);default:$("#fldNewOrderShiptoName").textbox("setValue",t.data.client.name),$("#fldNewOrderShiptoAddress1").textbox("setValue",_.isBlank(t.data.client.shipaddress1)?t.data.client.address1:t.data.client.shipaddress1),$("#fldNewOrderShiptoAddress2").textbox("setValue",_.isBlank(t.data.client.shipaddress2)?t.data.client.address2:t.data.client.shipaddress2),$("#fldNewOrderShiptoAddress3").textbox("setValue",_.isBlank(t.data.client.shipaddress3)?t.data.client.address3:t.data.client.shipaddress3),$("#fldNewOrderShiptoAddress4").textbox("setValue",_.isBlank(t.data.client.shipaddress4)?t.data.client.address4:t.data.client.shipaddress4),$("#fldNewOrderShiptoCity").textbox("setValue",_.isBlank(t.data.client.shipcity)?t.data.client.city:t.data.client.shipcity),$("#fldNewOrderShiptoPostcode").textbox("setValue",_.isBlank(t.data.client.shippostcode)?t.data.client.postcode:t.data.client.shippostcode),$("#cbNewOrderShiptoCountry").textbox("setValue",_.isBlank(t.data.client.shipcountry)?t.data.client.country:t.data.client.shipcountry),$("#cbNewOrderShiptoState").textbox("setValue",_.isBlank(t.data.client.shipstate)?t.data.client.state:t.data.client.shipstate)}}function h(e,t){_.isNull(P)||doServerDataMessage("loadorder",{orderid:P},{type:"refresh"})}function g(e,t){r=t.data.order,w()}function S(e,t){$("#divOrderNewProductsG").datagrid("loadData",t.data.rs),v()}function y(){var e=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("listorderdetails",{orderid:P,version:e},{type:"refresh"})}function G(e,t){doServerDataMessage("listorderstatuses",{orderid:P},{type:"refresh",orderstatusid:t.data.orderstatusid})}function V(e,t){var r;"new"==t?(r=doGetComboTreeSelectedId("cbNewOrderClients"),doDlgProductSelect(r,!0,!1,function(e,t,r,d,o){if(k)$("#divOrderNewProductsG").datagrid("appendRow",{id:e,productid:e,qty:r,price:d,isrepeat:o}),v();else{var i=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("neworderdetail",{orderid:P,version:i,productid:e,qty:r,price:d,discount:null,expressfee:null},{type:"refresh"})}})):"clear"==t?$("#divOrderNewProductsG").datagrid("clearSelections"):"edit"==t?doGridGetSelectedRowData("divOrderNewProductsG",function(e){doGridStartEdit("divOrderNewProductsG",d,function(e,t){d=t,doGridGetEditor("divOrderNewProductsG",d,"price",function(e){})})}):"cancel"==t?d=doGridCancelEdit("divOrderNewProductsG",d):"save"==t?(doGridEndEditGetRow("divOrderNewProductsG",d,function(e){if(k)v();else{var t=$("#cbNewOrderVersions").combobox("getValue");doServerDataMessage("saveorderdetail",{orderdetailid:e.id,productid:e.productid,price:e.price,qty:e.qty,discount:e.discount,expressfee:e.expressfee,isrepeat:e.isrepeat,version:t},{type:"refresh"})}}),d=null):"remove"==t&&(doGridGetSelectedRowData("divOrderNewProductsG",function(t){doPromptOkCancel("Remove "+doGetCodeFromIdInObjArray(cache_products,t.productid)+"?",function(e){e&&(k?(doGridRemoveRow("divOrderNewProductsG",t),v()):doServerDataMessage("expireorderdetail",{orderdetailid:t.id},{type:"refresh"}))})})||doShowError("Please select a product to remove"))}function E(e,t){"new"==t?doServerDataMessage("newordernote",{orderid:P},{type:"refresh"}):"clear"==t?$("#divNewOrderNotesG").datagrid("clearSelections"):"edit"==t?doGridGetSelectedRowData("divNewOrderNotesG",function(e,t){_.isNull(a)&&(a=t,l="divOrderNote-id-"+e.id,n=$("#"+l).html(),s=new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"}).panelInstance(l,{hasPanel:!0}))}):"cancel"==t?a=doGridCancelEdit("divNewOrderNotesG",a,function(){s.removeInstance(l),$("#"+l).html(n),s=n=null}):"save"==t?M():"remove"==t?doGridGetSelectedRowData("divNewOrderNotesG",function(t){doPromptOkCancel("Remove selected note?",function(e){e&&doServerDataMessage("expireorderote",{ordernoteid:t.id},{type:"refresh"})})})||doShowError("Please select a note to remove"):"search"==t&&doDlgNoteSearch(function(e){doServerDataMessage("searchordernote",{orderid:P,words:e},{type:"refresh"})},function(){doServerDataMessage("listordernotes",{orderid:P},{type:"refresh"})})}function C(e,t){"clear"==t?$("#divNewOrderAttachmentsG").datagrid("clearSelections"):"edit"==t?doGridStartEdit("divNewOrderAttachmentsG",d,function(e,t){c=t,doGridGetEditor("divNewOrderAttachmentsG",c,"description",function(e){})}):"cancel"==t?c=doGridCancelEdit("divNewOrderAttachmentsG",d):"save"==t?(doGridEndEditGetRow("divNewOrderAttachmentsG",c,function(e){doServerDataMessage("saveorderattachment",{orderattachmentid:e.id,description:e.description,isthumbnail:e.isthumbnail},{type:"refresh"})}),c=null):"remove"==t?doGridGetSelectedRowData("divNewOrderAttachmentsG",function(t){doPromptOkCancel("Remove attachment "+t.description+"?",function(e){e&&doServerDataMessage("expireorderattachment",{orderattachmentid:t.id},{type:"refresh"})})})||doShowError("Please select an attachment to remove"):"download"==t&&doGridGetSelectedRowData("divNewOrderAttachmentsG",function(e){doThrowOrderAttachment(e.id)})}e=k?A?"New Quote":"New Order":A?"Modify Quote":"Modify Order",$("#divEvents").on("newordernote",u),$("#divEvents").on("saveordernote",u),$("#divEvents").on("ordernotecreated",u),$("#divEvents").on("ordernotesaved",u),$("#divEvents").on("listordernotes",b),$("#divEvents").on("listorderattachments",p),$("#divEvents").on("orderattachmentcreated",f),$("#divEvents").on("orderattachmentsaved",f),$("#divEvents").on("orderattachmentexpired",f),$("#divEvents").on("saveorderattachment",f),$("#divEvents").on("expireorderattachment",f),$("#divEvents").on("checkorderpo",N),$("#divEvents").on("neworder",m),$("#divEvents").on("saveorder",m),$("#divEvents").on("getprice",x),$("#divEvents").on("loadorder",g),$("#divEvents").on("loadclient",O),$("#divEvents").on("listorderdetails",S),$("#divEvents").on("saveorderdetail",y),$("#divEvents").on("neworderdetail",y),$("#divEvents").on("expireorderdetail",y),$("#divEvents").on("newversionorder",h),$("#divEvents").on("listorderstatuses",function(e,t){var r=[];$("#cbNewOrderStatusesStatus").combobox("clear"),$("#fldNewOrderStatusesConnote").textbox("clear"),$("#fldNewOrderStatusesCarrier").textbox("clear"),$("#fldNewOrderStatusesComment").textbox("clear"),$("#fldNewOrderStatusesBatchno").textbox("clear"),t.data.rs.forEach(function(e){r.push({id:doNiceId(e.id),status:e.status,carriername:doNiceString(e.carriername),connote:doNiceString(e.connote),comments:doNiceString(e.comments),batchno:doNiceString(e.batchno),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewOrderStatusesG").datagrid("loadData",r),_.isUndefined(t.pdata.orderstatusid)||_.isNull(t.pdata.orderstatusid)||$("#divNewOrderStatusesG").datagrid("selectRecord",t.pdata.orderstatusid)}),$("#divEvents").on("neworderstatus",G),$("#divEvents").on("orderstatuscreated",G),$("#divEvents").on("ordernewpopup",V),$("#divEvents").on("ordernotespopup",E),$("#divEvents").on("orderattachmentspopup",C),$("#divEvents").on("orderstatuspopup",function(e,t){var r,d,o,i,a;"new"==t?(r=$("#cbNewOrderStatusesStatus").combobox("getValue"),d=$("#fldNewOrderStatusesConnote").textbox("getValue"),o=$("#fldNewOrderStatusesCarrier").textbox("getValue"),i=$("#fldNewOrderStatusesComment").textbox("getValue"),a=$("#fldNewOrderStatusesBatchno").textbox("getValue"),_.isBlank(r)&&(r=0),doServerDataMessage("neworderstatus",{orderid:P,status:r,connote:d,carrier:o,comment:i,batchno:a},{type:"refresh"})):"clear"==t&&$("#divNewOrderStatusesG").datagrid("clearSelections")}),$("#dlgOrderNew").dialog({title:e,onClose:function(){$("#divEvents").off("newordernote",u),$("#divEvents").off("saveordernote",u),$("#divEvents").off("ordernotecreated",u),$("#divEvents").off("ordernotesaved",u),$("#divEvents").off("listordernotes",b),$("#divEvents").off("listorderattachments",p),$("#divEvents").off("orderattachmentcreated",f),$("#divEvents").off("orderattachmentsaved",f),$("#divEvents").off("orderattachmentexpired",f),$("#divEvents").off("saveorderattachment",f),$("#divEvents").off("expireorderattachment",f),$("#divEvents").off("checkorderpo",N),$("#divEvents").off("neworder",m),$("#divEvents").off("saveorder",m),$("#divEvents").off("getprice",x),$("#divEvents").off("loadorder",g),$("#divEvents").off("loadclient",O),$("#divEvents").off("listorderdetails",S),$("#divEvents").off("saveorderdetail",y),$("#divEvents").off("neworderdetail",y),$("#divEvents").off("expireorderdetail",y),$("#divEvents").off("newversionorder",h),$("#divEvents").off("ordernewpopup",V),$("#divEvents").off("ordernotespopup",E),$("#divEvents").off("orderattachmentspopup",C)},onOpen:function(){selectedOrderIdAttachmentId=P,$("#cbNewOrderClients").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("loadclient",{clientid:e.id},{type:"refresh"})}}),$("#cbNewOrderVersions").combobox({valueField:"name",textField:"name",data:i,limitToList:!0,onSelect:function(e){doServerDataMessage("listorderdetails",{orderid:P,version:e.name},{type:"refresh"})}}),$("#cbNewOrderInvoiceAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("loadclient",{clientid:e.id},{type:"invoiceto"})}}),$("#cbNewOrderShiptoAddress").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("loadclient",{clientid:e.id},{type:"shipto"})}}),$("#cbNewOrderCountry").combobox({valueField:"country",textField:"country",data:cache_countries,limitToList:!0,onSelect:function(e){t=doGetStatesFromCountry(e.country),$("#cbNewOrderState").combobox("loadData",t)}}),$("#cbNewOrderState").combobox({valueField:"state",textField:"state",data:o,limitToList:!0}),$("#cbNewOrderShiptoCountry").combobox({valueField:"country",textField:"country",data:cache_countries,limitToList:!0,onSelect:function(e){o=doGetStatesFromCountry(e.country),$("#cbNewOrderShiptoState").combobox("loadData",o)}}),$("#cbNewOrderShiptoState").combobox({valueField:"state",textField:"state",data:o,limitToList:!0}),$("#cbNewOrderTemplateQuote").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0}),$("#cbNewOrderTemplateOrder").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0}),$("#cbNewOrderTemplateInvoice").combobox({valueField:"id",textField:"description",data:cache_printtemplates,limitToList:!0}),$("#fldNewOrderPONo").textbox({onChange:function(e,t){_.isBlank(e)||e!=t&&doServerDataMessage("checkorderpo",{orderid:P,pono:e},{type:"refresh"})}}),$("#dtNewOrderStartDate").datebox(),$("#dtNewOrderEndDate").datebox(),$("#cbNewOrderStatusesStatus").combobox({valueField:"id",textField:"name",data:orderstatustypes}),$("#divOrderNewProductsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbOrderNew",showFooter:!0,columns:[[{title:"Product",field:"productid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",groupField:"productcategoryname",data:cache_products,onSelect:function(e){var o;o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,r){var d=doGetComboTreeSelectedId("cbNewOrderClients");doGridGetEditor("divOrderNewProductsG",r,"productid",function(e){var t=$(e.target).numberbox("getValue");doServerDataMessage("getprice",{clientid:d,productid:o.id,qty:t},{type:"refresh",rowindex:r})})})}}},formatter:function(e,t){return doGetCodeFromIdInObjArray(cache_products,e)}},{title:"Price",field:"price",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4}},formatter:function(e,t,r){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Qty",field:"qty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:4,onChange:function(e,t){var o;_.isNull(t)||e==t||(o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,r){var d=doGetComboTreeSelectedId("cbNewOrderClients");doGridGetEditor("divOrderNewProductsG",r,"productid",function(e){var t=$(e.target).combobox("getValue");doServerDataMessage("getprice",{clientid:d,productid:t,qty:o},{type:"refresh",rowindex:r})})}))}}},formatter:function(e,t,r){return _.isUndefined(t.id)?e:_.niceformatqty(e)}},{title:"Discount",field:"discount",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2,onChange:function(e,t){var o;o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,t){var r=$("#divOrderNewProductsG").datagrid("getEditors",t),d=$(r[4].target).numberbox("getValue");0==o||_.isBlank(o)||0==d||_.isBlank(d)||($(r[4].target).numberbox("clear"),doShowWarning("You can't have a fee and discount..."))})}}},formatter:function(e,t,r){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Express Fee",field:"expressfee",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2,onChange:function(e,t){var o;o=e,doGridGetSelectedRowData("divOrderNewProductsG",function(e,t){var r=$("#divOrderNewProductsG").datagrid("getEditors",t),d=$(r[3].target).numberbox("getValue");0==o||_.isBlank(o)||0==d||_.isBlank(d)||($(r[3].target).numberbox("clear"),doShowWarning("You can't have a discount and fee..."))})}}},formatter:function(e,t,r){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Tax Code",field:"taxcodeid",width:100,align:"right",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",data:cache_taxcodes}},formatter:function(e,t){return doGetCodeFromIdInObjArray(cache_taxcodes,e)}},{title:"Repeat?",field:"isrepeat",width:80,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(e,t){if(!_.isUndefined(e))return mapBoolToImage(e)}}]],onRowContextMenu:function(e,t,r){doGridContextMenu("divOrderNewProductsG","divOrderNewMenuPopup",e,t,r)},onDblClickCell:function(e,r,t){doGridGetSelectedRowData("divOrderNewProductsG",function(e){doGridStartEdit("divOrderNewProductsG",d,function(e,t){d=t,-1!=["modified","by"].indexOf(r)&&(r="price"),doGridGetEditor("divOrderNewProductsG",d,r,function(e){})})})}}),$("#divNewOrderNotesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,toolbar:"#tbOrderNotes",data:[],view:$.extend({},$.fn.datagrid.defaults.view,{renderRow:function(e,t,r,d,o){var i=[];return!r&&o.id?i.push('<td style="width: 950px;; padding: 5px 5px; border: 0;">  <div style="float: left; margin-left: 10px;">    <p><span class="c-label">Modified: </span>'+o.date+'</p>    <p><span class="c-label">By: </span>'+o.by+'</p>  </div>  <div style="clear: both;"></div>  <div id="divOrderNote-id-'+o.id+'" style="float: left; margin-left: 10px; margin-right: 10px; width: 100%; height: 100px; border: 1px dashed #ddd">'+o.notes+"</div> </td>"):i.push('<td style="width: 100%; padding: 5px 5px; border: 0;"></td>'),i.join("")}}),onDblClickRow:function(e,t){_.isNull(a)&&t&&(a=e,l="divOrderNote-id-"+t.id,n=$("#"+l).html(),s=new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"}).panelInstance(l,{hasPanel:!0}))}}),$("#divNewOrderAttachmentsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:"#tbOrderAttachments",columns:[[{title:"Name",field:"name",width:200,align:"left",resizable:!0},{title:"Description",field:"description",width:300,align:"left",resizable:!0,editor:"text"},{title:"Type",field:"mimetype",width:100,align:"center",resizable:!0},{title:"Size",field:"size",width:150,align:"right",resizable:!0,formatter:function(e,t){return filesize(e,{base:10})}},{title:"Thumbnail",field:"isthumbnail",width:150,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(e,t){return mapBoolToImage(e)}},{title:"Image",field:"image",width:50,align:"center",resizable:!0},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,r){doGridContextMenu("divNewOrderAttachmentsG","divOrderAttachmentsMenuPopup",e,t,r)},onDblClickCell:function(e,t,r){doGridStartEdit("divNewOrderAttachmentsG",c,function(e,t){c=t,doGridGetEditor("divNewOrderAttachmentsG",c,"description",function(e){})})}}),$("#divNewOrderStatusesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:"#tbOrderStatuses",frozenColumns:[[{title:"Status",field:"status",width:200,align:"left",resizable:!0,formatter:function(e,t){return doGetStringFromIdInObjArray(orderstatustypes,e)}}]],columns:[[{title:"Con Note",field:"connote",width:200,align:"left",resizable:!0},{title:"Carrier",field:"carriername",width:150,align:"left",resizable:!0},{title:"Comments",field:"comments",width:200,align:"left",resizable:!0},{title:"Batch No.",field:"batchno",width:150,align:"left",resizable:!0},{title:"Modified",field:"date",width:150,align:"left",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,r){doGridContextMenu("divNewOrderStatusesG","divOrderStatusesMenuPopup",e,t,r)},onDblClickCell:function(e,t,r){}}),k?$("#btnOrderNewAdd").linkbutton({text:"Add"}):$("#btnOrderNewAdd").linkbutton({text:"Save"}),_.isNull(P)?w():(doServerDataMessage("loadorder",{orderid:P},{type:"refresh"}),doServerDataMessage("listorderattachments",{orderid:P},{type:"refresh"}),doServerDataMessage("listorderstatuses",{orderid:P},{type:"refresh"}),doServerDataMessage("listordernotes",{orderid:P},{type:"refresh"})),$("#newordertabs").tabs({selected:0}),myperms.cancreateorders||($("#btnOrderNewAdd").css("display","none"),$("#btnOrderNewVersion").css("display","none"))},buttons:[{text:"Add",disabled:!0,id:"btnOrderNewAdd",handler:function(){var e=$("#fldNewOrderPONo").textbox("getValue"),t=$("#fldNewOrderOrderName").textbox("getValue"),r=$("#cbNewOrderClients").combotree("getValue"),d=$("#fldNewOrderFreight").numberbox("getValue"),o=$("#fldNewOrderName").textbox("getValue"),i=$("#fldNewOrderAddress1").textbox("getValue"),a=$("#fldNewOrderAddress2").textbox("getValue"),n=$("#fldNewOrderAddress3").textbox("getValue"),s=$("#fldNewOrderAddress4").textbox("getValue"),l=$("#fldNewOrderCity").textbox("getValue"),c=$("#fldNewOrderPostcode").textbox("getValue"),u=$("#cbNewOrderCountry").combobox("getValue"),b=$("#cbNewOrderState").combobox("getValue"),f=$("#fldNewOrderShiptoName").textbox("getValue"),p=$("#fldNewOrderShiptoAddress1").textbox("getValue"),w=$("#fldNewOrderShiptoAddress2").textbox("getValue"),v=$("#fldNewOrderShiptoAddress3").textbox("getValue"),N=$("#fldNewOrderShiptoAddress4").textbox("getValue"),m=$("#fldNewOrderShiptoCity").textbox("getValue"),x=$("#fldNewOrderShiptoPostcode").textbox("getValue"),O=$("#cbNewOrderShiptoCountry").combobox("getValue"),h=$("#cbNewOrderShiptoState").combobox("getValue"),g=$("#fldNewOrderShiptoNote").textbox("getValue"),S=$("#dtNewOrderStartDate").datebox("getValue"),y=$("#dtNewOrderEndDate").datebox("getValue"),G=$("#cbNewOrderTemplateQuote").combobox("getValue"),V=$("#cbNewOrderTemplateOrder").combobox("getValue"),E=$("#cbNewOrderTemplateInvoice").combobox("getValue"),C=$("#divOrderNewProductsG").datagrid("getData");if(_.isBlank(e)&&_.isBlank(t)&&_.isBlank(r))doMandatoryTextbox("Need at least a P.O. number or name","fldNewOrderPONo");else if(k)doServerDataMessage("neworder",{isquote:A,name:t,pono:e,clientid:r,startdate:S,enddate:y,invoicetoname:o,address1:i,address2:a,address3:n,address4:s,city:l,postcode:c,country:u,state:b,shiptoname:f,shiptoaddress1:p,shiptoaddress2:w,shiptoaddress3:v,shiptoaddress4:N,shiptocity:m,shiptopostcode:x,shiptocountry:O,shiptostate:h,shiptonote:g,quotetemplateid:G,ordertemplateid:V,invoicetemplateid:E,freightprice:d,products:C.rows},{type:"refresh"});else{var D=$("#cbNewOrderVersions").combobox("getValue");M(),doServerDataMessage("saveorder",{orderid:P,clientid:r,name:t,pono:e,activeversion:D,startdate:S,enddate:y,invoicetoname:o,address1:i,address2:a,address3:n,address4:s,city:l,postcode:c,country:u,state:b,shiptoname:f,shiptoaddress1:p,shiptoaddress2:w,shiptoaddress3:v,shiptoaddress4:N,shiptocity:m,shiptopostcode:x,shiptocountry:O,shiptostate:h,shiptonote:g,quotetemplateid:G,ordertemplateid:V,invoicetemplateid:E,freightprice:d},{type:"refresh"})}}},{text:"New Version",id:"btnOrderNewVersion",handler:function(){doPromptOkCancel("Create new version from version "+r.activeversion+"?",function(e){e&&doServerDataMessage("newversionorder",{orderid:P,version:r.activeversion},{type:"refresh"})})}},{text:"Reset",handler:function(){w()}},{text:"Close",handler:function(){$("#dlgOrderNew").dialog("close")}}]}).dialog("center").dialog("open")}