function doDlgBuildTemplateDetails(o){var d=[],l=null,e=[{text:"New",iconCls:"icon-add",handler:i},{text:"Clear",iconCls:"icon-clear",handler:function(){$("#divBuildTemplateProductsG").datagrid("clearSelections")}},{text:"Edit",iconCls:"icon-edit",handler:a},{text:"Cancel",iconCls:"icon-cancel",handler:function(){l=doGridCancelEdit("divBuildTemplateProductsG",l)}},{text:"Save",iconCls:"icon-save",handler:function(){doGridEndEditGetRow("divBuildTemplateProductsG",l,function(e){var t=e.qty;1==e.pertemplateqty&&(t=_.toBigNum(t).ceil().toFixed(0),$("#divBuildTemplateProductsG").datagrid("updateRow",{index:l,row:{qty:t}})),primus.emit("savebuildtemplatedetail",{fguid:fguid,uuid:uuid,session:session,buildtemplatedetailid:e.id,productid:e.productid,taxcodeid:e.taxcodeid,price:e.price,qty:t,pertemplateqty:e.pertemplateqty,pdata:{type:"refresh"}})}),l=null}},{text:"Remove",iconCls:"icon-remove",handler:u},{text:"Sync Subtemplates",iconCls:"icon-sync",handler:function(){doPromptOkCancel("This will replace all products of all sub-templates with the products from this template. Are you sure?",function(e){e&&primus.emit("syncbuildtemplate",{fguid:fguid,uuid:uuid,session:session,buildtemplateid:o.id,pdata:{type:"refresh"}})})}}];function i(){doDlgProductSelect(viewingOrderClientId,!1,!1,function(e,t,i,d){primus.emit("newbuildtemplatedetail",{fguid:fguid,uuid:uuid,session:session,buildtemplateid:o.id,productid:e,qty:i,price:d,pdata:{type:"refresh"}})})}function a(){doGridStartEdit("divBuildTemplateProductsG",l,function(e,t){l=t,doGridGetEditor("divBuildTemplateProductsG",l,"name",function(e){})})}function u(){doGridGetSelectedRowData("divBuildTemplateProductsG",function(t){doPromptOkCancel("Remove "+doGetStringFromIdInObjArray(cache_products,t.productid)+"?",function(e){e&&primus.emit("expirebuildtemplatedetail",{fguid:fguid,uuid:uuid,session:session,buildtemplatedetailid:t.id,pdata:{type:"refresh"}})})})||noty({text:"Please select a product to remove",type:"error",timeout:4e3})}function t(e,t){t.data.buildtemplateid==o.id&&primus.emit("listproductsbybuildtemplate",{fguid:fguid,uuid:uuid,session:session,buildtemplateid:o.id,pdata:{type:"refresh"}})}function r(e,t){o.id&&(primus.emit("listproductsbybuildtemplate",{fguid:fguid,uuid:uuid,session:session,buildtemplateid:o.id,pdata:{type:"refresh",buildtemplatedetailid:t.data.buildtemplatedetailid}}),primus.emit("listbuildtemplates",{fguid:fguid,uuid:uuid,session:session,pdata:{type:"refresh"}}))}function n(e,t){o.id&&(d=[],t.data.rs.forEach(function(e){d.push({id:doNiceId(e.id),productid:doNiceId(e.productid),productcategoryid:doNiceId(e.productcategoryid),taxcodeid:doNiceId(e.taxcodeid),price:doNiceString(e.price),gst:doNiceString(e.gst),qty:doNiceString(e.qty),pertemplateqty:e.pertemplateqty,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divBuildTemplateProductsG").datagrid("loadData",d),doGridCalcTotals("divBuildTemplateProductsG","price","qty"),_.isUndefined(t.pdata.buildtemplatedetailid)||_.isNull(t.pdata.buildtemplatedetailid)||$("#divBuildTemplateProductsG").datagrid("selectRecord",t.pdata.buildtemplatedetailid))}function c(e,t){"new"==t?i():"edit"==t?a():"remove"==t?u():"viewproduct"==t&&doGridGetSelectedRowData("divBuildTemplateProductsG",function(e){doSelectInventoryTab(0),$("#divEvents").trigger("gotoproduct",{productcategoryid:e.productcategoryid,productid:e.productid}),$("#dlgBuildTemplateDetails").dialog("close")})}$("#divEvents").off("buildtemplatedetailcreated",t).on("buildtemplatedetailcreated",t),$("#divEvents").off("buildtemplatedetailsaved",t).on("buildtemplatedetailsaved",t),$("#divEvents").off("buildtemplatedetailexpired",t).on("buildtemplatedetailexpired",t),$("#divEvents").off("productupdated",t).on("productupdated",t),$("#divEvents").off("buildtemplatedetailupdated",r).on("buildtemplatedetailupdated",r),$("#divEvents").off("listproductsbybuildtemplate",n).on("listproductsbybuildtemplate",n),$("#divEvents").off("buildtemplatedetailspopup",c).on("buildtemplatedetailspopup",c),$("#dlgBuildTemplateDetails").dialog({title:"Build Template Details for "+o.name,onClose:function(){},onOpen:function(){primus.emit("listproductsbybuildtemplate",{fguid:fguid,uuid:uuid,session:session,buildtemplateid:o.id,pdata:{type:"refresh"}}),$("#divBuildTemplateProductsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:e,showFooter:!0,loader:function(e,t,i){t({total:d.length,rows:d})},columns:[[{title:"Product",field:"productid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"code",groupField:"productcategoryname",data:cache_products,onSelect:function(e){doGridChangeCellLabelValue("divBuildTemplateProductsG",l,"price",e.costprice)}}},formatter:function(e,t){return doGetCodeFromIdInObjArray(cache_products,e)}},{title:"Tax Code",field:"taxcodeid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{valueField:"id",textField:"name",data:cache_taxcodes,onSelect:function(e){}}},formatter:function(e,t){return doGetStringFromIdInObjArray(cache_taxcodes,e)}},{title:"Price",field:"price",width:100,align:"right",resizable:!0,editor:"label",formatter:function(e,t,i){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Qty",field:"qty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{precision:4}},formatter:function(e,t,i){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Whole/Tmpl",field:"pertemplateqty",width:100,align:"center",resizable:!0,editor:{type:"checkbox",options:{on:1,off:0}},formatter:function(e,t){return mapBoolToImage(e)}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,i){doGridContextMenu("divBuildTemplateProductsG","divBuildTemplatesDetailsMenuPopup",e,t,i)},onDblClickCell:function(e,i,t){doGridStartEdit("divBuildTemplateProductsG",l,function(e,t){l=t,-1!=["qty"].indexOf(i)&&(i="qty"),doGridGetEditor("divBuildTemplateProductsG",l,i,function(e){})})}}),$("#divBuildTemplateProductsG").datagrid("loadData",[])},buttons:[{text:"Close",handler:function(){$("#dlgBuildTemplateDetails").dialog("close")}}]}).dialog("center").dialog("open")}