var ordersTabWidgetsLoaded=!1,editingOrderIndex=null,orderInvoiceToStates=[],orderShipToStates=[],tbOrders=[{text:"New",iconCls:"icon-add",handler:doOrdersNew},{text:"Edit",iconCls:"icon-edit",handler:doOrdersEdit},{text:"Clear",iconCls:"icon-clear",handler:doOrdersClear},{text:"Cancel",iconCls:"icon-cancel",handler:doOrdersCancel},{text:"Save",iconCls:"icon-save",handler:doOrdersSave},{text:"Remove",iconCls:"icon-remove",handler:doOrdersRemove},{text:"Print",iconCls:"icon-print",handler:doOrdersPrint},{text:"Duplicate",iconCls:"icon-duplicate",handler:doOrdersDuplicate},{text:"Products",iconCls:"icon-orderform",handler:doOrdersProducts},{text:"Notes",iconCls:"icon-notes",handler:doOrdersNotes},{text:"Attachments",iconCls:"icon-attachment",handler:doOrdersAttachments},{text:"Search",iconCls:"icon-search",handler:doOrdersSearch},{text:"Pay",iconCls:"icon-creditcards",handler:doOrdersPay}];function doOrdersNew(){primus.emit("neworderclient",{fguid:fguid,uuid:uuid,session:session,name:"New Order",clientid:theclientid,pdata:{type:"doordersnew"}})}function doOrdersClear(){$("#divOrdersG").datagrid("clearSelections")}function doOrdersEdit(){doGridGetSelectedRowData("divOrdersG",function(e){_.isBlank(e.invoiceno)?doGridStartEdit("divOrdersG",editingOrderIndex,function(e,t){editingOrderIndex=t,doGridGetEditor("divOrdersG",editingOrderIndex,"name",function(e){})}):noty({text:"Unable to edit invoiced order",type:"warning",timeout:4e3})})}function doOrdersCancel(){editingOrderIndex=doGridCancelEdit("divOrdersG",editingOrderIndex)}function doOrdersSave(){doGridEndEditGetRow("divOrdersG",editingOrderIndex,function(e){primus.emit("saveorder",{fguid:fguid,uuid:uuid,session:session,orderid:e.id,clientid:e.clientid,startdate:e.startdate,enddate:e.enddate,name:e.name,pono:e.pono,activeversion:e.activeversion,accountid:e.accountid,invoicetoaddress1:e.invoicetoaddress1,invoicetoaddress2:e.invoicetoaddress2,invoicetocity:e.invoicetocity,invoicetostate:e.invoicetostate,invoicetopostcode:e.invoicetopostcode,invoicetocountry:e.invoicetocountry,shipaddress1:e.shiptoaddress1,shipaddress2:e.shiptoaddress2,shipcity:e.shiptocity,shipstate:e.shiptostate,shippostcode:e.shiptopostcode,shipcountry:e.shipctoountry,invoicetemplateid:e.invoicetemplateid,ordertemplateid:e.ordertemplateid,quotetemplateid:e.quotetemplateid,pdata:{type:"doorderssave"}})}),editingOrderIndex=null}function doOrdersRemove(){doGridGetSelectedRowData("divOrdersG",function(t){doPromptOkCancel("Remove order "+t.orderno+"?",function(e){e&&primus.emit("expireorder",{fguid:fguid,uuid:uuid,session:session,orderid:t.id,pdata:{type:"doordersremove"}})})})||noty({text:"Please select an order to remove",type:"error",timeout:4e3})}function doOrdersPrint(){doPrompt3OptionsCancel("Print As...","Quote","Order","Delivery Docket",function(e){1==e?doPromptYesNoCancel("Print all listed quotes (Yes) or selected only (No)?",function(e){!0===e?console.log("Print all listed quotes"):!1===e&&doGridGetSelectedRowData("divOrdersG",function(e){primus.emit("printquotes",{fguid:fguid,uuid:uuid,session:session,orders:[e.id],pdata:{type:"doordersprint"}})})}):2==e?doPromptYesNoCancel("Print all listed orders (Yes) or selected only (No)?",function(e){!0===e?console.log("Print all listed orders"):!1===e&&doGridGetSelectedRowData("divOrdersG",function(e){primus.emit("printorders",{fguid:fguid,uuid:uuid,session:session,orders:[e.id],pdata:{type:"doordersprint"}})})}):3==e&&(console.log("Quote"),doPromptYesNoCancel("Print all listed delivery dockets (Yes) or selected only (No)?",function(e){!0===e?console.log("Print all listed delivery dockets"):!1===e&&doGridGetSelectedRowData("divOrdersG",function(e){primus.emit("printdeliverydockets",{fguid:fguid,uuid:uuid,session:session,orders:[e.id],pdata:{type:"doordersprint"}})})}))})}function doOrdersDuplicate(){doGridGetSelectedRowData("divOrdersG",function(t){doPromptOkCancel("Duplicate order "+t.orderno+"?",function(e){e&&primus.emit("duplicateorder",{fguid:fguid,uuid:uuid,session:session,orderid:t.id,pdata:{type:"doordersduplicate"}})})})||noty({text:"Please select an order to duplicate",type:"error",timeout:4e3})}function doOrdersProducts(){doGridGetSelectedRowData("divOrdersG",function(e){doDlgOrderDetails(e)})||noty({text:"Please select an order to view",type:"error",timeout:4e3})}function doOrdersNotes(){doGridGetSelectedRowData("divOrdersG",function(e){doDlgOrderNotes(e)})||noty({text:"Please select an order to view",type:"error",timeout:4e3})}function doOrdersAttachments(){doGridGetSelectedRowData("divOrdersG",function(e){doDlgOrderAttachments(e)})||noty({text:"Please select an order to view",type:"error",timeout:4e3})}function doOrdersSearch(){doDlgOrderSearch()}function doOrdersPay(){doGridGetSelectedRowData("divOrdersG",function(e){doDlgOrdePay(e)})||noty({text:"Please select an order to pay",type:"error",timeout:4e3})}function doOrdersTabWidgets(){ordersTabWidgetsLoaded||($("#divEvents").on("new-client-order",function(e,t){primus.emit("neworderclient",{fguid:fguid,uuid:uuid,session:session,name:"New Order",clientid:t.id,pdata:{type:"doordersnew"}}),doSelectSalesTab(0)}),ordersTabWidgetsLoaded=!0,$("#divOrdersG").datagrid({idField:"id",fitColumns:!1,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:tbOrders,showFooter:!0,loader:function(e,t,i){var d=[],r=_.toBigNum(0),n=_.toBigNum(0);cache_orders.forEach(function(e){var t=null;if(_.isBlank(e.totalprice)||(r=r.plus(e.totalprice)),_.isBlank(e.totalqty)||(n=n.plus(e.totalqty)),!(_.isNull(e.startdate)||_.isBlank(e.startdate)||_.isNull(e.enddate)||_.isBlank(e.enddate))){var i=moment(e.enddate).diff(e.startdate,"days"),o=moment().diff(e.startdate,"days");t=Math.round(100*o/i)}d.push({id:e.id,clientid:e.clientid,orderno:e.orderno,invoiceno:e.invoiceno,name:e.name,pono:e.pono,numversions:e.numversions,activeversion:e.activeversion,status:e.status,majorstatus:e.majorstatus,accountid:e.accountid,totalprice:e.totalprice,totalqty:e.totalqty,startdate:_.nicedatetodisplay(e.startdate),enddate:_.nicedatetodisplay(e.enddate),shiptoclientid:e.shiptoclientid,shiptoname:e.shiptoname,shiptoaddress1:e.shiptoaddress1,shiptoaddress2:e.shiptoaddress2,shiptocity:e.shiptocity,shiptostate:e.shiptostate,shiptopostcode:e.shiptopostcode,shiptocountry:e.shiptocountry,invoicetoclientid:e.invoicetoclientid,invoicetoname:e.invoicetoname,invoicetoaddress1:e.invoicetoaddress1,invoicetoaddress2:e.invoicetoaddress2,invoicetocity:e.invoicetocity,invoicetostate:e.invoicetostate,invoicetopostcode:e.invoicetopostcode,invoicetocountry:e.invoicetocountry,invoicetemplateid:e.invoicetemplateid,ordertemplateid:e.ordertemplateid,quotetemplateid:e.quotetemplateid,inventorycommitted:e.inventorycommitted,modified:e.date,by:e.by,perc:t})}),t({total:d.length,rows:d}),$(this).datagrid("reloadFooter",[{name:'<span class="totals_footer">'+d.length+" order(s)</span>",totalprice:'<span class="totals_footer">'+_.formatnumber(r)+"</span>",totalqty:'<span class="totals_footer">'+_.formatnumber(n)+"</span>"}])},frozenColumns:[[{title:"Order #",rowspan:2,field:"orderno",width:150,align:"left",resizable:!0}],[]],columns:[[{title:"Name",rowspan:2,field:"name",width:300,align:"left",resizable:!0,editor:"text"},{title:"P.O.#",rowspan:2,field:"pono",width:150,align:"left",resizable:!0,editor:"text"},{title:"Version",rowspan:2,field:"activeversion",width:100,align:"right",resizable:!0},{title:"Status",rowspan:2,field:"majorstatus",width:200,align:"left",resizable:!0},{title:"Total",rowspan:2,field:"totalprice",width:150,align:"right",resizable:!0},{title:"Qty",rowspan:2,field:"totalqty",width:150,align:"right",resizable:!0},{title:"Date",colspan:3},{title:"Modified",rowspan:2,field:"modified",width:150,align:"right",resizable:!0},{title:"By",rowspan:2,field:"by",width:200,align:"left",resizable:!0}],[{title:"Start",field:"startdate",width:150,align:"right",resizable:!0,editor:{type:"datebox",options:{formatter:function(e){return _.nicedatetodisplay(e)},parser:function(e){return _.isUndefined(e)||_.isBlank(e)?new Date:moment(e).toDate()}}}},{title:"Required",field:"enddate",width:150,align:"right",resizable:!0,editor:{type:"datebox",options:{formatter:function(e){return _.nicedatetodisplay(e)},parser:function(e){return _.isUndefined(e)||_.isBlank(e)?new Date:moment(e).toDate()}}}},{title:"Progress",field:"perc",width:100,align:"left",resizable:!0,formatter:function(e){return _.isNull(e)?"":'<div style="width: 100%; border: 1px solid #ccc"><div style="width: '+e+"%; background: "+colour_mistyrose+'; color: black">'+e+"%</div></div>"}}]],onRowContextMenu:function(e,t,i){doGridContextMenu("divOrdersG","divOrdersMenuPopup",e,t,i)},onDblClickCell:function(e,i,t){doGridGetSelectedRowData("divOrdersG",function(e){_.isBlank(e.invoiceno)?doGridStartEdit("divOrdersG",editingOrderIndex,function(e,t){editingOrderIndex=t,-1!=["status","totalprice","totalqty","modified","by"].indexOf(i)&&(i="name"),doGridGetEditor("divOrdersG",editingOrderIndex,i,function(e){})}):noty({text:"Unable to edit invoiced order",type:"warning",timeout:4e3})})}}))}function refreshFromCacheOrders(e){ordersTabWidgetsLoaded&&("refresh"==e.type&&$("#divOrdersG").datagrid("reload"),_.isUndefined(e.orderid)||_.isNull(e.orderid)||$("#divOrdersG").datagrid("selectRecord",e.orderid))}function doOrdersSelectOrder(e){$("#divOrdersG").datagrid("selectRecord",e)}function doStatusAlert(e){var t=doGetStringFromIdInObjArray(orderstatustypes,e.status);noty({text:"Order "+e.orderno+" has changed status to "+t,type:"information"})}