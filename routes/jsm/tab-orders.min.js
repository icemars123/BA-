var ordersTabWidgetsLoaded=!1;function doOrdersTabWidgets(){function e(e,r){doServerMessage("listorders",{type:"refresh",orderid:r.data.orderid})}ordersTabWidgetsLoaded||(ordersTabWidgetsLoaded=!0,$("#divEvents").on("searchorders",function(e,r){}),$("#divEvents").on("listorders",function(e,r){var t,o,d,i=[];r.data.rs.forEach(function(e){i.push({id:doNiceId(e.id),clientid:doNiceId(e.clientid),orderno:doNiceString(e.orderno),invoiceno:doNiceString(e.invoiceno),name:doNiceString(e.name),pono:doNiceString(e.pono),numversions:_.formatinteger(e.numversions),activeversion:_.formatinteger(e.activeversion),startdate:_.nicedatetodisplay(e.startdate),enddate:_.nicedatetodisplay(e.enddate),totalprice:_.sanitiseAsNumeric(e.totalprice,4),totalqty:_.sanitiseAsNumeric(e.totalqty,4),paid:_.formatnumber(e.paid,2),balance:_.formatnumber(e.balance,2),inventorycommitted:doNiceIntToBool(e.inventorycommitted),isrepeat:e.isrepeat,isnewartwork:e.isnewartwork,status:doGetStringFromIdInObjArray(orderstatustypes,e.status),attachmentid:doNiceId(e.attachmentid),attachmentname:doNiceString(e.attachmentname),attachmentimage:doNiceString(e.attachmentimage),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divOrdersG").datagrid("loadData",i),t=i,o=_.toBigNum(0),d=_.toBigNum(0),t.forEach(function(e){_.isBlank(e.totalprice)||(o=o.plus(e.totalprice)),_.isBlank(e.totalqty)||(d=d.plus(e.totalqty))}),$("#divOrdersG").datagrid("reloadFooter",[{orderno:'<span class="totals_footer">'+t.length+" order(s)</span>",totalprice:'<span class="totals_footer">'+_.niceformatnumber(o)+"</span>",totalqty:'<span class="totals_footer">'+_.niceformatnumber(d)+"</span>"}]),doGridSelectRowById("divOrdersG",r.pdata.orderid)}),$("#divEvents").on("neworder",e),$("#divEvents").on("saveorder",e),$("#divEvents").on("expireorder",e),$("#divEvents").on("newversionorder",e),$("#divEvents").on("ordernewversion",e),$("#divEvents").on("neworderdetail",e),$("#divEvents").on("saveorderdetail",e),$("#divEvents").on("expireorderdetail",e),$("#divEvents").on("orderdetailcreated",e),$("#divEvents").on("orderdetailsaved",e),$("#divEvents").on("orderdetailexpired",e),$("#divEvents").on("orderattachmentsaved",e),$("#divEvents").on("orderattachmentexpired",e),$("#divEvents").on("neworderstatus",e),$("#divEvents").on("orderstatuscreated",e),$("#divEvents").on("ordercreated",e),$("#divEvents").on("ordersaved",e),$("#divEvents").on("orderexpired",e),$("#divEvents").on("orderduplicated",e),$("#divEvents").on("saveaccount",e),$("#divEvents").on("saveclient",e),$("#divEvents").on("clientsaved",e),$("#divEvents").on("inventoryadded",e),$("#divEvents").on("invoicecreated",e),$("#divEvents").on("duplicateorder",function(e,r){_.isUN(r.data.orderno)||(doShowWarning("New order "+r.data.orderno+" created"),doServerMessage("listorders",{type:"refresh"}))}),$("#divEvents").on("new-client-order",function(e,r){doSelectSalesTab("Orders")}),$("#divEvents").on("selectorderid",function(e,r){_.isUndefined(r.id)||_.isNull(r.id)||$("#divOrdersG").datagrid("selectRecord",r.id)}),$("#divEvents").on("orderspopup",function(e,r){"new"==r?doDlgOrderNew(!1,null):"clear"==r?$("#divOrdersG").datagrid("clearSelections"):"remove"==r?doGridGetSelectedRowData("divOrdersG",function(r){_.isBlank(r.invoiceno)?doPromptOkCancel("Remove order "+r.orderno+"?",function(e){e&&doServerDataMessage("expireorder",{orderid:r.id},{type:"refresh"})}):doShowWarning("Can not remove an invoiced order")})||doShowError("Please select an order to remove"):"refresh"==r?doServerMessage("listorders",{type:"refresh"}):"print"==r?doPromptYesNoCancel("Print all listed orders (Yes) or selected only (No)?",function(e){!0===e?console.log("Print all listed orders"):!1===e&&doGridGetSelectedRowData("divOrdersG",function(e){doServerDataMessage("printorders",{orders:[e.id]},{type:"refresh"})})}):"email"==r?doGridGetSelectedRowData("divOrdersG",function(e){doDlgEmailOrder(e,itype_order_order)})||doShowError("Please select an order to email"):"duplicate"==r?doGridGetSelectedRowData("divOrdersG",function(r){doPromptOkCancel("Duplicate order "+r.orderno+"?",function(e){e&&doServerDataMessage("duplicateorder",{isquote:!1,orderid:r.id},{type:"refresh"})})})||doShowError("Please select an order to duplicate"):"newversion"==r?doGridGetSelectedRowData("divOrdersG",function(r){_.isBlank(r.invoiceno)?doPromptOkCancel("Create new version from version "+r.activeversion+" of "+r.orderno+"?",function(e){e&&doServerDataMessage("newversionorder",{orderid:r.id,version:r.activeversion},{type:"refresh"})}):doShowWarning("Can not create new version of an invoiced order")})||doShowError("Please select an order"):"search"==r?doDlgOrderSearch():"deposit"==r?doGridGetSelectedRowData("divOrdersG",function(e){doDlgPayeposits(e.clientid)})||doShowError("Please select an order to pay"):"invoice"==r?doGridGetSelectedRowData("divOrdersG",function(r){_.isBlank(r.invoiceno)?doPromptOkCancel("Convert order #"+r.orderno+" to invoice?",function(e){e&&doServerDataMessage("createinvoicefromorder",{orderid:r.id},{type:"refresh"})}):doShowWarning("Order has already been invoiced")})||doShowError("Please select an order to invoice"):"jobsheet"==r&&(doGridGetSelectedRowData("divOrdersG",function(e){doSelectJobSheetsTab(),$("#divEvents").trigger("selectjobsheetbyorderid",{orderid:e.id})})||doShowError("Please select an order to pay"))}),!isadmin&&myperms.cancreateorders,orderInvoiceToStates=doGetStatesFromCountry(defaultCountry),orderShipToStates=doGetStatesFromCountry(defaultCountry),$("#divOrdersG").datagrid({idField:"id",fitColumns:!1,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbOrders",showFooter:!0,sortName:"orderno",sortOrder:"desc",remoteSort:!1,multiSort:!0,autoRowHeight:!1,view:groupview,groupField:"status",frozenColumns:[[{title:"Order #",rowspan:2,field:"orderno",width:150,align:"left",resizable:!0,sortable:!0}],[]],columns:[[{title:"Name",rowspan:2,field:"name",width:300,align:"left",resizable:!0,sortable:!0},{title:"P.O.#",rowspan:2,field:"pono",width:150,align:"left",resizable:!0,sortable:!0},{title:"Client",rowspan:2,field:"clientid",width:300,align:"left",resizable:!0,formatter:function(e,r){return doGetNameFromTreeArray(cache_clients,e)},sortable:!0},{title:"Version",rowspan:2,field:"activeversion",width:100,align:"right",resizable:!0},{title:"Status",rowspan:2,field:"status",width:200,align:"left",resizable:!0},{title:"Total",rowspan:2,field:"totalprice",width:150,align:"right",resizable:!0,formatter:function(e,r,t){return _.isUndefined(r.id)?e:_.niceformatnumber(e)}},{title:"Qty",rowspan:2,field:"totalqty",width:150,align:"right",resizable:!0,formatter:function(e,r,t){return _.isUndefined(r.id)?e:_.niceformatqty(e)}},{title:"Stock Committed",rowspan:2,field:"inventorycommitted",width:150,align:"center",resizable:!0,formatter:function(e,r){return mapBoolToImage(e)}},{title:"Balance",rowspan:2,field:"balance",width:150,align:"right",resizable:!0,sortable:!0,styler:function(e,r,t){return"color: "+colour_indianred}},{title:"Date",colspan:2},{title:"Modified",rowspan:2,field:"date",width:150,align:"right",resizable:!0,sortable:!0},{title:"By",rowspan:2,field:"by",width:200,align:"left",resizable:!0,sortable:!0}],[{title:"Start",field:"startdate",width:150,align:"right",resizable:!0,formatter:function(e,r){return _.nicedatetodisplay(e)},sortable:!0},{title:"Required",field:"enddate",width:150,align:"right",resizable:!0,formatter:function(e,r){return _.nicedatetodisplay(e)},sortable:!0}]],groupFormatter:function(e,r){return e+" - "+r.length+" order(s)"},onRowContextMenu:function(e,r,t){doGridContextMenu("divOrdersG","divOrdersMenuPopup",e,r,t)},onBeginEdit:function(e){},onDblClickCell:function(e,r,t){doGetGridGetRowDataByIndex("divOrdersG",e,function(e){doDlgOrderNew(!1,e.id)})}}),posonly&&($("#divOrdersG").datagrid("hideColumn","pono"),$("#divOrdersG").datagrid("hideColumn","activeversion"),$("#divOrdersG").datagrid("hideColumn","status"),$("#divOrdersG").datagrid("hideColumn","inventorycommitted"),$("#divOrdersG").datagrid("hideColumn","balance"),$("#divOrdersG").datagrid("hideColumn","startdate"),$("#divOrdersG").datagrid("hideColumn","enddate")),$("#tbOrdersDeposit").linkbutton("disable"),$("#tbOrdersInvoice").linkbutton("disable"),doServerMessage("listorders",{type:"refresh"}))}