var quotesTabWidgetsLoaded=!1;function doQuotesTabWidgets(){function e(e,t){doServerMessage("listquotes",{type:"refresh",orderid:t.data.orderid})}quotesTabWidgetsLoaded||(quotesTabWidgetsLoaded=!0,$("#divEvents").on("searchorders",function(e,t){}),$("#divEvents").on("listquotes",function(e,t){var o,i,r,n=[];t.data.rs.forEach(function(e){n.push({id:doNiceId(e.id),clientid:doNiceId(e.clientid),quoteno:doNiceString(e.quoteno),orderno:doNiceString(e.orderno),invoiceno:doNiceString(e.invoiceno),name:doNiceString(e.name),pono:doNiceString(e.pono),numversions:_.formatinteger(e.numversions),activeversion:_.formatinteger(e.activeversion),startdate:_.nicedatetodisplay(e.startdate),enddate:_.nicedatetodisplay(e.enddate),totalprice:_.sanitiseAsNumeric(e.totalprice,4),totalqty:_.sanitiseAsNumeric(e.totalqty,4),isrepeat:e.isrepeat,isnewartwork:e.isnewartwork,status:doGetStringFromIdInObjArray(orderstatustypes,e.status),attachmentid:doNiceId(e.attachmentid),attachmentname:doNiceString(e.attachmentname),attachmentimage:doNiceString(e.attachmentimage),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divQuotesG").datagrid("loadData",n),o=n,i=_.toBigNum(0),r=_.toBigNum(0),o.forEach(function(e){_.isBlank(e.totalprice)||(i=i.plus(e.totalprice)),_.isBlank(e.totalqty)||(r=r.plus(e.totalqty))}),$("#divQuotesG").datagrid("reloadFooter",[{quoteno:'<span class="totals_footer">'+o.length+" order(s)</span>",totalprice:'<span class="totals_footer">'+_.niceformatnumber(i)+"</span>",totalqty:'<span class="totals_footer">'+_.niceformatnumber(r)+"</span>"}]),doGridSelectRowById("divQuotesG",t.pdata.orderid)}),$("#divEvents").on("neworder",e),$("#divEvents").on("saveorder",e),$("#divEvents").on("expireorder",e),$("#divEvents").on("newversionorder",e),$("#divEvents").on("ordernewversion",e),$("#divEvents").on("neworderdetail",e),$("#divEvents").on("saveorderdetail",e),$("#divEvents").on("expireorderdetail",e),$("#divEvents").on("orderdetailcreated",e),$("#divEvents").on("orderdetailsaved",e),$("#divEvents").on("orderduplicated",e),$("#divEvents").on("orderdetailexpired",e),$("#divEvents").on("orderattachmentsaved",e),$("#divEvents").on("orderattachmentexpired",e),$("#divEvents").on("neworderstatus",e),$("#divEvents").on("orderstatuscreated",e),$("#divEvents").on("ordercreated",e),$("#divEvents").on("ordersaved",e),$("#divEvents").on("orderexpired",e),$("#divEvents").on("saveaccount",e),$("#divEvents").on("saveclient",e),$("#divEvents").on("clientsaved",e),$("#divEvents").on("inventoryadded",e),$("#divEvents").on("invoicecreated",e),$("#divEvents").on("duplicateorder",function(e,t){_.isUN(t.data.quoteno)||(doShowWarning("New quote "+t.data.quoteno+" created"),doServerMessage("listquotes",{type:"refresh"}))}),$("#divEvents").on("new-client-quote",function(e,t){doSelectSalesTab("Quotes")}),$("#divEvents").on("selectquoteid",function(e,t){_.isUndefined(t.id)||_.isNull(t.id)||$("#divQuotesG").datagrid("selectRecord",t.id)}),$("#divEvents").on("quotespopup",function(e,t){"new"==t?doDlgOrderNew(!0,null):"clear"==t?$("#divQuotesG").datagrid("clearSelections"):"remove"==t?doGridGetSelectedRowData("divQuotesG",function(t){_.isBlank(t.invoiceno)&&_.isBlank(t.orderno)?doPromptOkCancel("Remove quote "+t.quoteno+"?",function(e){e&&doServerDataMessage("expireorder",{orderid:t.id},{type:"refresh"})}):doShowWarning("Can not remove an invoiced or ordered quote")})||doShowError("Please select an quote to remove"):"refresh"==t?doServerMessage("listquotes",{type:"refresh"}):"print"==t||"email"==t||("duplicate"==t?doGridGetSelectedRowData("divQuotesG",function(t){doPromptOkCancel("Duplicate quote "+t.quoteno+"?",function(e){e&&doServerDataMessage("duplicateorder",{isquote:!0,orderid:t.id},{type:"refresh"})})})||doShowError("Please select a quote to duplicate"):"newversion"==t?doGridGetSelectedRowData("divQuotesG",function(t){_.isBlank(t.invoiceno)&&_.isBlank(t.orderno)?doPromptOkCancel("Create new version from version "+t.activeversion+" of "+t.quoteno+"?",function(e){e&&doServerDataMessage("newversionorder",{orderid:t.id,version:t.activeversion},{type:"refresh"})}):doShowWarning("Can not create new version of an invoiced or ordered quote")})||doShowError("Please select an quote"):"search"==t?doDlgQuoteSearch():"deposit"==t?doDeposit():"invoice"==t?doGridGetSelectedRowData("divQuotesG",function(t){_.isBlank(t.invoiceno)?doPromptOkCancel("Convert quote #"+t.quoteno+" to invoice?",function(e){e&&doServerDataMessage("createinvoicefromquote",{orderid:t.id},{type:"refresh"})}):doShowWarning("Quote has already been invoiced")})||doShowError("Please select an quote to invoice"):"jobsheet"==t&&doJobSheet())}),!isadmin&&myperms.cancreateorders,quoteInvoiceToStates=doGetStatesFromCountry(defaultCountry),quoteShipToStates=doGetStatesFromCountry(defaultCountry),$("#divQuotesG").datagrid({idField:"id",fitColumns:!1,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbQuotes",showFooter:!0,sortName:"quoteno",sortOrder:"desc",remoteSort:!1,multiSort:!0,autoRowHeight:!1,view:groupview,groupField:"status",frozenColumns:[[{title:"Quote #",rowspan:2,field:"quoteno",width:150,align:"left",resizable:!0,sortable:!0}],[]],columns:[[{title:"Name",rowspan:2,field:"name",width:300,align:"left",resizable:!0,sortable:!0},{title:"P.O.#",rowspan:2,field:"pono",width:150,align:"left",resizable:!0,sortable:!0},{title:"Client",rowspan:2,field:"clientid",width:300,align:"left",resizable:!0,formatter:function(e,t){return doGetNameFromTreeArray(cache_clients,e)},sortable:!0},{title:"Version",rowspan:2,field:"activeversion",width:100,align:"right",resizable:!0},{title:"Status",rowspan:2,field:"status",width:200,align:"left",resizable:!0},{title:"Total",rowspan:2,field:"totalprice",width:150,align:"right",resizable:!0,formatter:function(e,t,o){return _.isUndefined(t.id)?e:_.niceformatnumber(e)}},{title:"Qty",rowspan:2,field:"totalqty",width:150,align:"right",resizable:!0,formatter:function(e,t,o){return _.isUndefined(t.id)?e:_.niceformatqty(e)}},{title:"Date",colspan:2},{title:"Modified",rowspan:2,field:"date",width:150,align:"right",resizable:!0,sortable:!0},{title:"By",rowspan:2,field:"by",width:200,align:"left",resizable:!0,sortable:!0}],[{title:"Start",field:"startdate",width:150,align:"right",resizable:!0,formatter:function(e,t){return _.nicedatetodisplay(e)},sortable:!0},{title:"Required",field:"enddate",width:150,align:"right",resizable:!0,formatter:function(e,t){return _.nicedatetodisplay(e)},sortable:!0}]],groupFormatter:function(e,t){return e+" - "+t.length+" quote(s)"},onRowContextMenu:function(e,t,o){doGridContextMenu("divQuotesG","divQuotesMenuPopup",e,t,o)},onBeginEdit:function(e){},onDblClickCell:function(e,t,o){doGetGridGetRowDataByIndex("divQuotesG",e,function(e){doDlgOrderNew(!0,e.id)})}}),posonly&&($("#divQuotesG").datagrid("hideColumn","pono"),$("#divQuotesG").datagrid("hideColumn","activeversion"),$("#divQuotesG").datagrid("hideColumn","startdate"),$("#divQuotesG").datagrid("hideColumn","enddate")),doServerMessage("listquotes",{type:"refresh"}))}