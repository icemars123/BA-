function doDlgPayInvoices(e){var n=null,t=[{text:"Clear",iconCls:"icon-clear",handler:function(){$("#divPaymentInvoicesG").datagrid("clearSelections")}},{text:"Edit",iconCls:"icon-edit",handler:function(){doGridGetSelectedRowData("divPaymentInvoicesG",function(e){doGridStartEdit("divPaymentInvoicesG",n,function(e,t){n=t,doGridGetEditor("divPaymentInvoicesG",n,"amount",function(e){})})})}},{text:"Cancel",iconCls:"icon-cancel",handler:function(){n=doGridCancelEdit("divPaymentInvoicesG",n)}},{text:"Save",iconCls:"icon-save",handler:l},{text:"Apply",iconCls:"icon-calculator",handler:function(){var e=$("#divPaymentInvoicesG").datagrid("getSelections"),t=$("#fldPaymentAmount").numberbox("getValue");if(_.isBlank(t))doMandatoryTextbox("Please enter the payment amount","fldPaymentAmount");else if(0<e.length){var a=_.toBigNum(t);e.forEach(function(e){if(!a.lessThanOrEqualTo(0)){var t=_.toBigNum(e.paid),i=_.toBigNum(e.totalprice),n=_.toBigNum(e.totalgst),o=i.plus(n).minus(t);a=o.greaterThanOrEqualTo(a)?(o=a,_.toBigNum(0)):a.minus(o),e.amount=o,doUpdateGridRow("divPaymentInvoicesG",e.id,{amount:_.sanitiseAsNumeric(o,2)})}}),$("#fldPaymentAmount").numberbox("setValue",_.sanitiseAsNumeric(a,2)),a.greaterThan(0)&&doShowWarning("You have "+_.sanitiseAsNumeric(a,2)+" remaininng...")}else doShowWarning("Please select for which invoices you wish to apply payment")}}];function l(){doGridEndEditGetRow("divOrderNewProductsG",n,function(e){})}function o(){var e=$("#divPaymentInvoicesG").datagrid("getRows"),t=_.toBigNum(0);e.forEach(function(e){_.isUndefined(e.amount)||_.isNull(e.amount)||(t=t.plus(_.toBigNum(e.amount)))}),$("#divPaymentInvoicesG").datagrid("reloadFooter",[{amount:'<span class="totals_footer">'+_.formatnumber(t)+"</span>"}])}function i(e,t){var i=[];t.data.rs.forEach(function(e){i.push({id:doNiceId(e.id),clientid:doNiceId(e.clientid),clientname:doNiceString(e.clientname),name:doNiceString(e.name),pono:doNiceString(e.pono),invoiceno:doNiceString(e.invoiceno),orderno:doNiceString(e.orderno),paid:_.formatnumber(e.paid,2),balance:_.formatnumber(e.balance,2),totalprice:_.formatnumber(e.totalprice,2),totalgst:_.formatnumber(e.totalgst,2),date:doNiceDate(e.invoicedate)})}),$("#divPaymentInvoicesG").datagrid("loadData",i),o()}function a(e,t){$("#dlgPayment").dialog("close")}$("#divEvents").on("listunpaidordersbyclient",i),$("#divEvents").on("payinvoices",a),$("#dlgPayment").dialog({title:"Make Payment",onClose:function(){$("#divEvents").off("listunpaidordersbyclient",i),$("#divEvents").off("payinvoices",a)},onOpen:function(){$("#cbPaymentClients").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_clients,limitToList:!0,onSelect:function(e){doServerDataMessage("listunpaidordersbyclient",{clientid:e.id},{type:"refresh"})}}),$("#cbPaymentType").combobox({valueField:"id",textField:"name",data:paymenttypes}),$("#cbPaymentReason").combobox({valueField:"id",textField:"name",data:paymentreasons}),$("#dtPaymentDate").datebox(),$("#divPaymentInvoicesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!1,rownumbers:!1,striped:!0,toolbar:t,showFooter:!0,sortName:"invoiceno",sortOrder:"asc",remoteSort:!1,multiSort:!0,frozenColumns:[[{title:"Invoice #",field:"invoiceno",width:150,align:"left",resizable:!0,sortable:!0}]],columns:[[{title:"P.O.#",field:"pono",width:150,align:"left",resizable:!0},{title:"Invoiced",field:"invoicedate",width:150,align:"right",resizable:!0,sortable:!0},{title:"Total",field:"totalprice",width:150,align:"right",resizable:!0,sortable:!0},{title:"GST",field:"totalgst",width:150,align:"right",resizable:!0,sortable:!0},{title:"Paid",field:"paid",width:150,align:"right",resizable:!0,sortable:!0,styler:function(e,t,i){return"color: "+colour_mediumorchid}},{title:"Balance",field:"balance",width:150,align:"right",resizable:!0,sortable:!0,styler:function(e,t,i){return"color: "+colour_indianred}},{title:"Amount",field:"amount",width:150,align:"right",resizable:!0,editor:{type:"numberbox",options:{precision:2}},styler:function(e,t,i){return"color: "+colour_chocolate}}]],onEndEdit:function(e,t,i){o()},onDblClickCell:function(e,i,t){doGridStartEdit("divPaymentInvoicesG",n,function(e,t){n=t,-1!=["amount"].indexOf(i)&&(i="amount"),doGridGetEditor("divPaymentInvoicesG",n,i,function(e){})})}}),_.isUndefined(e)||_.isNull(e)||($("#cbPaymentClients").combotree("setValue",e),doServerDataMessage("listunpaidordersbyclient",{clientid:e},{type:"refresh"}))},buttons:[{text:"Pay",handler:function(){l();var e=$("#cbPaymentClients").combotree("getValue"),t=$("#fldPaymentReference").textbox("getValue"),i=$("#cbPaymentType").combobox("getValue"),n=$("#cbPaymentReason").combobox("getValue"),o=$("#dtPaymentDate").datebox("getValue"),a=$("#divPaymentInvoicesG").datagrid("getData"),d=[];a.rows.forEach(function(e){_.isBlank(e.amount)||d.push({orderid:e.id,amount:e.amount})}),0<d.length?doServerDataMessage("payinvoices",{clientid:e,refno:t,type:i,reason:n,datepaid:o,invoices:d},{type:"refresh"}):doShowWarning("Please apply at least one payment")}},{text:"Close",handler:function(){$("#dlgPayment").dialog("close")}}]}).dialog("center").dialog("open")}