var productsTabWidgetsLoaded=!1;function doProductsTabWidgets(){function i(){$("#divProductsG").treegrid("clearSelections")}productsTabWidgetsLoaded||($("#divEvents").on("listproductcategories",function(e,t){$("#cbProductsCategories").combotree("loadData",cache_productcategories)}),$("#divEvents").on("listproductsbycategory",function(e,t){$("#divProductsG").datagrid("reload"),_.isUndefined(t.pdata.productid)||_.isNull(t.pdata.productid)||$("#divProductsG").datagrid("selectRecord",t.pdata.productid)}),$("#divEvents").on("newproduct",function(e,t){var o=$("#cbProductsCategories").combobox("getValue");t.data,o==o&&primus.emit("listproductsbycategory",{fguid:fguid,uuid:uuid,session:session,productcategoryid:o,pdata:{type:"refresh"}})}),$("#divEvents").on("updateproduct",function(e,t){var o=$("#cbProductsCategories").combobox("getValue");primus.emit("listproducts",{fguid:fguid,uuid:uuid,session:session,pdata:{type:"refresh"}}),o==t.data.productcategoryid&&(i(),primus.emit("listproductsbycategory",{fguid:fguid,uuid:uuid,session:session,productcategoryid:o,pdata:{type:"refresh"}}))}),$("#divEvents").on("productupdated",function(e,t){primus.emit("listproducts",{fguid:fguid,uuid:uuid,session:session,pdata:{type:"refresh"}}),$("#cbProductsCategories").combobox("getValue")==t.data.productcategoryid&&primus.emit("listproductsbycategory",{fguid:fguid,uuid:uuid,session:session,productcategoryid:t.data.productcategoryid,pdata:{type:"refresh"}})}),$("#divEvents").on("checkproductcode",function(e,t){var o=t.data.rs;0<o.length&&($("#cbProductsCategories").combobox("getValue")==o[0].productcategoryid?noty({text:"Product code ["+o[0].code+"] is already assigned to ["+o[0].name+"]",type:"error",timeout:4e3}):noty({text:"Product code ["+o[0].code+"] is already assigned to ["+o[0].name+"] under category ["+o[0].productcategoryname+"]",type:"error",timeout:4e3}))}),$("#divEvents").on("gotoproduct",function(e,t){$("#cbProductsCategories").combotree("setValue",t.productcategoryid),primus.emit("listproductsbycategory",{fguid:fguid,uuid:uuid,session:session,productcategoryid:t.productcategoryid,pdata:{type:"refresh",productid:t.productid}})}),$("#divEvents").on("productspopup",function(e,t){var o;"new"==t?(o=$("#cbProductsCategories").combobox("getValue"),_.isBlank(o)?noty({text:"Please select a product category for new product",type:"error",timeout:4e3}):doDlgProductNew(o,null)):"clear"==t?i():"edit"==t?doEdit():"cancel"==t?doCancel():"save"==t?doSave():"remove"==t?function(){var t=$("#divProductsG").datagrid("getSelections");if(0==t.length)noty({text:"Please select one or more products to remove",type:"error",timeout:4e3});else if(1==t.length){var o=t[0];doPromptOkCancel("Remove "+o.name+"?",function(e){_.isNull(e)||primus.emit("expireproduct",{fguid:fguid,uuid:uuid,session:session,productid:o.id,pdata:{type:"refresh"}})})}else doPromptOkCancel("Remove "+t.length+" products?",function(e){_.isNull(e)||t.forEach(function(e){primus.emit("expireproduct",{fguid:fguid,uuid:uuid,session:session,productid:e.id,pdata:{type:"refresh"}})})})}():"duplicate"==t?doGridGetSelectedRowData("divProductsG",function(e){primus.emit("duplicateproduct",{fguid:fguid,uuid:uuid,session:session,productid:e.id,pdata:{type:"refresh"}})})||noty({text:"Please select a product to duplicate",type:"error",timeout:4e3}):"search"==t?doDlgProductSearch(function(e){$("#cbProductsCategories").combotree("setValue",e.categoryid),primus.emit("listproductsbycategory",{fguid:fguid,uuid:uuid,session:session,productcategoryid:e.categoryid,pdata:{type:"refresh",productid:e.id}})}):"changecategory"==t&&(doGridGetSelectedRowData("divProductsG",function(e){doDlgProductChangeCategory(e)})||noty({text:"Please select a product to change",type:"error",timeout:4e3}))}),productsTabWidgetsLoaded=!0,$("#cbProductsCategories").combotree({valueField:"id",textField:"name",data:cache_productcategories,limitToList:!0,onSelect:function(e){primus.emit("listproductsbycategory",{fguid:fguid,uuid:uuid,session:session,productcategoryid:e.id,pdata:{type:"refresh"}})}}),$("#cbProductsBarcodeTypes").combobox({valueField:"id",textField:"id",groupField:"parentname",data:barcodetypes,onSelect:function(e){console.log(e);var t=$("#divProductsG").datagrid("getSelected");t&&$("#divBarcodeView").barcode(t.barcode,e.id,{barHeight:30})}}),$("#divProductsG").datagrid({idField:"id",fitColumns:!1,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbProducts",showFooter:!0,sortName:"code",sortOrder:"asc",remoteSort:!1,multiSort:!0,loader:function(e,t,o){t({total:cache_productsbycategory.length,rows:cache_productsbycategory}),$(this).datagrid("reloadFooter",[{code:'<span class="totals_footer">'+cache_productsbycategory.length+" Products</span>"}])},frozenColumns:[[{title:"Code",rowspan:2,field:"code",width:300,align:"left",resizable:!0,sortable:!0}],[]],columns:[[{title:"Name",rowspan:2,field:"name",width:300,align:"left",resizable:!0,sortable:!0},{title:"Cost Price",rowspan:2,field:"costprice",width:80,align:"right",resizable:!0,sortable:!0},{title:"Sell Price",rowspan:2,field:"sellprice",width:80,align:"right",resizable:!0,sortable:!0},{title:"Client",rowspan:2,field:"clientid",width:200,align:"left",resizable:!0,formatter:function(e,t){return doGetStringFromIdInObjArray(cache_clients,e)}},{title:"Inventory",colspan:3},{title:"Active",rowspan:2,field:"isactive",width:80,align:"center",resizable:!0,formatter:function(e,t){return mapBoolToImage(e)}},{title:"Modified",rowspan:2,field:"date",width:150,align:"right",resizable:!0,sortable:!0},{title:"By",rowspan:2,field:"by",width:200,align:"left",resizable:!0,sortable:!0}],[{title:"Build Template",field:"buildtemplateid",width:300,align:"left",resizable:!0,formatter:function(e,t){return doGetNameFromTreeArray(cache_buildtemplates,e)}},{title:"Current Qty",field:"inventoryqty",width:80,align:"right",resizable:!0,formatter:function(e,t,o){return _.niceformatqty(e)}},{title:"On Order",field:"orderqty",width:80,align:"right",resizable:!0,styler:function(e,t,o){if(e<t.inventoryqty||_.isBlank(t.inventoryqty))return css_gridcol_qty_neg},formatter:function(e,t,o){return _.niceformatqty(e)}}]],onRowContextMenu:function(e,t,o){doGridContextMenu("divProductsG","divProductsMenuPopup",e,t,o)},onDblClickCell:function(e,t,o){var i=$("#cbProductsCategories").combobox("getValue");_.isBlank(i)||doGetGridGetRowDataByIndex("divProductsG",e,function(e){doDlgProductNew(i,e.id)})}}),posonly&&($("#divProductsG").datagrid("hideColumn","costprice"),$("#divProductsG").datagrid("hideColumn","buildtemplateid"),$("#divProductsG").datagrid("hideColumn","inventoryqty"),$("#divProductsG").datagrid("hideColumn","orderqty"),$("#divProductsG").datagrid("hideColumn","isactive"),$("#divProductsG").datagrid("hideColumn","clientid")))}