function doDlgProductNew(R,j){var H=_.isUndefined(j)||_.isNull(j),o={},r=null;function c(){H?($("#fldNewProductCode").textbox("clear"),$("#fldNewProductName").textbox("clear"),$("#fldNewProductBarcode").textbox("clear"),$("#fldNewProductAltcode").textbox("clear"),$("#fldNewProductCostPrice").numberbox("clear"),$("#fldNewProductUOM").textbox("clear"),$("#fldNewProductUOMSize").numberbox("clear"),$("#cbNewProductClients").combotree("clear"),$("#cbNewProductActive").switchbutton("check"),$("#cbNewProductBuyTaxCode").combobox("clear"),$("#cbNewProductSellTaxCode").combobox("clear"),$("#cbNewProductSalesAccount").combotree("clear"),$("#cbNewProductIncomeAccount").combotree("clear"),$("#cbNewProductAssetAccount").combotree("clear"),$("#cbNewProductBuildTemplate").combotree("clear"),$("#fldNewProductMinQty").numberbox("clear"),$("#fldNewProductWarnQty").numberbox("clear"),$("#cbNewProductAlias").combobox("clear"),$("#cbNewProductLocation1").combotree("clear"),$("#cbNewProductLocation2").combotree("clear"),$("#fldNewProductWidth").numberbox("clear"),$("#fldNewProducLength").numberbox("clear"),$("#fldNewProductHeight").numberbox("clear"),$("#fldNewProductWeight").numberbox("clear"),$("#fldNewProductPrice1").numberbox("clear"),$("#fldNewProductPrice2").numberbox("clear"),$("#fldNewProductPrice3").numberbox("clear"),$("#fldNewProductPrice4").numberbox("clear"),$("#fldNewProductPrice5").numberbox("clear"),$("#fldNewProductPrice6").numberbox("clear"),$("#fldNewProductPrice7").numberbox("clear"),$("#fldNewProductPrice8").numberbox("clear"),$("#fldNewProductPrice9").numberbox("clear"),$("#fldNewProductPrice10").numberbox("clear"),$("#fldNewProductPrice11").numberbox("clear"),$("#fldNewProductPrice12").numberbox("clear"),$("#fldNewProductPrice13").numberbox("clear"),$("#fldNewProductPrice14").numberbox("clear"),$("#fldNewProductPrice15").numberbox("clear"),$("#fldNewProductAttrib1").textbox("clear"),$("#fldNewProductAttrib2").textbox("clear"),$("#fldNewProductAttrib3").textbox("clear"),$("#fldNewProductAttrib4").textbox("clear"),$("#fldNewProductAttrib5").textbox("clear")):_.isEmpty(o)||($("#fldNewProductCode").textbox("setValue",o.code),$("#fldNewProductName").textbox("setValue",o.name),$("#fldNewProductBarcode").textbox("setValue",o.barcode),$("#fldNewProductAltcode").textbox("setValue",o.altcode),$("#fldNewProductCostPrice").numberbox("setValue",o.costprice),$("#fldNewProductUOM").textbox("setValue",o.uom),$("#fldNewProductUOMSize").numberbox("setValue",o.uomsize),$("#cbNewProductClients").combotree("setValue",o.clientid),$("#cbNewProductActive").switchbutton("check",o.isactive),$("#cbNewProductBuyTaxCode").combobox("setValue",o.buytaxcodeid),$("#cbNewProductSellTaxCode").combobox("setValue",o.selltaxcodeid),$("#cbNewProductSalesAccount").combotree("setValue",o.costofgoodsaccountid),$("#cbNewProductIncomeAccount").combotree("setValue",o.incomeaccountid),$("#cbNewProductAssetAccount").combotree("setValue",o.assetaccountid),$("#cbNewProductBuildTemplate").combotree("setValue",o.buildtemplateid),$("#fldNewProductMinQty").numberbox("setValue",_.niceformatqty(o.minqty)),$("#fldNewProductWarnQty").numberbox("setValue",_.niceformatqty(o.warnqty)),$("#cbNewProductAlias").combobox("setValue",o.productaliasid),$("#cbNewProductLocation1").combotree("setValue",o.location1id),$("#cbNewProductLocation2").combotree("setValue",o.location2id),$("#fldNewProductWidth").numberbox("setValue",_.niceformatqty(o.width)),$("#fldNewProducLength").numberbox("setValue",_.niceformatqty(o.length)),$("#fldNewProductHeight").numberbox("setValue",_.niceformatqty(o.height)),$("#fldNewProductWeight").numberbox("setValue",_.niceformatqty(o.weight)),$("#fldNewProductPrice1").numberbox("setValue",_.niceformatqty(o.price1)),$("#fldNewProductPrice2").numberbox("setValue",_.niceformatqty(o.price2)),$("#fldNewProductPrice3").numberbox("setValue",_.niceformatqty(o.price3)),$("#fldNewProductPrice4").numberbox("setValue",_.niceformatqty(o.price4)),$("#fldNewProductPrice5").numberbox("setValue",_.niceformatqty(o.price5)),$("#fldNewProductPrice6").numberbox("setValue",_.niceformatqty(o.price6)),$("#fldNewProductPrice7").numberbox("setValue",_.niceformatqty(o.price7)),$("#fldNewProductPrice8").numberbox("setValue",_.niceformatqty(o.price8)),$("#fldNewProductPrice9").numberbox("setValue",_.niceformatqty(o.price9)),$("#fldNewProductPrice10").numberbox("setValue",_.niceformatqty(o.price10)),$("#fldNewProductPrice11").numberbox("setValue",_.niceformatqty(o.price11)),$("#fldNewProductPrice12").numberbox("setValue",_.niceformatqty(o.price12)),$("#fldNewProductPrice13").numberbox("setValue",_.niceformatqty(o.price13)),$("#fldNewProductPrice14").numberbox("setValue",_.niceformatqty(o.price14)),$("#fldNewProductPrice15").numberbox("setValue",_.niceformatqty(o.price15)),$("#fldNewProductAttrib1").textbox("setValue",o.attrib1),$("#fldNewProductAttrib2").textbox("setValue",o.attrib2),$("#fldNewProductAttrib3").textbox("setValue",o.attrib3),$("#fldNewProductAttrib4").textbox("setValue",o.attrib4),$("#fldNewProductAttrib5").textbox("setValue",o.attrib5),_.isBlank(o.barcode)||JsBarcode("#svgNewProductBarcode",o.barcode,{format:barcode_defaultformat,lineColor:barcode_colour,fontoptions:barcode_fontOptions,textmargin:barcode_textmargin,width:barcode_width,height:barcode_height}),$("#btnProductNewAdd").linkbutton("enable"),$("#dlgProductNew").dialog("setTitle","Modify "+o.name)),doTextboxFocus("fldNewProductCode")}function e(e,t){0<t.data.rs.length?$("#btnProductNewAdd").linkbutton("disable"):$("#btnProductNewAdd").linkbutton("enable")}function t(e,t){$("#dlgProductNew").dialog("close")}function d(e,t){$("#cbNewProductSalesAccount").combotree("loadData",cache_accounts),$("#cbNewProductIncomeAccount").combotree("loadData",cache_accounts),$("#cbNewProductAssetAccount").combotree("loadData",cache_accounts)}function i(e,t){$("#cbNewProductBuyTaxCode").combobox("loadData",cache_accounts),$("#cbNewProductSellTaxCode").combobox("loadData",cache_accounts)}function a(e,t){o=t.data.product,c()}function u(e,t){$("#fldNewProductBarcode").textbox("setValue",t.data.barcodeno)}function l(e,t){$("#divNewProductSupplierCodeG").datagrid("loadData",t.data.rs)}function n(e,t){t.data.productid==j&&doServerDataMessage("listproductpricing",{productid:j},{type:"refresh"})}function b(e,t){$("#divNewProductPricesG").datagrid("loadData",t.data.rs)}function s(e,t){doServerDataMessage("listproductcodes",{productid:j},{type:"refresh"})}function f(e,t){t.data.productid==j&&doServerDataMessage("listproductcodes",{productid:j},{type:"refresh"})}function p(e,t){var o,r,c;"new"==t?(o=$("#cbNewProductSupplier").combobox("getValue"),r=$("#fldNewProductSupplierCode").textbox("getValue"),c=$("#fldNewProductSupplierBarcode").textbox("getValue"),_.isNull(j)||_.isBlank(r)||doServerDataMessage("newproductcode",{productid:j,supplierid:o,code:r,barcode:c},{type:"refresh"})):"clear"==t?$("#divNewProductSupplierCodeG").datagrid("clearSelections"):"remove"==t&&(doGridGetSelectedRowData("divNewProductSupplierCodeG",function(t){doPromptOkCancel("Remove code "+t.code+"?",function(e){e&&doServerDataMessage("expireproductcode",{productcodeid:t.id},{type:"refresh"})})})||doShowError("Please select an attachment to remove"))}function P(e,t){"new"==t?doServerDataMessage("newproductpricing",{productid:j},{type:"refresh"}):"clear"==t?$("#divNewProductPricesG").datagrid("clearSelections"):"edit"==t?doGridStartEdit("divNewProductPricesG",r,function(e,t){r=t,doGridGetEditor("divNewProductPricesG",r,"price",function(e){})}):"cancel"==t?r=doGridCancelEdit("divNewProductPricesG",r):"save"==t?(doGridEndEditGetRow("divNewProductPricesG",r,function(e){doServerDataMessage("saveproductpricing",{priceid:e.id,productid:j,clientid:e.clientid,minqty:e.minqty,maxqty:e.maxqty,price:e.price,price1:e.price1,price2:e.price2,price3:e.price3,price4:e.price4,price5:e.price5},{type:"refresh"})}),r=null):"remove"==t&&(doGridGetSelectedRowData("divNewProductPricesG",function(t){doPromptOkCancel("Remove selected price?",function(e){e&&doServerDataMessage("expireproductpricing",{priceid:t.id},{type:"refresh"})})})||doShowError("Please select a price to remove"))}$("#divEvents").on("checkproductcode",e),$("#divEvents").on("newproduct",t),$("#divEvents").on("saveproduct",t),$("#divEvents").on("listaccounts",d),$("#divEvents").on("listtaxcodes",i),$("#divEvents").on("loadproduct",a),$("#divEvents").on("posgenbarcode",u),$("#divEvents").on("listproductpricing",b),$("#divEvents").on("productpricingupdated",n),$("#divEvents").on("newproductcode",s),$("#divEvents").on("expireproductcode",s),$("#divEvents").on("listproductcodes",l),$("#divEvents").on("productcodecreated",f),$("#divEvents").on("productcodeexpired",f),$("#divEvents").on("productcodepopup",p),$("#divEvents").on("pricingpopup",P),$("#dlgProductNew").dialog({onClose:function(){$("#divEvents").off("checkproductcode",e),$("#divEvents").off("newproduct",t),$("#divEvents").off("saveproduct",t),$("#divEvents").off("listaccounts",d),$("#divEvents").off("listtaxcodes",i),$("#divEvents").off("loadproduct",a),$("#divEvents").off("posgenbarcode",u),$("#divEvents").off("listproductpricing",b),$("#divEvents").off("productpricingupdated",n),$("#divEvents").off("newproductcode",s),$("#divEvents").off("expireproductcode",s),$("#divEvents").off("listproductcodes",l),$("#divEvents").off("productcodecreated",f),$("#divEvents").off("productcodeexpired",f),$("#divEvents").off("productcodepopup",p),$("#divEvents").off("pricingpopup",P),$("#svgNewProductBarcode").empty()},onOpen:function(){$("#fldNewProductCode").textbox({onChange:function(e,t){_.isBlank(e)?$("#btnProductNewCreate").linkbutton("disable"):e!=t&&doServerDataMessage("checkproductcode",{productid:j,code:e},{type:"refresh"})}}),$("#fldNewProductBarcode").textbox({onClickButton:function(){doServerDataMessage("posgenbarcode",{type:barcode_defaultformat},{type:"refresh"})},onChange:function(e,t){_.isBlank(e)?$("#svgNewProductBarcode").empty():e.length==barcode_defaultformat_length||e.length==barcode_defaultformat_length+1?JsBarcode("#svgNewProductBarcode",e,{format:barcode_defaultformat,lineColor:barcode_colour,fontoptions:barcode_fontOptions,textmargin:barcode_textmargin,width:barcode_width,height:barcode_height}):doMandatoryTextbox(barcode_defaultformat.toUpperCase()+" barcodes require "+barcode_defaultformat_length+" digits","fldNewProductBarcode")}}),$("#cbNewProductSupplier").combotree({valueField:"id",textField:"name",multiple:!1,data:cache_suppliers,limitToList:!0,onSelect:function(e){doServerDataMessage("loadsupplier",{supplierid:e.id},{type:"refresh"})}}),$("#fldNewProductSupplierCode").textbox({onChange:function(e,t){if(!_.isBlank(e)&&e!=t){var o=$("#divNewProductSupplierCodeG").datagrid("getData");if(o.rows){for(var r=-1,c=0;c<o.rows.length;c++)if(o.rows[c].code.toUpperCase()==e.toUpperCase()){r=c;break}if(-1!=r)return noty({text:"Product code ["+e+"] is already used",type:"error",timeout:4e3}),void $("#divNewProductSupplierCodeG").datagrid("selectRow",r)}doServerDataMessage("checkproductcode",{productid:j,code:e},{type:"refresh"})}}}),$("#fldNewProductSupplierBarcode").textbox({onChange:function(e,t){_.isBlank(e)||_.isBlank(e)||e.length!=barcode_defaultformat_length&&e.length!=barcode_defaultformat_length+1||JsBarcode("#svgNewProductSupplierBarcode",e,{format:barcode_defaultformat,lineColor:barcode_colour,fontoptions:barcode_fontOptions,textmargin:barcode_textmargin,width:barcode_width,height:barcode_height})}}),$("#cbNewProductClients").combotree({valueField:"id",textField:"name",data:cache_clients}),$("#cbNewProductBuyTaxCode").combobox({valueField:"id",textField:"name",data:cache_taxcodes}),$("#cbNewProductSellTaxCode").combobox({valueField:"id",textField:"name",data:cache_taxcodes}),$("#cbNewProductSalesAccount").combotree({valueField:"id",textField:"name",data:cache_accounts}),$("#cbNewProductIncomeAccount").combotree({valueField:"id",textField:"name",data:cache_accounts}),$("#cbNewProductAssetAccount").combotree({valueField:"id",textField:"name",data:cache_accounts}),$("#cbNewProductBuildTemplate").combotree({valueField:"id",textField:"name",data:cache_buildtemplates}),$("#cbNewProductAlias").combobox({valueField:"id",textField:"code",groupField:"productcategoryname",data:cache_products}),$("#cbNewProductLocation1").combotree({valueField:"id",textField:"name",data:cache_locations}),$("#cbNewProductLocation2").combotree({valueField:"id",textField:"name",data:cache_locations}),$("#divNewProductSupplierCodeG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbProductCodes",columns:[[{title:"Supplier",field:"supplierid",width:200,align:"left",resizable:!0,formatter:function(e,t){return doGetStringFromIdInObjArray(cache_suppliers,e)}},{title:"Code",field:"code",width:100,align:"left",resizable:!0},{title:"Barcode",field:"barcode",width:100,align:"left",resizable:!0}]],onDblClickCell:function(e,t,o){}}),$("#divNewProductPricesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbPricing",columns:[[{title:"Client",field:"clientid",width:200,align:"left",resizable:!0,editor:{type:"combobox",options:{panelWidth:300,valueField:"id",textField:"name",data:cache_clients,onSelect:function(e){console.log(e)}}},formatter:function(e,t){return doGetStringFromIdInObjArray(cache_clients,e)}},{title:"Min Qty",field:"minqty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:0}},formatter:function(e,t,o){return _.niceformatqty(e)},align:"right"},{title:"Max Qty",field:"maxqty",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:0}},formatter:function(e,t,o){return _.niceformatqty(e)},align:"right"},{title:"Price",field:"price",width:100,align:"right",resizable:!0,editor:{type:"numberbox",options:{groupSeparator:",",precision:2}},formatter:function(e,t,o){return _.niceformatnumber(e)},align:"right"},{title:"Date From",field:"datefrom",width:150,align:"right",resizable:!0,editor:{type:"datebox"},formatter:function(e,t,o){return _.nicejsdatetodisplay(e)},align:"right"},{title:"Date To",field:"dateto",width:150,align:"right",resizable:!0,editor:{type:"datebox"},formatter:function(e,t,o){return _.nicejsdatetodisplay(e)},align:"right"},{title:"Modified",field:"date",width:150,align:"right",resizable:!0,align:"right"},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,o){doGridContextMenu("divNewProductPricesG","divPricingMenuPopup",e,t,o)},onDblClickCell:function(e,o,t){doGridStartEdit("divNewProductPricesG",r,function(e,t){r=t,-1!=["modified","by"].indexOf(o)&&(o="minqty"),doGridGetEditor("divNewProductPricesG",r,o,function(e){})})}}),$("#newproducttabs").tabs({selected:0}),H?$("#btnProductNewAdd").linkbutton({text:"Add"}):$("#btnProductNewAdd").linkbutton({text:"Save"}),_.isNull(j)?c():(doServerDataMessage("loadproduct",{productid:j},{type:"refresh"}),doServerDataMessage("listproductcodes",{productid:j},{type:"refresh"}),doServerDataMessage("listproductpricing",{productid:j},{type:"refresh"}))},buttons:[{text:"Add",disabled:!0,id:"btnProductNewAdd",handler:function(){var e=$("#fldNewProductCode").textbox("getValue"),t=$("#fldNewProductName").textbox("getValue");if(_.isBlank(e)||_.isBlank(t))doMandatoryTextbox("Need at least a product code and name","fldNewProductCode");else{var o=$("#fldNewProductBarcode").textbox("getValue"),r=$("#fldNewProductAltcode").textbox("getValue"),c=$("#fldNewProductCostPrice").numberbox("getValue"),d=$("#fldNewProductUOM").textbox("getValue"),i=$("#fldNewProductUOMSize").numberbox("getValue"),a=doGetComboTreeSelectedId("cbNewProductClients"),u=doSwitchButtonChecked("cbNewProductActive"),l=$("#cbNewProductBuyTaxCode").combobox("getValue"),n=$("#cbNewProductSellTaxCode").combobox("getValue"),b=doGetComboTreeSelectedId("cbNewProductSalesAccount"),s=doGetComboTreeSelectedId("cbNewProductIncomeAccount"),f=doGetComboTreeSelectedId("cbNewProductAssetAccount"),p=doGetComboTreeSelectedId("cbNewProductBuildTemplate"),P=$("#fldNewProductMinQty").numberbox("getValue"),m=$("#fldNewProductWarnQty").numberbox("getValue"),w=$("#cbNewProductAlias").combobox("getValue"),x=$("#cbNewProductLocation1").combobox("getValue"),N=$("#cbNewProductLocation2").combobox("getValue"),g=$("#fldNewProductWidth").numberbox("getValue"),v=$("#fldNewProducLength").numberbox("getValue"),h=$("#fldNewProductHeight").numberbox("getValue"),y=$("#fldNewProductWeight").numberbox("getValue"),V=$("#fldNewProductPrice1").numberbox("getValue"),S=$("#fldNewProductPrice2").numberbox("getValue"),C=$("#fldNewProductPrice3").numberbox("getValue"),A=$("#fldNewProductPrice4").numberbox("getValue"),E=$("#fldNewProductPrice5").numberbox("getValue"),B=$("#fldNewProductPrice6").numberbox("getValue"),G=$("#fldNewProductPrice7").numberbox("getValue"),q=$("#fldNewProductPrice8").numberbox("getValue"),M=$("#fldNewProductPrice9").numberbox("getValue"),D=$("#fldNewProductPrice10").numberbox("getValue"),F=$("#fldNewProductPrice11").numberbox("getValue"),k=$("#fldNewProductPrice12").numberbox("getValue"),T=$("#fldNewProductPrice13").numberbox("getValue"),z=$("#fldNewProductPrice14").numberbox("getValue"),O=$("#fldNewProductPrice15").numberbox("getValue"),I=$("#fldNewProductAttrib1").textbox("getValue"),L=$("#fldNewProductAttrib2").textbox("getValue"),U=$("#fldNewProductAttrib3").textbox("getValue"),W=$("#fldNewProductAttrib4").textbox("getValue"),Q=$("#fldNewProductAttrib5").textbox("getValue");H?doServerDataMessage("newproduct",{productcategoryid:R,code:e,name:t,barcode:o,altcode:r,costprice:c,uom:d,uomsize:i,clientid:a,isactive:u,buytaxcodeid:l,selltaxcodeid:n,costofgoodsaccountid:b,incomeaccountid:s,assetaccountid:f,buildtemplateid:p,minqty:P,warnqty:m,productaliasid:w,location1id:x,location2id:N,width:g,length:v,height:h,weight:y,price1:V,price2:S,price3:C,price4:A,price5:E,price6:B,price7:G,price8:q,price9:M,price10:D,price11:F,price12:k,price13:T,price14:z,price15:O,attrib1:I,attrib2:L,attrib3:U,attrib4:W,attrib5:Q},{type:"refresh"}):doServerDataMessage("saveproduct",{productid:j,productcategoryid:R,name:t,code:e,barcode:o,altcode:r,costprice:c,uom:d,uomsize:i,clientid:a,isactive:u,buytaxcodeid:l,selltaxcodeid:n,costofgoodsaccountid:b,incomeaccountid:s,assetaccountid:f,buildtemplateid:p,minqty:P,warnqty:m,productaliasid:w,location1id:x,location2id:N,width:g,length:v,height:h,weight:y,price1:V,price2:S,price3:C,price4:A,price5:E,price6:B,price7:G,price8:q,price9:M,price10:D,price11:F,price12:k,price13:T,price14:z,price15:O,attrib1:I,attrib2:L,attrib3:U,attrib4:W,attrib5:Q},{type:"refresh"})}}},{text:"Reset",handler:function(){c()}},{text:"Close",handler:function(){$("#dlgProductNew").dialog("close")}}]}).dialog("center").dialog("open")}