function doDlgUserNew(u){var b=_.isUndefined(u)||_.isNull(u),s={};function l(){b?($("#cbNewUserClient").combotree("clear"),$("#cbNewUserAvatar").combobox("clear"),$("#fldNewUserName").textbox("clear"),$("#fldNewUserUid").textbox("clear"),$("#fldNewUserPwd1").textbox("clear"),$("#fldNewUserPwd2").textbox("clear"),$("#fldNewUserEmail").textbox("clear"),$("#fldNewUserMobile").textbox("clear"),$("#cbNewUserIsAdmin").switchbutton("uncheck"),$("#fldNewUserPwd1").textbox("enable"),$("#fldNewUserPwd2").textbox("enable"),$("#btnUserNewAdd").linkbutton("disable")):_.isEmpty(s)||($("#cbNewUserClient").combotree("setValue",s.clientid),$("#cbNewUserAvatar").combobox("setValue",s.avatar),$("#fldNewUserName").textbox("setValue",s.name),$("#fldNewUserUid").textbox("setValue",s.uid),$("#fldNewUserEmail").textbox("setValue",s.email),$("#fldNewUserMobile").textbox("setValue",s.phone),$("#cbNewUserIsAdmin").switchbutton(s.isadmin?"check":"uncheck"),$("#fldNewUserPwd1").textbox("clear"),$("#fldNewUserPwd2").textbox("clear"),$("#fldNewUserPwd1").textbox("disable"),$("#fldNewUserPwd2").textbox("disable"),$("#btnUserNewAdd").linkbutton("enable"),$("#dlgUserNew").dialog("setTitle","Modify "+s.name)),doTextboxFocus("fldNewUserName")}function a(){var e=$("#fldNewUserPwd1").passwordbox("getValue"),t=$("#fldNewUserPwd2").passwordbox("getValue");_.isBlank(e)||e!=t?$("#btnUserNewAdd").linkbutton("disable"):$("#btnUserNewAdd").linkbutton("enable")}function e(e,t){var s=t.data.rs;0<s.length?(doShowError("Login name ["+s[0].uid+"] is already been used by user ["+s[0].name+"]"),$("#btnUserNewAdd").linkbutton("disable")):$("#btnUserNewAdd").linkbutton("enable")}function t(e,t){$("#dlgUserNew").dialog("close")}function d(e,t){s=t.data.user,l()}function o(e,t){_.isUndefined(t.data.uuid)||t.data.uuid!=u||doServerDataMessage("lastuserpoll",{useruuid:u},{type:"refresh"})}function n(e,t){_.isUndefined(t.data)||_.isUndefined(t.data.poll)||($("#spnPollDate").html(t.data.poll.datecreated),$("#spnPollBattery").html(mapBatteryToImage(t.data.poll.batterylevel)),$("#imgBatteryLevel").reflect({height:.45,opacity:.5}),$("#spnPollLocation").html("("+t.data.poll.gpslat+", ("+t.data.poll.gpslon+")"),$("#spnPollSystemName").html(t.data.poll.systemname),$("#spnPollAppVersion").html(t.data.poll.appversion),$("#spnPollSSID").html(t.data.poll.ssid),$("#spnPollAddress").html(t.data.poll.address),$("#spnPollReason").html(t.data.poll.reason))}$("#divEvents").on("checkuseruid",e),$("#divEvents").on("newuser",t),$("#divEvents").on("saveuser",t),$("#divEvents").on("loaduser",d),$("#divEvents").on("lastuserpoll",n),$("#divEvents").on("userpolled",o),$("#divEvents").on("userpaused",o),$("#divEvents").on("useronline",o),$("#divEvents").on("useroffline",o),$("#dlgUserNew").dialog({onClose:function(){$("#divEvents").off("checkuseruid",e),$("#divEvents").off("newuser",t),$("#divEvents").off("saveuser",t),$("#divEvents").off("loaduser",d),$("#divEvents").off("lastuserpoll",n),$("#divEvents").off("userpolled",o),$("#divEvents").off("userpaused",o),$("#divEvents").off("useronline",o),$("#divEvents").off("useroffline",o),$("#spnPollDate").html(""),$("#spnPollBattery").html(""),$("#spnPollLocation").html(""),$("#spnPollSystemName").html(""),$("#spnPollAppVersion").html(""),$("#spnPollSSID").html(""),$("#spnPollAddress").html(""),$("#spnPollReason").html("")},onOpen:function(){$("#fldNewUserUid").textbox({onChange:function(e,t){_.isBlank(e)?$("#btnUserNewAdd").linkbutton("disable"):e!=t&&doServerDataMessage("checkuseruid",{useruuid:u,uid:e},{type:"refresh"})}}),$("#fldNewUserPwd1").passwordbox({onChange:function(e,t){a()}}),$("#fldNewUserPwd2").passwordbox({onChange:function(e,t){a()}}),$("#cbNewUserClient").combotree({valueField:"id",textField:"name",data:cache_clients}),$("#cbNewUserAvatar").combobox({valueField:"image",textField:"name",formatter:function(e){return mapAvatarToImage(e.image)+"&nbsp;"+e.name},data:avatars}),b?$("#btnUserNewAdd").linkbutton({text:"Add"}):$("#btnUserNewAdd").linkbutton({text:"Save"}),_.isUndefined(u)||_.isNull(u)?l():(doServerDataMessage("loaduser",{useruuid:u},{type:"refresh"}),doServerDataMessage("lastuserpoll",{useruuid:u},{type:"refresh"}))},buttons:[{text:"Add",disabled:!0,id:"btnUserNewAdd",handler:function(){var e=doGetComboTreeSelectedId("cbNewUserClient"),t=$("#fldNewUserName").textbox("getValue"),s=$("#fldNewUserUid").textbox("getValue"),l=$("#fldNewUserPwd1").passwordbox("getValue"),a=$("#fldNewUserPwd2").passwordbox("getValue"),d=$("#fldNewUserEmail").textbox("getValue"),o=$("#fldNewUserMobile").textbox("getValue"),n=$("#cbNewUserAvatar").combobox("getValue"),r=doSwitchButtonChecked("cbNewUserIsAdmin")?1:0,i=_.isBlank(e)?0:1;_.isBlank(t)?doMandatoryTextbox("Please enter a user name","fldNewUserName"):_.isBlank(s)?doMandatoryTextbox("Please enter a unique login name","fldNewUserUid"):b?_.isBlank(l==a)?doMandatoryTextbox("Passwords do not match","fldNewUserPwd1"):doServerDataMessage("newuser",{clientid:e,name:t,uid:s,pwd:l,email:d,mobile:o,avatar:n,isadmin:r,isclient:i},{type:"refresh"}):doServerDataMessage("saveuser",{useruuid:u,clientid:e,name:t,uid:s,email:d,mobile:o,avatar:n,isadmin:r,isclient:i},{type:"refresh"})}},{text:"Reset",handler:function(){l()}},{text:"Close",handler:function(){$("#dlgUserNew").dialog("close")}}]}).dialog("center").dialog("open")}