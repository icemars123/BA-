var selectedClientIdAttachmentId=null;function doDlgClientNew(e,W){var X=_.isUndefined(W)||_.isNull(W),i={},t=[],n=[],l=null,o=null,d=null,a=null,c=null;function Z(){doGridEndEditGetRow("divNewClientNotesG",l,function(e){var t=nicEditors.findEditor(a).getContent();doServerDataMessage("saveclientnote",{clientnoteid:e.id,notes:t},{type:"refresh"}),d.removeInstance(a),l=d=o=null})}function s(e,t){W==t.data.clientid&&doServerDataMessage("listclientnotes",{clientid:W},{clientnoteid:t.data.clientnoteid,type:"refresh"})}function r(e,t){t.data.rs.forEach(function(e){$("#divNewClientNotesG").datagrid("selectRecord",e.id)})}function b(e,t){W==t.data.clientid&&doServerDataMessage("listclientattachments",{clientid:W},{type:"refresh"})}function x(e,t){var i=[];t.data.rs.forEach(function(e){i.push({id:doNiceId(e.id),name:doNiceString(e.name),description:doNiceString(e.description),mimetype:'<a href="javascript:void(0);" onClick="doThrowClientAttachment('+e.id+');">'+mapMimeTypeToImage(e.mimetype)+"</a>",size:doNiceString(e.size),isthumbnail:e.isthumbnail,image:'<image src="'+e.image+'" width="35px">',date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewClientAttachmentsG").datagrid("loadData",i)}function u(){$("#cbNewClientParent").combotree("setValue",e),X?($("#fldNewClientName").textbox("clear"),$("#fldNewClientCode").textbox("clear"),$("#fldNewClientContact1").textbox("clear"),$("#fldNewClientContact2").textbox("clear"),$("#fldNewClientContact3").textbox("clear"),$("#fldNewClientContact4").textbox("clear"),$("#fldNewClientEmail1").textbox("clear"),$("#fldNewClientUrl1").textbox("clear"),$("#fldNewClientMobile3").textbox("clear"),$("#fldNewClientMobile4").textbox("clear"),$("#fldNewClientPhone1").textbox("clear"),$("#fldNewClientPhone2").textbox("clear"),$("#fldNewClientPhone3").textbox("clear"),$("#fldNewClientFax3").textbox("clear"),$("#fldNewClientAddress1").textbox("clear"),$("#fldNewClientAddress2").textbox("clear"),$("#fldNewClientAddress3").textbox("clear"),$("#fldNewClientAddress4").textbox("clear"),$("#fldNewClientCity").textbox("clear"),$("#fldNewClientPostcode").textbox("clear"),$("#cbNewClientCountry").combobox("clear"),$("#cbNewClientState").combobox("clear"),$("#fldNewClientShippingAddress1").textbox("clear"),$("#fldNewClientShippingAddress2").textbox("clear"),$("#fldNewClientShippingAddress3").textbox("clear"),$("#fldNewClientShippingAddress4").textbox("clear"),$("#fldNewClientShippingCity").textbox("clear"),$("#fldNewClientShippingPostcode").textbox("clear"),$("#cbNewClientShippingCountry").combobox("clear"),$("#cbNewClientShippingState").combobox("clear"),$("#fldNewClientBankName").textbox("clear"),$("#fldNewClientBankBsb").textbox("clear"),$("#fldNewClientBankAcctNo").textbox("clear"),$("#fldNewClientBankAcctName").textbox("clear"),$("#fldNewClientDaysCredit").numberbox("clear"),$("#fldNewClientLineLimit").numberbox("clear"),$("#fldNewClientOrderLimit").numberbox("clear"),$("#fldNewClientCreditLimit").numberbox("clear"),$("#cbNewClientOrderTemplate").combobox("clear"),$("#cbNewClientQuoteTemplate").combobox("clear"),$("#cbNewClientInvoiceTemplate").combobox("clear"),$("#cbNewClientLabelTemplate").combobox("clear"),$("#fldNewClientAcn").textbox("clear"),$("#fldNewClientAbn").textbox("clear"),$("#fldNewClientHsCode").textbox("clear"),$("#fldNewClientCustom1").textbox("clear"),$("#fldNewClientCustom2").textbox("clear"),$("#btnClientNewAdd").linkbutton("disable"),$("#cbNewClientCountry").combobox("setValue",defaultCountry),$("#cbNewClientShippingCountry").combobox("setValue",defaultCountry)):_.isEmpty(i)||($("#fldNewClientName").textbox("initValue",i.name),$("#fldNewClientCode").textbox("setValue",i.code),$("#fldNewClientContact1").textbox("setValue",i.contact1),$("#fldNewClientContact2").textbox("setValue",i.contact2),$("#fldNewClientContact3").textbox("setValue",i.contact3),$("#fldNewClientContact4").textbox("setValue",i.contact4),$("#fldNewClientEmail1").textbox("setValue",i.email1),$("#fldNewClientUrl1").textbox("setValue",i.url1),$("#fldNewClientMobile3").textbox("setValue",i.mobile3),$("#fldNewClientMobile4").textbox("setValue",i.mobile4),$("#fldNewClientPhone1").textbox("setValue",i.phone1),$("#fldNewClientPhone2").textbox("setValue",i.phone2),$("#fldNewClientPhone3").textbox("setValue",i.phone3),$("#fldNewClientFax3").textbox("setValue",i.fax3),$("#fldNewClientAddress1").textbox("setValue",i.address1),$("#fldNewClientAddress2").textbox("setValue",i.address2),$("#fldNewClientAddress3").textbox("setValue",i.address3),$("#fldNewClientAddress4").textbox("setValue",i.address4),$("#fldNewClientCity").textbox("setValue",i.city),$("#fldNewClientPostcode").textbox("setValue",i.postcode),$("#cbNewClientCountry").combobox("setValue",i.country),$("#cbNewClientState").combobox("setValue",i.state),$("#fldNewClientShippingAddress1").textbox("setValue",i.shipaddress1),$("#fldNewClientShippingAddress2").textbox("setValue",i.shipaddress2),$("#fldNewClientShippingAddress3").textbox("setValue",i.shipaddress3),$("#fldNewClientShippingAddress4").textbox("setValue",i.shipaddress4),$("#fldNewClientShippingCity").textbox("setValue",i.shipcity),$("#fldNewClientShippingPostcode").textbox("setValue",i.shippostcode),$("#cbNewClientShippingCountry").combobox("setValue",i.shipcountry),$("#cbNewClientShippingState").combobox("setValue",i.shipstate),$("#fldNewClientBankName").textbox("setValue",i.bankname),$("#fldNewClientBankBsb").textbox("setValue",i.bankbsb),$("#fldNewClientBankAcctNo").textbox("setValue",i.bankaccountno),$("#fldNewClientBankAcctName").textbox("setValue",i.banlaccountname),$("#fldNewClientDaysCredit").numberbox("setValue",i.dayscredit),$("#fldNewClientLineLimit").numberbox("setValue",i.linelimit),$("#fldNewClientOrderLimit").numberbox("setValue",i.orderlimit),$("#fldNewClientCreditLimit").numberbox("setValue",i.creditlimit),$("#cbNewClientOrderTemplate").combobox("setValue",i.ordertemplateid),$("#cbNewClientQuoteTemplate").combobox("setValue",i.quotetemplateid),$("#cbNewClientInvoiceTemplate").combobox("setValue",i.invoicetemplateid),$("#cbNewClientLabelTemplate").combobox("setValue",i.labeltemplateid),$("#fldNewClientAcn").textbox("setValue",i.acn),$("#fldNewClientAbn").textbox("setValue",i.abn),$("#fldNewClientHsCode").textbox("setValue",i.hscode),$("#fldNewClientCustom1").textbox("setValue",i.custcode1),$("#fldNewClientCustom2").textbox("setValue",i.custcode2),doSetSwitchButton("cbNewClientIsActive",i.isactive),$("#btnClientNewAdd").linkbutton("enable"),$("#dlgClientNew").dialog("setTitle","Modify "+i.name)),doTextboxFocus("fldNewClientName")}function C(e,t){0<t.data.rs.length?$("#btnClientNewAdd").linkbutton("disable"):$("#btnClientNewAdd").linkbutton("enable")}function f(e,t){$("#dlgClientNew").dialog("close")}function N(e,t){i=t.data.client,u()}function m(e,t){_.isUndefined(t.data.rs.Names)||doDlgPickABN(t.data.rs.Names)}function w(e,t){$("#fldNewClientName").textbox("initValue",t.name),$("#fldNewClientAbn").textbox("setValue",t.abn)}function p(e,t){"new"==t?doServerDataMessage("newclientnote",{clientid:W},{type:"refresh"}):"clear"==t?$("#divNewClientNotesG").datagrid("clearSelections"):"edit"==t?doGridGetSelectedRowData("divNewClientNotesG",function(e,t){_.isNull(l)&&(l=t,a="divClientNote-id-"+e.id,o=$("#"+a).html(),d=new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"}).panelInstance(a,{hasPanel:!0}))}):"cancel"==t?l=doGridCancelEdit("divNewClientNotesG",l,function(){d.removeInstance(a),$("#"+a).html(o),d=o=null}):"save"==t?Z():"remove"==t?doGridGetSelectedRowData("divNewClientNotesG",function(t){doPromptOkCancel("Remove selected note?",function(e){e&&doServerDataMessage("expireclientnote",{clientnoteid:t.id},{type:"refresh"})})})||doShowError("Please select a note to remove"):"search"==t&&doDlgNoteSearch(function(e){doServerDataMessage("searchclientnote",{clientid:W,words:e},{type:"refresh"})},function(){doServerDataMessage("listclientnotes",{clientid:W},{type:"refresh"})})}function h(e,t){"clear"==t?$("#divNewClientAttachmentsG").datagrid("clearSelections"):"edit"==t?doGridStartEdit("divNewClientAttachmentsG",c,function(e,t){c=t,doGridGetEditor("divNewClientAttachmentsG",c,"description",function(e){})}):"cancel"==t?c=doGridCancelEdit("divNewClientAttachmentsG",c):"save"==t?(doGridEndEditGetRow("divNewClientAttachmentsG",c,function(e){doServerDataMessage("saveclientattachment",{clientattachmentid:e.id,description:e.description,isthumbnail:e.isthumbnail},{type:"refresh"})}),c=null):"remove"==t?doGridGetSelectedRowData("divNewClientAttachmentsG",function(t){doPromptOkCancel("Remove attachment "+t.description+"?",function(e){e&&doServerDataMessage("expireclientattachment",{clientattachmentid:t.id},{type:"refresh"})})})||doShowError("Please select an attachment to remove"):"download"==t&&doGridGetSelectedRowData("divNewClientAttachmentsG",function(e){doThrowClientAttachment(e.id)})}$("#divEvents").on("newclientnote",s),$("#divEvents").on("saveclientnote",s),$("#divEvents").on("expireclientnote",s),$("#divEvents").on("clientnotecreated",s),$("#divEvents").on("clientnotesaved",s),$("#divEvents").on("clientnoteexpired",s),$("#divEvents").on("listclientnotes",function(e,t){var i=[];t.data.rs.forEach(function(e){i.push({id:doNiceId(e.id),notes:doNiceString(e.notes),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divNewClientNotesG").datagrid("loadData",i),_.isUndefined(t.pdata.clientnoteid)||_.isNull(t.pdata.clientnoteid)||$("#divNewClientNotesG").datagrid("selectRecord",t.pdata.clientnoteid)}),$("#divEvents").on("searchclientnote",r),$("#divEvents").on("listclientattachments",x),$("#divEvents").on("clientattachmentcreated",b),$("#divEvents").on("clientattachmentsaved",b),$("#divEvents").on("clientattachmentexpired",b),$("#divEvents").on("saveclientattachment",b),$("#divEvents").on("expireclientattachment",b),$("#divEvents").on("checkclientcode",C),$("#divEvents").on("newclient",f),$("#divEvents").on("saveclient",f),$("#divEvents").on("loadclient",N),$("#divEvents").on("abnlookup",m),$("#divEvents").on("abnselected",w),$("#divEvents").on("clientnotespopup",p),$("#divEvents").on("clientattachmentspopup",h),$("#dlgClientNew").dialog({onClose:function(){$("#divEvents").off("newclientnote",s),$("#divEvents").off("saveclientnote",s),$("#divEvents").off("clientnotecreated",s),$("#divEvents").off("clientnotesaved",s),$("#divEvents").off("listclientnotes",N),$("#divEvents").off("searchclientnote",r),$("#divEvents").off("listorderattachments",x),$("#divEvents").off("orderattachmentcreated",b),$("#divEvents").off("orderattachmentsaved",b),$("#divEvents").off("orderattachmentexpired",b),$("#divEvents").off("saveorderattachment",b),$("#divEvents").off("expireorderattachment",b),$("#divEvents").off("checkclientcode",C),$("#divEvents").off("newclient",f),$("#divEvents").off("saveclient",f),$("#divEvents").off("loadclient",N),$("#divEvents").off("abnlookup",m),$("#divEvents").off("abnselected",w),$("#divEvents").off("clientnotespopup",p),$("#divEvents").off("clientattachmentspopup",h),$("#newclienttabs").tabs("select",0),$("#divNewClientNotesG").datagrid("loadData",[])},onOpen:function(){selectedClientIdAttachmentId=W,$("#cbNewClientParent").combotree({valueField:"id",textField:"name",data:cache_clients}),$("#fldNewClientName").textbox({onChange:function(e,t){_.isBlank(e)?$("#btnClientNewAdd").linkbutton("disable"):(doServerDataMessage("abnlookup",{name:e},{type:"refresh"}),$("#btnClientNewAdd").linkbutton("enable"))}}),$("#fldNewClientCode").textbox({onChange:function(e,t){_.isBlank(e)||e!=t&&doServerDataMessage("checkclientcode",{clientid:W,code:e},{type:"refresh"})}}),$("#cbNewClientPriceLevel").combobox({valueField:"id",textField:"name",limitToList:!0,data:pricelevels}),$("#cbNewClientIsActive").switchbutton({checked:!0,onText:"Yes",offText:"No"}),$("#cbNewClientCountry").combobox({valueField:"country",textField:"country",limitToList:!0,data:cache_countries,onSelect:function(e){t=doGetStatesFromCountry(e.country),$("#cbNewClientState").combobox("loadData",t)}}),$("#cbNewClientShippingCountry").combobox({valueField:"country",textField:"country",limitToList:!0,data:cache_countries,onSelect:function(e){n=doGetStatesFromCountry(e.country),$("#cbNewClientShippingState").combobox("loadData",n)}}),$("#cbNewClientState").combobox({valueField:"state",textField:"state",limitToList:!0,data:t}),$("#cbNewClientShippingState").combobox({valueField:"state",textField:"state",limitToList:!0,data:n}),$("#cbNewClientOrderTemplate").combobox({valueField:"id",textField:"description",limitToList:!0,data:cache_printtemplates}),$("#cbNewClientQuoteTemplate").combobox({valueField:"id",textField:"description",limitToList:!0,data:cache_printtemplates}),$("#cbNewClientInvoiceTemplate").combobox({valueField:"id",textField:"description",limitToList:!0,data:cache_printtemplates}),$("#cbNewClientLabelTemplate").combobox({valueField:"id",textField:"description",limitToList:!0,data:cache_printtemplates}),$("#divNewClientNotesG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,toolbar:"#tbClientNotes",view:$.extend({},$.fn.datagrid.defaults.view,{renderRow:function(e,t,i,n,l){var o=[];return!i&&l.id?o.push('<td style="width: 950px;; padding: 5px 5px; border: 0;">  <div style="float: left; margin-left: 10px;">    <p><span class="c-label">Modified: </span>'+l.date+'</p>    <p><span class="c-label">By: </span>'+l.by+'</p>  </div>  <div style="clear: both;"></div>  <div id="divClientNote-id-'+l.id+'" style="float: left; margin-left: 10px; margin-right: 10px; width: 100%; height: 100px; border: 1px dashed #ddd">'+l.notes+"</div> </td>"):o.push('<td style="width: 100%; padding: 5px 5px; border: 0;"></td>'),o.join("")}}),onDblClickRow:function(e,t){_.isNull(l)&&t&&(l=e,a="divClientNote-id-"+t.id,o=$("#"+a).html(),d=new nicEditor({fullPanel:!0,iconsPath:"/js/nicedit/nicEditorIcons.gif"}).panelInstance(a,{hasPanel:!0}))}}),$("#divNewClientAttachmentsG").datagrid({idField:"id",fitColumns:!0,singleSelect:!0,rownumbers:!1,striped:!0,toolbar:"#tbClientAttachments",columns:[[{title:"Name",field:"name",width:200,align:"left",resizable:!0},{title:"Description",field:"description",width:300,align:"left",resizable:!0,editor:"text"},{title:"Type",field:"mimetype",width:100,align:"center",resizable:!0},{title:"Size",field:"size",width:150,align:"right",resizable:!0,formatter:function(e,t){return filesize(e,{base:10})}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0}]],onRowContextMenu:function(e,t,i){doGridContextMenu("divNewClientAttachmentsG","divClientAttachmentsMenuPopup",e,t,i)},onDblClickCell:function(e,t,i){doGridStartEdit("divNewClientAttachmentsG",c,function(e,t){c=t,doGridGetEditor("divNewClientAttachmentsG",c,"description",function(e){})})}}),X?$("#btnClientNewAdd").linkbutton({text:"Add"}):$("#btnClientNewAdd").linkbutton({text:"Save"}),_.isUndefined(W)||_.isNull(W)?u():(doServerDataMessage("loadclient",{clientid:W},{type:"refresh"}),doServerDataMessage("listclientattachments",{clientid:W},{type:"refresh"}),doServerDataMessage("listclientnotes",{clientid:W},{type:"refresh"})),$("#newclienttabs").tabs({selected:0})},buttons:[{text:"Add",id:"btnClientNewAdd",handler:function(){var e=doGetComboTreeSelectedId("cbNewClientParent"),t=$("#fldNewClientName").textbox("getValue"),i=$("#fldNewClientCode").textbox("getValue"),n=$("#fldNewClientEmail1").textbox("getValue"),l=$("#fldNewClientUrl1").textbox("getValue"),o=$("#fldNewClientMobile3").textbox("getValue"),d=$("#fldNewClientMobile4").textbox("getValue"),a=$("#fldNewClientPhone1").textbox("getValue"),c=$("#fldNewClientPhone2").textbox("getValue"),s=$("#fldNewClientPhone3").textbox("getValue"),r=$("#fldNewClientFax3").textbox("getValue"),b=$("#fldNewClientContact1").textbox("getValue"),x=$("#fldNewClientContact2").textbox("getValue"),u=$("#fldNewClientContact3").textbox("getValue"),C=$("#fldNewClientContact4").textbox("getValue"),f=$("#fldNewClientBankName").textbox("getValue"),N=$("#fldNewClientBankBsb").textbox("getValue"),m=$("#fldNewClientBankAcctNo").textbox("getValue"),w=$("#fldNewClientBankAcctName").textbox("getValue"),p=$("#fldNewClientAddress1").textbox("getValue"),h=$("#fldNewClientAddress2").textbox("getValue"),v=$("#fldNewClientAddress3").textbox("getValue"),g=$("#fldNewClientAddress4").textbox("getValue"),V=$("#fldNewClientCity").textbox("getValue"),y=$("#fldNewClientPostcode").textbox("getValue"),S=$("#cbNewClientCountry").combobox("getValue"),A=$("#cbNewClientState").combobox("getValue"),E=$("#fldNewClientShippingAddress1").textbox("getValue"),k=$("#fldNewClientShippingAddress2").textbox("getValue"),G=$("#fldNewClientShippingAddress3").textbox("getValue"),D=$("#fldNewClientShippingAddress4").textbox("getValue"),T=$("#fldNewClientShippingCity").textbox("getValue"),M=$("#fldNewClientShippingPostcode").textbox("getValue"),P=$("#cbNewClientShippingCountry").combobox("getValue"),F=$("#cbNewClientShippingState").combobox("getValue"),L=$("#fldNewClientDaysCredit").numberbox("getValue"),B=$("#fldNewClientLineLimit").numberbox("getValue"),I=$("#fldNewClientOrderLimit").numberbox("getValue"),R=$("#fldNewClientCreditLimit").numberbox("getValue"),O=$("#cbNewClientOrderTemplate").combobox("getValue"),z=$("#cbNewClientQuoteTemplate").combobox("getValue"),U=$("#cbNewClientInvoiceTemplate").combobox("getValue"),j=$("#cbNewClientLabelTemplate").combobox("getValue"),Q=$("#fldNewClientAcn").textbox("getValue"),q=$("#fldNewClientAbn").textbox("getValue"),H=$("#fldNewClientHsCode").textbox("getValue"),Y=$("#fldNewClientCustom1").textbox("getValue"),J=$("#fldNewClientCustom2").textbox("getValue"),K=doSwitchButtonChecked("cbNewClientIsActive");_.isBlank(t)?doMandatoryTextbox("Please enter an client name","fldNewClientName"):X?doServerDataMessage("newclient",{parentid:e,name:t,code:i,email1:n,url1:l,mobile3:o,mobile4:d,phone1:a,phone2:c,phone3:s,fax3:r,contact1:b,contact2:x,contact3:u,contact4:C,address1:p,address2:h,address3:v,address4:g,city:V,state:A,postcode:y,country:S,shiptoaddress1:E,shiptoaddress2:k,shiptoaddress3:G,shiptoaddress4:D,shiptocity:T,shiptostate:F,shiptopostcode:M,shiptocountry:P,bankname:f,bankbsb:N,bankaccountno:m,bankaccountname:w,dayscredit:L,linelimit:B,orderlimit:I,creditlimit:R,invoicetemplateid:U,ordertemplateid:O,qoutetemplateid:z,labeltemplateid:j,isactive:K,issupplier:!1,isclient:!0,acn:Q,abn:q,hscode:H,custcode1:Y,custcode2:J},{type:"refresh"}):(Z(),doServerDataMessage("saveclient",{clientid:W,parentid:e,name:t,code:i,email1:n,url1:l,mobile3:o,mobile4:d,phone1:a,phone2:c,phone3:s,fax3:r,contact1:b,contact2:x,contact3:u,contact4:C,address1:p,address2:h,address3:v,address4:g,city:V,state:A,postcode:y,country:S,shiptoaddress1:E,shiptoaddress2:k,shiptoaddress3:G,shiptoaddress4:D,shiptocity:T,shiptostate:F,shiptopostcode:M,shiptocountry:P,bankname:f,bankbsb:N,bankaccountno:m,bankaccountname:w,dayscredit:L,linelimit:B,orderlimit:I,creditlimit:R,invoicetemplateid:U,ordertemplateid:O,qoutetemplateid:z,labeltemplateid:j,isactive:K,issupplier:!1,isclient:!0,acn:Q,abn:q,hscode:H,custcode1:Y,custcode2:J},{type:"refresh"}))}},{text:"Reset",handler:function(){u()}},{text:"Close",handler:function(){$("#dlgClientNew").dialog("close")}}]}).dialog("center").dialog("open")}