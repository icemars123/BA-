var pordersTabWidgetsLoaded=!1;function doPOrdersTabWidgets(){function e(e,r){primus.emit("listporders",{fguid:fguid,uuid:uuid,session:session,pdata:{type:"refresh"}})}pordersTabWidgetsLoaded||(pordersTabWidgetsLoaded=!0,$("#divEvents").on("searchporders",function(e,r){}),$("#divEvents").on("listporders",function(e,r){$("#divPurchaseOrdersG").datagrid("clearSelections"),$("#divPurchaseOrdersG").datagrid("reload"),_.isUndefined(r.pdata.porderid)||_.isNull(r.pdata.porderid)||$("#divPurchaseOrdersG").datagrid("selectRecord",r.pdata.porderid)}),$("#divEvents").on("newporder",e),$("#divEvents").on("saveporder",e),$("#divEvents").on("expireporder",e),$("#divEvents").on("completeporder",e),$("#divEvents").on("pordercompleted",e),$("#divEvents").on("newporderdetail",e),$("#divEvents").on("saveporderdetail",e),$("#divEvents").on("expireporderdetail",e),$("#divEvents").on("porderdetailcreated",e),$("#divEvents").on("porderdetailsaved",e),$("#divEvents").on("porderdetailexpired",e),$("#divEvents").on("pordercreated",e),$("#divEvents").on("pordersaved",e),$("#divEvents").on("porderexpired",e),$("#divEvents").on("porderduplicated",e),$("#divEvents").on("porderspaid",e),$("#divEvents").on("saveaccount",e),$("#divEvents").on("savesupplier",e),$("#divEvents").on("suppliersaved",e),$("#divEvents").on("duplicateporder",function(e,r){noty({text:"New purchase order "+r.data.porderno+" created",type:"warning",timeout:4e3}),primus.emit("listporders",{fguid:fguid,uuid:uuid,session:session,pdata:{type:"refresh"}})}),$("#divEvents").on("new-supplier-porder",function(e,r){primus.emit("newpordersupplier",{fguid:fguid,uuid:uuid,session:session,name:"New P.O.",clientid:r.id,pdata:{type:"refresh"}}),doSelectPurchasingTab("Purchase Orders")}),$("#divEvents").on("selectporderid",function(e,r){_.isUndefined(r.id)||_.isNull(r.id)||$("#divPurchaseOrdersG").datagrid("selectRecord",r.id)}),$("#divEvents").on("porderspopup",function(e,r){"new"==r?doDlgPOrderNew(null):"clear"==r?$("#divPurchaseOrdersG").datagrid("clearSelections"):"remove"==r?doGridGetSelectedRowData("divPurchaseOrdersG",function(r){doPromptOkCancel("Remove purchase order "+r.porderno+"?",function(e){e&&primus.emit("expireporder",{fguid:fguid,uuid:uuid,session:session,porderid:r.id,pdata:{type:"refresh"}})})})||noty({text:"Please select a purchase order to remove",type:"error",timeout:4e3}):"print"==r||("email"==r?doGridGetSelectedRowData("divPurchaseOrdersG",function(e){})||noty({text:"Please select a purchase order to email",type:"error",timeout:4e3}):"duplicate"==r?doGridGetSelectedRowData("divPurchaseOrdersG",function(r){doPromptOkCancel("Duplicate purchase order "+r.porderno+"?",function(e){e&&primus.emit("duplicateporder",{fguid:fguid,uuid:uuid,session:session,porderid:r.id,pdata:{type:"refresh"}})})})||noty({text:"Please select a purchase order to duplicate",type:"error",timeout:4e3}):"search"==r?doDlgPOrderSearch():"pay"==r&&(doGridGetSelectedRowData("divPurchaseOrdersG",function(e){doDlgPayPOrders(e.clientid)})||doDlgPayPOrders()))}),!isadmin&&myperms.cancreateorders,porderInvoiceToStates=doGetStatesFromCountry(defaultCountry),$("#divPurchaseOrdersG").datagrid({idField:"id",fitColumns:!1,singleSelect:!0,rownumbers:!0,striped:!0,toolbar:"#tbPOrders",showFooter:!0,sortName:"porderno",sortOrder:"asc",remoteSort:!1,multiSort:!0,loader:function(e,r,t){var d=_.toBigNum(0),i=_.toBigNum(0);cache_porders.forEach(function(e){_.isBlank(e.totalprice)||(d=d.plus(e.totalprice)),_.isBlank(e.totalqty)||(i=i.plus(e.totalqty))}),r({total:cache_porders.length,rows:cache_porders}),$(this).datagrid("reloadFooter",[{porderno:'<span class="totals_footer">'+cache_porders.length+" P.O.(s)</span>",totalprice:'<span class="totals_footer">'+_.niceformatnumber(d)+"</span>",totalqty:'<span class="totals_footer">'+_.niceformatnumber(i)+"</span>"}])},frozenColumns:[[{title:"P.O. #",field:"porderno",width:150,align:"left",resizable:!0,sortable:!0}]],columns:[[{title:"Name",field:"name",width:300,align:"left",resizable:!0,editor:"text",sortable:!0},{title:"Supplier",field:"clientid",width:300,align:"left",resizable:!0,editor:{type:"combotree",options:{valueField:"id",textField:"name",data:cache_suppliers,onSelect:function(e){var r;r=e,doGridGetSelectedRowData("divPurchaseOrdersG",function(e){_.isBlank(e.name)&&doGridGetEditor("divPurchaseOrdersG",editingIndex,"name",function(e){$(e.target).val(r.name)})})}}},formatter:function(e,r){return doGetNameFromTreeArray(cache_suppliers,e)},sortable:!0},{title:"Ref No.",field:"refno",width:120,align:"left",resizable:!0,editor:"text",sortable:!0},{title:"Invoice No.",field:"invoiceno",width:120,align:"left",resizable:!0,editor:"text",sortable:!0},{title:"Total",field:"totalprice",width:150,align:"right",resizable:!0,formatter:function(e,r,t){return _.isUndefined(r.id)?e:_.niceformatnumber(e)}},{title:"Qty",field:"totalqty",width:150,align:"right",resizable:!0,formatter:function(e,r,t){return _.isUndefined(r.id)?e:_.niceformatqty(e)}},{title:"Completed",field:"completed",width:150,align:"right",resizable:!0,sortable:!0},{title:"Balance",field:"balance",width:150,align:"right",resizable:!0,sortable:!0,styler:function(e,r,t){return"color: "+colour_indianred}},{title:"Modified",field:"date",width:150,align:"right",resizable:!0,sortable:!0},{title:"By",field:"by",width:200,align:"left",resizable:!0,sortable:!0}]],onRowContextMenu:function(e,r,t){doGridContextMenu("divPurchaseOrdersG","divPOrdersMenuPopup",e,r,t)},onBeginEdit:function(e){},onDblClickCell:function(e,r,t){doGetGridGetRowDataByIndex("divPurchaseOrdersG",e,function(e){doDlgPOrderNew(e.id)})}}))}