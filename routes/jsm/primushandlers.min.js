function addChannels(e){_.isArray(e)?e.forEach(function(e){-1==channels.indexOf(e)&&channels.push(e)}):-1==channels.indexOf(e)&&channels.push(e)}function doJoinChannels(){_.isUN(channels)||channels.forEach(function(e){primus.emit("join",{fguid:fguid,uuid:uuid,session:session,channel:e,pdata:"join"})})}function doPrimus(){try{function e(e,t){primus.on(e,function(e){doServerMessage(t,{type:"refresh"})})}function t(t,i){primus.on(t,function(e){_.isUN(i)?$("#divEvents").trigger(t,{data:e,pdata:$.extend(e.pdata,{})}):i(t,e)})}console.log("***** Init Primus..."),primus=new Primus(server,{reconnect:{maxDelay:15e3,minDelay:1e3,retries:1e3},strategy:["disconnect","timeout"]}),primus.on("error",function(e){$("#divDashConnectionStatus").html('<img style="vertical-align: middle;" src="data:image/png;base64,'+b64disconnected+'" width="24" height="24"/> Oops, server may be lost...'),connected=!1}),primus.on("open",function(){$("#divDashConnectionStatus").html(document.createTextNode("Connected to server...")),connected=!0,firstconnection&&(annyang&&(ispos||noty({text:'Your browser supports speech recognition - Click Allow Microphone Access..."',type:"success",timeout:5e3})),firstconnection=!1),doJoinChannels()}),primus.on("close",function(){$("#divDashConnectionStatus").html('<img style="vertical-align: middle;" src="data:image/png;base64,'+b64disconnected+'" width="24" height="24"/> OK, server has gone away, don\'t worry, will look for it shortly...'),console.log("***** Server has gone away...")}),primus.on("end",function(){console.log("***** Connection ended...")}),primus.on("reconnecting",function(e){var t=e.timeout/1e3;t=t.toFixed(0),$("#divDashConnectionStatus").html('<img style="vertical-align: middle;" src="data:image/png;base64,'+b64searching+'" width="24" height="24"/> Sending search party for server in '+t+"s, retry "+e.attempt+" of "+e.retries),console.log("***** Reconecting in "+t+"s")}),primus.on("reconnect",function(){$("#divDashConnectionStatus").html('<img style="vertical-align: middle;" src="data:image/png;base64,'+b64gears+'" width="24" height="24"/> Looking for server now...'),console.log("***** Looking for server...")}),primus.on("welcome",function(e){fguid=e.fguid,console.log("***** Server welcome..."),addChannels(e.channel),showIdle(),$("#divEvents").trigger("poswelcome",{pdata:"none"})}),primus.on("join",function(e){}),primus.on("login",function(e){if(console.log("***** Login successful..."),uid=e.uid,uname=e.uname,uuid=e.uuid,isadmin=e.isadmin,isclient=e.isclient,clientid=e.clientid,avatar=e.avatar,myperms=e.permissions,session=e.session,isclient)noty({text:"Access denied... please use client login",type:"error"});else{addChannels(e.channels),doJoinChannels();var t=mapAvatarToImage(avatar);if(_.isBlank(t)?$("#spnMenu").html("Logged in as <strong>"+_.titleize(uname)+"</strong>"):$("#spnMenu").html('<table><tr><td valign="middle">'+t+'</td><td valign="middle">Logged in as <strong>'+_.titleize(uname)+"</strong></td></tr></table>"),$("#spnServer").text(server),$("#dlgLogin").dialog("close"),ispos)$("#divEvents").trigger("posready",{pdata:"none"});else{if($("#divEvents").trigger("refresh-all",{pdata:"none"}),console.log("***** Determining permissions..."),posonly)$("#as1tabs").tabs("close","Command TAB"),$("#as1tabs").tabs("close","Dashboard"),$("#as1tabs").tabs("close","Purchasing"),$("#as1tabs").tabs("close","Job Sheets"),$("#as1tabs").tabs("close","Payroll"),$("#as1tabs").tabs("close","Accounts"),$("#dashtabs").tabs("close","Alerts"),$("#dashtabs").tabs("close","Chat Support"),$("#dashtabs").tabs("close","Order Cards"),$("#salestabs").tabs("close","Invoices"),$("#inventorytabs").tabs("close","Build Templates"),$("#inventorytabs").tabs("close","Builds"),$("#maintenancetabs").tabs("close","Status Alerts"),$("#maintenancetabs").tabs("close","Permission Templates"),$("#maintenancetabs").tabs("close","Product Templates"),$("#maintenancetabs").tabs("close","Print Templates"),$("#maintenancetabs").tabs("close","Emails"),isadmin||(myperms.canviewinventory||$("#as1tabs").tabs("close","Inventory"),$("#as1tabs").tabs("close","Maintenance"),$("#salestabs").tabs("close","Clients"));else if(isadmin){for(var i in $("#bankingtabs").tabs("disableTab","Receipts"),$("#bankingtabs").tabs("disableTab","Receipts"),$("#payrolltabs").tabs("disableTab","Process"),$("#payrolltabs").tabs("disableTab","Rosters"),myperms)myperms.hasOwnProperty(i)&&(myperms[i]=1);cmdcentre=new Treant([cmdcentreConfig,noderoot,nodesales,nodejobsheets,nodeinventory,nodeaccounts,nodepayroll])}else{console.log(myperms),myperms.canviewalerts||($("#dashtabs").tabs("close","Alerts"),$("#maintenancetabs").tabs("close","Status Alerts")),myperms.canviewcodes||$("#as1tabs").tabs("close","Accounts"),myperms.canvieworders||($("#dashtabs").tabs("close","Order Cards"),$("#salestabs").tabs("close","Orders")),myperms.cancreateorders||($("#tbOrdersNew").hide(),$("#tbOrdersRemove").hide(),$("#tbOrdersDuplicate").hide(),$("#tbOrdersDeposit").hide(),$("#tbOrdersInvoice").hide(),$("#tbOrderNewNew").hide(),$("#tbOrderNewEdit").hide(),$("#tbOrderNewCancel").hide(),$("#tbOrderNewSave").hide(),$("#tbOrderNewRemove").hide(),$("#tbOrderNoteNew").hide(),$("#tbOrderNoteEdit").hide(),$("#tbOrderNoteCancel").hide(),$("#tbOrderNoteSave").hide(),$("#tbOrderNoteRemove").hide(),$("#tbOrderAttachmentEdit").hide(),$("#tbOrderAttachmentCancel").hide(),$("#tbOrderAttachmentSave").hide(),$("#tbOrderAttachmentRemove").hide()),myperms.canviewinvoices||$("#salestabs").tabs("close","Invoices"),myperms.canviewclients||($("#salestabs").tabs("close","Clients"),$("#salestabs").tabs("close","Suppliers")),myperms.canviewpurchasing||$("#as1tabs").tabs("close","Purchasing"),myperms.canviewinventory||($("#inventorytabs").tabs("close","Locations"),$("#inventorytabs").tabs("close","Stock")),myperms.canviewproducts||($("#inventorytabs").tabs("close","Products"),$("#inventorytabs").tabs("close","Categories")),myperms.canviewbuilds||$("#inventorytabs").tabs("close","Build Templates"),myperms.canviewbanking||$("#as1tabs").tabs("close","Banking"),myperms.canviewpayroll||$("#as1tabs").tabs("close","Payroll"),myperms.canviewusers||$("#maintenancetabs").tabs("close","Users"),myperms.canviewtemplates||($("#maintenancetabs").tabs("close","Permission Templates"),$("#maintenancetabs").tabs("close","Product Templates"),$("#maintenancetabs").tabs("close","Print Templates"));var a=[cmdcentreConfig,noderoot];myperms.canviewclients||nodesales.children[0].children[0].children.splice(0,1),myperms.canviewinvoices||nodesales.children[0].children.splice(0,1),myperms.canvieworders&&a.push(nodesales),myperms.canviewbuilds||nodeinventory.children.splice(1,1),myperms.canviewproducts||nodeinventory.children[0].children.splice(0,1),myperms.canviewinventory&&(a.push(nodejobsheets),a.push(nodeinventory)),myperms.canviewcodesl&&a.push(nodeaccounts),myperms.canviewpayroll&&a.push(nodepayroll),myperms.canviewusers||myperms.canviewtemplates?($("#maintenancetabs").tabs("close","Status Alerts"),$("#maintenancetabs").tabs("close","Permission Templates"),$("#maintenancetabs").tabs("close","Product Templates"),$("#maintenancetabs").tabs("close","Print Templates"),$("#maintenancetabs").tabs("close","Emails"),$("#maintenancetabs").tabs("close","Settings")):$("#as1tabs").tabs("close","Maintenance"),ispos||(cmdcentre=new Treant(a))}doWidgetListeners()}}}),primus.on("changepassword",function(e){$("#divEvents").trigger("changepassword",{data:e,pdata:$.extend(e.pdata,{})})}),primus.on("listaccounts",function(e){doUpdateInitTasksProgress(),_.isUN(e.rs)||(cache_accounts=[],e.rs.forEach(function(e){var t=doNiceTitleizeString(e.name),i={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceTitleizeString(e.parentname),code:doNiceString(e.code),name:t,altcode:doNiceString(e.altcode),altname:doNiceTitleizeString(e.altname),text:t,type:e.itype,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_accounts.push(i);else{var a=doFindParentNode(cache_accounts,e.parentid);_.isUN(a)||a.children.push(i)}}),$("#divEvents").trigger("listaccounts",{data:e,pdata:$.extend(e.pdata,{})}))}),t("loadaccount"),t("newaccount"),t("saveaccount"),t("changeaccountparent"),t("expireaccount"),t("checkaccountcode"),t("listjournals"),t("newjournal"),t("testjournal"),primus.on("listexchangerates",function(e){doUpdateInitTasksProgress(),_.isUN(e.rs)||(cache_exchangerates=[],e.rs.forEach(function(e){cache_exchangerates.push({id:doNiceId(e.id),provider:doNiceString(e.provider),name:doNiceString(e.name),currency:doNiceString(e.currency),rate:_.formatnumber(e.rate,4),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger("listexchangerates",{data:e,pdata:$.extend(e.pdata,{})}))}),t("newexchangerate"),t("saveexchangerate"),t("expireexchangerate"),t("latestrates"),t("loadtaxcode"),t("newtaxcode"),t("savetaxcode"),t("expiretaxcode"),t("checktaxcode"),t("listtaxcodes",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_taxcodes=[],t.rs.forEach(function(e){cache_taxcodes.push({id:doNiceId(e.id),code:doNiceString(e.code),name:doNiceString(e.name),percent:_.formatnumber(e.percent,4),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("loadlocation"),t("newlocation"),t("savelocation"),t("changelocationparent"),t("expirelocation"),t("checklocationcode"),t("listlocations",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_locations=[],t.rs.forEach(function(e){var t=doNiceString(e.name),i={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceId(e.parentname),code:doNiceString(e.code),name:t,text:t,address1:doNiceString(e.address1),address2:doNiceString(e.address2),city:doNiceString(e.city),statename:doNiceString(e.state),postcode:doNiceString(e.postcode),country:_.isBlank(e.country)?defaultCountry:doNiceString(e.country),gpslat:_.formatnumber(e.gpslat,4),gpslon:_.formatnumber(e.gpslon,4),attrib1:doNiceString(e.attrib1),attrib2:doNiceString(e.attrib2),attrib3:doNiceString(e.attrib3),attrib4:doNiceString(e.attrib4),attrib5:doNiceString(e.attrib5),bay:doNiceString(e.bay),level:doNiceString(e.level),shelf:doNiceString(e.shelf),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_locations.push(i);else{var a=doFindParentNode(cache_locations,e.parentid);_.isUN(a)||a.children.push(i)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("loadclient"),t("newclient"),t("saveclient"),t("changeclientparent"),t("expireclient"),t("checkclientcode"),t("listemails"),t("listclients",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_clients=[],t.rs.forEach(function(e){var t=doNiceString(e.name),i={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceString(e.parentname),code:doNiceString(e.code),name:t,text:t,isactive:e.isactive,issupplier:e.issupplier,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_clients.push(i);else{var a=doFindParentNode(cache_clients,e.parentid);_.isUN(a)||a.children.push(i)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listclientnotes"),t("newclientnote"),t("saveclientnote"),t("expireclientnote"),t("searchclientnote"),t("listclientattachments"),t("saveclientattachment"),t("expireclientattachment"),t("loadsupplier"),t("newsupplier"),t("savesupplier"),t("changesupplierparent"),t("expiresupplier"),t("checksuppliercode"),t("listsuppliers",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_suppliers=[],t.rs.forEach(function(e){var t=doNiceString(e.name),i={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceString(e.parentname),code:doNiceString(e.code),name:t,text:t,isactive:e.isactive,isclient:e.isclient,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_suppliers.push(i);else{var a=doFindParentNode(cache_suppliers,e.parentid);_.isUN(a)||a.children.push(i)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listsuppliernotes"),t("newsuppliernote"),t("savesuppliernote"),t("listsupplierattachments"),t("savesupplierattachment"),t("expiresupplierattachment"),t("loademployee"),t("newemployee"),t("saveemployee"),t("changeemployeeparent"),t("expireemployee"),t("checkemployeecode"),t("listemployees",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_employees=[],t.rs.forEach(function(e){var t={id:doNiceId(e.id),parentid:doNiceId(e.parentid),code:doNiceString(e.code),altcode:doNiceString(e.altcode),lastname:doNiceTitleizeString(e.lastname),firstname:doNiceTitleizeString(e.firstname),text:doNiceTitleizeString(e.firstname+" "+e.lastname),email1:doNiceString(e.email1),phone1:doNiceString(e.phone1),gender:"F"==e.gender?1:0,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_employees.push(t);else{var i=doFindParentNode(cache_employees,e.parentid);_.isUN(i)||i.children.push(t)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listpayrollemployees",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_employees=[],t.rs.forEach(function(e){cache_employees.push({id:doNiceId(e.id),parentid:doNiceId(e.parentid),code:doNiceString(e.code),name:doNiceString(e.name),employmenttype:_.formatinteger(e.employmenttype),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("loaduser"),t("newuser"),t("saveuser"),t("expireuser"),t("checkuseruid"),t("changepassword"),t("listconnectedusers"),t("saveuserpermissions"),t("listusers",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_users=[],t.rs.forEach(function(e){var t=e.uuid==uuid?mapUserStatusToImage("online"):mapUserStatusToImage("unknown");cache_users.push({uuid:doNiceString(e.uuid),name:doNiceString(e.uname),username:doNiceString(e.uid),email:doNiceString(e.email),phone:doNiceString(e.phone),isadmin:e.isadmin,isclient:e.isclient,avatar:doNiceString(e.avatar),canvieworders:e.canvieworders,cancreateorders:e.cancreateorders,canviewinvoices:e.canviewinvoices,cancreateinvoices:e.cancreateinvoices,canviewinventory:e.canviewinventory,cancreateinventory:e.cancreateinventory,canviewpayroll:e.canviewpayroll,cancreatepayroll:e.cancreatepayroll,canviewproducts:e.canviewproducts,cancreateproducts:e.cancreateproducts,canviewclients:e.canviewclients,cancreateclients:e.cancreateclients,canviewcodes:e.canviewcodes,cancreatecodes:e.cancreatecodes,canviewusers:e.canviewusers,cancreateusers:e.cancreateusers,canviewbuilds:e.canviewbuilds,cancreatebuilds:e.cancreatebuilds,canviewtemplates:e.canviewtemplates,cancreatetemplates:e.cancreatetemplates,canviewbanking:e.canviewbanking,cancreatebanking:e.cancreatebanking,canviewpurchasing:e.canviewpurchasing,cancreatepurchasing:e.cancreatepurchasing,canviewalerts:e.canviewalerts,cancreatealerts:e.cancreatealerts,canviewdashboard:e.canviewdashboard,cancreatedashboard:e.cancreatedashboard,lastlogin:e.lastlogindate,lastlogout:e.lastlogoutdate,lastip:e.lastloginip,clientid:e.clientid,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),status:t})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("newsuperfund"),t("savesuperfund"),t("expiresuperfund"),t("checksuperfundname"),t("listsuperfunds",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_superfunds=[],t.rs.forEach(function(e){cache_superfunds.push({id:doNiceId(e.id),name:doNiceString(e.name),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listinvoices"),t("listunpaidordersbyclient"),t("listunpaidpordersbyclient"),t("payinvoices"),t("paypurchaseorders"),t("emailorder"),t("emailinvoice"),t("searchinvoices"),t("printinvoices",function(e,t){_.isUN(t.rs)||(t.rs.forEach(function(e){var t="/di?no="+e.invoiceno+"&fguid="+fguid,i=window.open(t,"_blank");i&&i.print(),doShowSuccess("Invoice ["+e.invoiceno+"] has been downloaded")}),primus.emit("listinvoices",{fguid:fguid,uuid:uuid,session:session,pdata:$.extend(t.pdata,{})}))}),t("printorders",function(e,t){_.isUN(t.rs)||t.rs.forEach(function(e){var t="/do?no="+e.orderno+"&fguid="+fguid,i=window.open(t,"_blank");i&&i.print()})}),t("printdeliverydockets",function(e,t){_.isUN(t.rs)||t.rs.forEach(function(e){var t="/do?filename="+e,i=window.open(t,"_blank");i&&i.print()})}),t("printquotes",function(e,t){_.isUN(t.rs)||t.rs.forEach(function(e){var t="/do?filename="+e,i=window.open(t,"_blank");i&&i.print()})}),t("saveconfig"),t("loademailtemplates"),t("saveemailtemplates"),t("saveprinttemplate"),t("expireprinttemplate"),t("loadconfig",function(e,t){if(doUpdateInitTasksProgress(),!_.isUN(t.rs)&&1==t.rs.length){var i=t.rs[0];cache_config={statusid:i.statusid,inventoryadjustaccountid:i.inventoryadjustaccountid,currentquoteno:i.currentquoteno,currentorderno:i.currentorderno,currentporderno:i.currentporderno,currentinvoiceno:i.currentinvoiceno,currentjournalno:i.currentjournalno,currentclientno:i.currentclientno,currentsupplierno:i.currentsupplierno,currentempno:i.currentempno,currentjobsheetno:i.currentjobsheetno,currentbarcodeno:i.currentbarcodeno,orderasquote:doNiceIntToBool(i.orderasquote),inventoryusefifo:doNiceIntToBool(i.inventoryusefifo),defaultinventorylocationid:i.defaultinventorylocationid,gstpaidaccountid:i.gstpaidaccountid,gstcollectedaccountid:i.gstcollectedaccountid,invoiceprinttemplateid:i.invoiceprinttemplateid,orderprinttemplateid:i.orderprinttemplateid,quoteprinttemplateid:i.quoteprinttemplateid,deliverydocketprinttemplateid:i.deliverydocketprinttemplateid,araccountid:i.araccountid,apaccountid:i.apaccountid,productcostofgoodsaccountid:i.productcostofgoodsaccountid,productincomeaccountid:i.productincomeaccountid,productassetaccountid:i.productassetaccountid,productbuytaxcodeid:i.productbuytaxcodeid,productselltaxcodeid:i.productselltaxcodeid,fyearstart:i.fyearstart,fyearend:i.fyearend,companyname:i.companyname,address1:i.address1,address2:i.address2,address3:i.address3,address4:i.address4,city:i.city,state:i.state,postcode:i.postcode,country:i.country,bankname:i.bankname,bankbsb:i.bankbsb,bankaccountno:i.bankaccountno,bankaccountname:i.bankaccountname,expressfee:_.sanitiseAsNumeric(i.expressfee,2),autosyncbuildtemplates:i.autosyncbuildtemplates,attrib1name:i.attrib1name,attrib2name:i.attrib2name,attrib3name:i.attrib3name,attrib4name:i.attrib4name,attrib5name:i.attrib5name,posclientid:i.posclientid,date:doNiceDateModifiedOrCreated(i.datemodified,i.datecreated),by:doNiceModifiedBy(i.datemodified,i.usermodified,i.usercreated)},doCustomAttributeLabelName(1,cache_config.attrib1name),doCustomAttributeLabelName(2,cache_config.attrib2name),doCustomAttributeLabelName(3,cache_config.attrib3name),doCustomAttributeLabelName(4,cache_config.attrib4name),doCustomAttributeLabelName(5,cache_config.attrib5name),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})})}}),t("listprinttemplates",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_printtemplates=[],t.rs.forEach(function(e){cache_printtemplates.push({id:doNiceId(e.id),name:doNiceString(e.name),description:doNiceString(e.description),mimetype:'<a href="javascript:void(0);" onClick="doThrowPrintTemplate('+e.id+');">'+mapMimeTypeToImage(e.mimetype)+"</a>",size:doNiceString(e.size),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("loadproductcategory"),t("newproductcategory"),t("saveproductcategory"),t("changeproductcategoryparent"),t("expireproductcategory"),t("checkproductcategorycode"),t("listproductcategories",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_productcategories=[],t.rs.forEach(function(e){var t=doNiceTitleizeString(e.name),i={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceId(e.parentname),code:doNiceString(e.code),name:t,text:t,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_productcategories.push(i);else{var a=doFindParentNode(cache_productcategories,e.parentid);_.isUN(a)||a.children.push(i)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listproducts",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_products=[],t.rs.forEach(function(e){cache_products.push({id:doNiceId(e.id),productcategoryid:doNiceId(e.productcategoryid),productcategoryname:doNiceString(e.productcategoryname),name:doNiceString(e.name),code:doNiceString(e.code),altcode:doNiceString(e.altcode),barcode:doNiceString(e.barcode),costprice:_.formatnumber(e.costprice,4),costgst:_.formatnumber(e.costgst,4),sellprice:_.formatnumber(e.sellprice,4),sellgst:_.formatnumber(e.sellgst,4),buytaxcodeid:doNiceId(e.buytaxcodeid),selltaxcodeid:doNiceId(e.selltaxcodeid),costofgoodsaccountid:doNiceId(e.costofgoodsaccountid),incomeaccountid:doNiceId(e.incomeaccountid),assetaccountid:doNiceId(e.assetaccountid),uom:doNiceString(e.uom).toUpperCase(),uomsize:_.formatnumber(e.uomsize,4),buildtemplateid:doNiceId(e.buildtemplateid),minstock:_.formatnumber(e.minstockqty,4),stockwarn:_.formatnumber(e.stockqtywarnthreshold,4),width:_.formatnumber(e.width,4),length:_.formatnumber(e.length,4),height:_.formatnumber(e.height,4),weight:_.formatnumber(e.weight,4),attrib1:doNiceString(e.attrib1),attrib2:doNiceString(e.attrib2),attrib3:doNiceString(e.attrib3),attrib4:doNiceString(e.attrib4),attrib5:doNiceString(e.attrib5),isactive:e.isactive,clientid:doNiceId(e.clientid),productaliasid:doNiceId(e.productaliasid),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listproductsbycategory",function(e,t){_.isUN(t.rs)||(cache_productsbycategory=[],t.rs.forEach(function(e){cache_productsbycategory.push({id:doNiceId(e.id),productcategoryid:doNiceId(e.productcategoryid),name:doNiceString(e.name),code:doNiceString(e.code),altcode:doNiceString(e.altcode),barcode:doNiceString(e.barcode),costprice:_.formatnumber(e.costprice,4),costgst:_.formatnumber(e.costgst,4),sellprice:_.formatnumber(e.sellprice,4),sellgst:_.formatnumber(e.sellgst,4),buytaxcodeid:doNiceId(e.buytaxcodeid),selltaxcodeid:doNiceId(e.selltaxcodeid),costofgoodsaccountid:doNiceId(e.costofgoodsaccountid),incomeaccountid:doNiceId(e.incomeaccountid),assetaccountid:doNiceId(e.assetaccountid),uom:doNiceString(e.uom).toUpperCase(),uomsize:_.formatnumber(e.uomsize,4),buildtemplateid:doNiceId(e.buildtemplateid),minstock:_.formatnumber(e.minstockqty,4),stockwarn:_.formatnumber(e.stockqtywarnthreshold,4),width:_.formatnumber(e.width,4),length:_.formatnumber(e.length,4),height:_.formatnumber(e.height,4),weight:_.formatnumber(e.weight,4),attrib1:doNiceString(e.attrib1),attrib2:doNiceString(e.attrib2),attrib3:doNiceString(e.attrib3),attrib4:doNiceString(e.attrib4),attrib5:doNiceString(e.attrib5),inventoryqty:_.formatnumber(e.inventoryqty,4),orderqty:_.formatnumber(e.orderqty,4),isactive:e.isactive,clientid:e.clientid,date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("loadproduct"),t("newproduct"),t("saveproduct"),t("changeproductparent"),t("expireproduct"),t("duplicateproduct"),t("checkproductcode"),t("productsearch"),t("changeproductcategory"),t("newproductcode"),t("listproductcodes"),t("expireproductcode"),t("listproductpricing"),t("productpricingupdated"),t("productpricingupdated"),t("listproductcodes"),t("expireproductpricing"),t("getproductprices"),t("getprice"),t("newbuildtemplate"),t("savebuildtemplate"),t("checkbuildtemplatecode"),t("changebuildtemplateparent"),t("loadproductcategory"),t("duplicatebuildtemplate"),t("expirebuildtemplate"),t("syncbuildtemplatestomaster"),t("buildtemplatesearch"),t("listbuildtemplates",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_buildtemplates=[],t.rs.forEach(function(e){var t=doNiceString(e.name),i={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceString(e.parentname),producttemplateheaderid:doNiceId(e.producttemplateheaderid),numproducts:0==e.numproducts?"":e.numproducts,totalprice:_.formatnumber(e.totalprice,4),totalgst:_.formatnumber(e.totalgst,4),clientid:doNiceId(e.clientid),taxcodeid:doNiceId(e.taxcodeid),code:doNiceString(e.code),name:t,text:t,price:_.formatnumber(e.price,4),gst:_.formatnumber(e.gst,4),qty:_.formatnumber(e.qty,4),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_buildtemplates.push(i);else{var a=doFindParentNode(cache_buildtemplates,e.parentid);_.isUN(a)||a.children.push(i)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("buildtemplategetchildren",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(t.rs.forEach(function(e){var t=doNiceString(e.name),i={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceString(e.parentname),producttemplateheaderid:doNiceId(e.producttemplateheaderid),numproducts:0==e.numproducts?"":e.numproducts,totalprice:_.formatnumber(e.totalprice,4),totalgst:_.formatnumber(e.totalgst,4),clientid:doNiceId(e.clientid),taxcodeid:doNiceId(e.taxcodeid),code:doNiceString(e.code),name:t,text:t,price:_.formatnumber(e.price,4),gst:_.formatnumber(e.gst,4),qty:_.formatnumber(e.qty,4),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_buildtemplates.push(i);else{var a=doFindParentNode(cache_buildtemplates,e.parentid);_.isUN(a)||a.children.push(i)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listproductsbybuildtemplate"),t("newbuildtemplatedetail"),t("savebuildtemplatedetail"),t("expirebuildtemplatedetail"),t("newproducttemplate"),t("saveproducttemplate"),t("changeproducttemplateparent"),t("expireproducttemplate"),t("duplicateproducttemplate"),t("buildproducttemplate"),t("listproducttemplates",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_producttemplates=[],t.rs.forEach(function(e){var t={id:doNiceId(e.id),parentid:doNiceId(e.parentid),parentname:doNiceString(e.parentname),numproducts:0==e.numproducts?"":e.numproducts,totalprice:_.formatnumber(e.totalprice,4),totalgst:_.formatnumber(e.totalgst,4),clientid:doNiceId(e.clientid),taxcodeid:doNiceId(e.taxcodeid),name:doNiceString(e.name),code:doNiceString(e.code),price:_.formatnumber(e.price,4),gst:_.formatnumber(e.gst,4),qty:_.formatnumber(e.qty,4),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated),children:[]};if(_.isUN(e.parentid))cache_producttemplates.push(t);else{var i=doFindParentNode(cache_producttemplates,e.parentid);_.isUN(i)||i.children.push(t)}}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listproductsbytemplate"),t("listproductsforbuild"),t("newproducttemplatedetail"),t("saveproducttemplatedetail"),t("expireproducttemplatedetail"),t("syncproducttemplate"),t("newpermissiontemplate"),t("savepermissiontemplate"),t("loadpermissiontemplate"),t("expirepermissiontemplate"),t("listpermissiontemplates",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_permissiontemplates=[],t.rs.forEach(function(e){var t={id:doNiceId(e.id),name:doNiceString(e.name)};cache_permissiontemplates.push(t)}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("liststock"),t("addinventory"),t("buildinventory"),t("saveinventory"),t("transferinventory"),t("inventoryjournal",function(e,t){_.isUN(t.rs)||(cache_invstock=[],t.rs.forEach(function(e){cache_invstock.push({id:e.id,locationid:doNiceId(e.locationid),locationname:doNiceString(e.locationname),productid:doNiceString(e.productid),productcode:doNiceString(e.productcode),productname:doNiceString(e.productname),costprice:_.formatnumber(e.costprice,4),qty:_.formatnumber(e.qty,4),type:doGetStringFromIdInObjArray(inventorytypes,e.type),batchno:doNiceString(e.batchno),dateexpiry:doNiceDate(e.dateexpiry),dateproduction:doNiceDate(e.dateproduction),comments:doNiceString(e.comments),created:doNiceDate(e.datecreated),by:doNiceTitleizeString(e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("getinventoryproducttotals",function(e,t){if(!_.isUN(t.total)){var i=doGetDropDownListValue("fldInventoryProduct");_.isUN(i)||t.total.productid!=i||$("#spnInventoryQty").html("<strong>Total</strong> in inventory: "+_.formatnumber(t.total.qty,4))}}),t("getinventoryproductlocationtotals",function(e,t){if(!_.isUN(t.rs)){var i="",a='<table border="0" cellpadding="2" style="color: #888; font-style: italic; font-size: small">';t.rs.forEach(function(e){i=_.isUN(e.locationid)?"":e.locationname,a+='<tr><td align="left">'+i+':</td><td align="right">'+_.formatnumber(e.qty,4)+"</td></tr>"}),a+="</table>",$("#spnInventoryLocationQty").html(a)}}),t("listbuilds"),t("expirebuild"),t("listorderbuilds"),t("liststatusalerts"),t("loadstatusalert"),t("newstatusalert"),t("savestatusalert"),t("expirestatusalert"),t("loadporder"),t("newporder"),t("saveporder"),t("completeporder"),t("listporders",function(e,t){doUpdateInitTasksProgress(),_.isUN(t.rs)||(cache_porders=[],t.rs.forEach(function(e){cache_porders.push({id:doNiceId(e.id),clientid:doNiceId(e.clientid),porderno:doNiceString(e.porderno),name:doNiceString(e.name),invoiceno:doNiceString(e.invoiceno),refno:doNiceString(e.refno),totalprice:_.sanitiseAsNumeric(e.totalprice,4),totalqty:_.sanitiseAsNumeric(e.totalqty,4),inventorycommitted:e.inventorycommitted,completed:doNiceDate(e.datecompleted),completedby:doNiceTitleizeString(e.usercompleted),paid:_.formatnumber(e.paid,2),balance:_.formatnumber(e.balance,2),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("listporderdetails"),t("listorders"),t("loadorder"),t("neworder"),t("saveorder"),t("expireorder"),t("checkorderpo"),t("duplicateorder"),t("newversionorder"),t("createinvoicefromorder"),t("listorderattachments"),t("saveorderattachment"),t("expireorderattachment"),t("getorderthumbnail"),t("listordernotes"),t("newordernote"),t("saveordernote"),t("expireordernote"),t("searchordernote"),t("listorderstatuses"),t("neworderstatus"),t("listquotes"),t("duplicatequote"),t("tpccaddstatus"),t("tpccbuild"),t("tpccorderbuilds"),t("tpccloadjobsheet"),t("tpcclistjobsheetdetails"),t("tpccsavejobsheet"),t("tpccjobsheetimagecreated"),t("tpccjobsheetdetailadded"),t("tpccproductcategoryfrombuildtemplate"),t("tpcccreateproductfrombuildtemplate"),t("tpccprintjobsheet",function(e,t){if(!_.isUN(t.jobsheetno)){var i="/js?no="+t.jobsheetno+"&fguid="+fguid,a=window.open(i,"_blank");a&&a.print()}}),t("neworderdetail"),t("saveorderdetail"),t("expireorderdetail"),t("listorderdetails",function(e,t){_.isUN(t.rs)||(cache_orderproducts=[],t.rs.forEach(function(e){cache_orderproducts.push({id:doNiceId(e.id),productid:doNiceId(e.productid),name:doNiceString(e.productname),price:_.sanitiseAsNumeric(e.price),qty:_.niceformatqty(e.qty),discount:_.niceformatqty(e.discount,2),expressfee:_.niceformatqty(e.expressfee,2),taxcodeid:doNiceId(e.taxcodeid),isrepeat:doNiceIntToBool(e.isrepeat),date:doNiceDateModifiedOrCreated(e.datemodified,e.datecreated),by:doNiceModifiedBy(e.datemodified,e.usermodified,e.usercreated)})}),$("#divEvents").trigger(e,{data:t,pdata:$.extend(t.pdata,{})}))}),t("abnlookup"),t("posgetproduct"),t("posgenbarcode"),t("poscashsale"),t("poscreditsale"),t("possplitsale"),t("possearchsale"),t("posloadsale"),t("posnewcust"),t("possalestotal"),t("lastuserpoll"),t("listchatsforme"),t("listalertsforme"),t("chatmsg"),t("emailhistory"),t("report"),t("eventerror",function(e,t){if(showIdle(),!_.isUN(t.rc)&&!_.isUN(t.msg))switch(parseInt(t.rc)){case errcode_nodata:noty({text:"No data or no matching data",type:"information",timeout:4e3});break;case errcode_notloggedin:break;case errcode_usernotregistered:case errcode_invalidlogin:noty({text:"Login failed, please try again",type:"error",timeout:4e3,force:!0,killer:!0}),$("#fldUid").focus();break;default:noty({text:"Error "+t.rc+": "+t.msg,type:"error",timeout:1e4})}}),e("accountcreated","listaccounts"),e("accountsaved","listaccounts"),e("accountparentchanged","listaccounts"),e("accountexpired","listaccounts"),e("journaladded","listjournals"),e("productcategorycreated","listproductcategories"),e("productcategorysaved","listproductcategories"),e("productcategoryparentchanged","listproductcategories"),e("productcategoryexpired","listproductcategories"),e("superfundcreated","listsuperfunds"),e("superfundsaved","listsuperfunds"),e("superfundexpired","listsuperfunds"),e("exchangeratecreated","listexchangerates"),e("exchangeratesaved","listexchangerates"),e("exchangerateexpired","listexchangerates"),e("taxcodecreated","listtaxcodes"),e("taxcodesaved","listtaxcodes"),e("taxcodeexpired","listtaxcodes"),t("locationcreated"),t("locationsaved"),t("locationparentchanged"),t("locationexpired"),t("clientcreated"),t("clientsaved"),t("clientparentchanged"),t("clientexpired"),t("clientnotecreated"),t("clientnotesaved"),t("clientnoteexpired"),t("clientattachmentcreated"),t("clientattachmentsaved"),t("clientattachmentexpired"),t("suppliercreated"),t("suppliersaved"),t("supplierparentchanged"),t("supplierexpired"),t("suppliernotecreated"),t("suppliernotesaved"),t("supplierattachmentcreated"),t("supplierattachmentsaved"),t("supplierattachmentexpired"),t("employeecreated"),t("employeesaved"),t("employeeexpired"),t("employeeparentchanged"),t("productcreated"),t("productsaved"),t("productparentchanged"),t("productexpired"),t("productcodecreated"),t("productcodeexpired"),t("productpricingcreated"),t("productpricingsaved"),t("productpricingexpired"),e("buildtemplatecreated","listbuildtemplates"),e("buildtemplatesaved","listbuildtemplates"),e("buildtemplateduplicated","listbuildtemplates"),e("buildtemplateexpired","listbuildtemplates"),e("buildtemplateparentchanged","listbuildtemplates"),e("buildtemplatesyncedtomaster","listbuildtemplates"),t("buildtemplatedetailcreated"),t("buildtemplatedetailsaved"),t("buildtemplateparentchanged"),t("buildtemplateduplicated"),t("buildtemplatedetailexpired"),e("permissiontemplatecreated","listpermissiontemplates"),e("permissiontemplatesaved","listpermissiontemplates"),e("permissiontemplateexpired","listpermissiontemplates"),e("permissiontemplateduplicated","listpermissiontemplates"),e("producttemplatecreated","listproducttemplates"),e("producttemplatesaved","listproducttemplates"),e("producttemplateparentchanged","listproducttemplates"),e("producttemplateexpired","listproducttemplates"),e("producttemplateduplicated","listproducttemplates"),t("producttemplatedetailcreated"),t("producttemplatedetailsaved"),t("producttemplatedetailexpired"),t("producttemplatesynced"),t("invoicecreated"),t("invoicespaid"),t("porderspaid"),t("pordercreated"),t("porderexpired"),t("pordercompleted"),t("ordercreated"),t("ordersaved"),t("orderexpired"),t("orderduplicated"),t("ordernewversion"),t("orderinvoicetosaved"),t("orderpaid"),t("orderstatuscreated"),t("orderstatusalert"),t("ordernotecreated"),t("ordernotesaved"),t("ordernoteexpired"),t("orderattachmentcreated"),t("orderattachmentsaved"),t("orderattachmentexpired"),t("orderdetailcreated"),t("orderdetailsaved"),t("orderdetailexpired"),t("inventoryadded"),t("inventorybuilt"),t("buildexpired"),t("statusalertcreated"),t("statusalertsaved"),t("statusalertexpired"),t("accountsimported",function(e,t){doShowSuccess("Imported account file: "+t.filename+", #Inserted: "+t.numinserted+", #Updated: "+t.numupdated+", #Skipped: "+t.numskipped),doServerMessage("listaccounts",{type:"refresh"})}),t("employeesimported",function(e,t){doShowSuccess("Imported employees file: "+t.filename+", #Inserted: "+t.numinserted+", #Updated: "+t.numupdated+", #Skipped: "+t.numskipped),doServerMessage("listemployees",{type:"refresh"})}),t("clientsimported",function(e,t){doShowSuccess("Imported clients file: "+t.filename+", #Inserted: "+t.numinserted+", #Updated: "+t.numupdated+", #Skipped: "+t.numskipped),doServerMessage("listclients",{type:"refresh"})}),t("suppliersimported",function(e,t){doShowSuccess("Imported suppliers file: "+t.filename+", #Inserted: "+t.numinserted+", #Updated: "+t.numupdated+", #Skipped: "+t.numskipped),doServerMessage("listsuppliers",{type:"refresh"})}),t("productsimported",function(e,t){doShowSuccess("Imported products file: "+t.filename+", #Inserted: "+t.numinserted+", #Updated: "+t.numupdated+", #Skipped: "+t.numskipped),doServerMessage("listproducts",{type:"refresh"})}),t("newrtap"),t("insertrtap"),t("rtapinserted"),t("listrtaps"),t("emailsent"),e("usercreated","listusers"),e("usersaved","listusers"),e("userexpired","listusers"),t("userpermissionssaved"),t("tpccjobsheetcreated"),t("tpccjobsheetexpired"),t("tpccjobsheetsaved"),t("configsaved"),t("printtemplatecreated"),t("printtemplatesaved"),t("printtemplateexpired"),t("poscustcreated"),t("emailfeedback"),t("newchatmsg"),t("useronline"),t("useroffline"),t("userlogout"),t("userpolled"),t("userpaused"),t("userweather"),t("newpoll"),console.log("***** Primus initialised...")}catch(e){console.log("****************** Primus exception: "+e)}}